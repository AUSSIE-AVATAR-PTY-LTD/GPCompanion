<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Aged Care Health Assessment</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f3f4f6; /* bg-gray-100 */
      }
      .chevron-icon {
        transition: transform 0.3s ease-in-out;
      }
      .chevron-icon.rotated {
        transform: rotate(180deg);
      }
      .form-section-content.collapsed {
        max-height: 0;
        padding-top: 0;
        padding-bottom: 0;
        opacity: 0;
        overflow: hidden;
        transition: max-height 0.5s ease-in-out, opacity 0.3s ease-in-out,
          padding 0.5s ease-in-out;
      }
      .form-section-content {
        transition: max-height 0.5s ease-in-out, opacity 0.3s ease-in-out;
        max-height: 8000px; /* A large value to allow for content */
        opacity: 1;
      }
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }
      .modal-content {
        background-color: white;
        padding: 2rem;
        border-radius: 0.75rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        width: 90%;
        max-width: 800px;
        max-height: 90vh;
        overflow-y: auto;
        position: relative;
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #e2e8f0;
      }
      .modal-close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #6b7280;
      }
      .details-container {
        padding-left: 1.85rem;
        margin-top: 0.5rem;
        margin-bottom: 0.75rem;
      }
      .subsection-title {
        font-weight: 600;
        margin-top: 1.25rem;
        margin-bottom: 0.75rem;
        color: #334155;
        font-size: 1.1rem;
        border-bottom: 1px solid #e2e8f0;
        padding-bottom: 0.5rem;
      }
      .score-display {
        font-size: 1.25rem;
        font-weight: 700;
        color: #166534;
        background-color: #f0fdf4;
        padding: 0.5rem 1rem;
        border-radius: 9999px;
      }
      .assessment-question {
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #e5e7eb;
      }
      .assessment-question:last-child {
        border-bottom: none;
      }
      .age-display-container {
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        height: 100%;
      }
      .age-display {
        padding: 0.75rem;
        background-color: #f1f5f9;
        border-radius: 0.375rem;
        text-align: center;
        font-weight: 500;
        min-height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .age-error {
        color: #dc2626;
        font-size: 0.8rem;
        text-align: center;
        margin-top: 0.25rem;
        min-height: 1.2rem;
      }
      .input-field {
        display: block;
        width: 100%;
        padding: 0.5rem 0.75rem;
        background-color: #f8fafc;
        border: 1px solid #cbd5e1;
        border-radius: 0.375rem;
        box-shadow: inset 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      }
      .question-block {
        margin-bottom: 1rem;
      }
      .task-group {
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1rem;
        background-color: #fdfdff;
      }
      .task-group h4 {
        font-weight: 600;
        margin-bottom: 0.75rem;
        color: #334155;
        border-bottom: 1px solid #e2e8f0;
        padding-bottom: 0.5rem;
      }
      .trail-making-node {
        cursor: pointer;
        transition: all 0.2s;
      }
      .trail-making-node:hover circle {
        fill: #dbeafe;
      }
      .trail-making-node.clicked circle {
        fill: #93c5fd;
        stroke: #2563eb;
      }
      .checkbox-label,
      .radio-label {
        display: flex;
        align-items: center;
        margin-bottom: 0.75rem;
        font-size: 0.95rem;
      }
      .checkbox-label input,
      .radio-label input {
        margin-right: 0.75rem;
        height: 1.1rem;
        width: 1.1rem;
        flex-shrink: 0;
      }
      .interpretation-box {
        font-size: 0.8rem;
        padding: 0.5rem;
        margin-top: 0.25rem;
        border-radius: 0.25rem;
        background-color: #fefce8; /* yellow-50 */
        color: #a16207; /* yellow-700 */
        border: 1px solid #fde047; /* yellow-400 */
      }
    </style>
  </head>
  <body class="text-gray-800">
    <nav
      class="bg-white border-b border-indigo-100 sticky top-0 z-50 shadow-sm"
    >
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-20">
          <!-- logo + title -->
          <a href="/" class="flex items-center space-x-3">
            <img
              src="/images/gp-companion-logo.png"
              alt="GP Companion Logo"
              width="80"
              height="80"
              class="w-20 h-20"
            />
            <span class="font-bold text-xl text-indigo-800">GP Companion</span>
          </a>

          <!-- desktop links -->
          <div id="desktopMenu" class="hidden md:flex items-center space-x-4">
            <a
              href="/"
              class="text-indigo-700 hover:text-indigo-900 transition-colors px-3 py-2 text-sm font-medium"
              >Home</a
            >
            <a
              href="/gpccmp"
              class="text-indigo-700 hover:text-indigo-900 transition-colors px-3 py-2 text-sm font-medium"
              >GPCCMP</a
            >
            <a
              href="/HealthAssessments"
              class="text-indigo-700 hover:text-indigo-900 transition-colors px-3 py-2 text-sm font-medium"
              >Assessments</a
            >
            <a
              href="/about"
              class="text-indigo-600 hover:text-indigo-800 transition-colors px-3 py-2 text-sm"
              >About</a
            >
            <a
              href="/developer"
              class="text-indigo-600 hover:text-indigo-800 transition-colors px-3 py-2 text-sm"
              >Developer</a
            >
            <a
              href="/privacy"
              class="text-indigo-600 hover:text-indigo-800 transition-colors px-3 py-2 text-sm"
              >Privacy</a
            >
            <a
              href="/contact"
              class="text-indigo-600 hover:text-indigo-800 transition-colors px-3 py-2 text-sm"
              >Contact</a
            >
          </div>

          <!-- mobile button -->
          <div class="md:hidden">
            <button
              id="mobileMenuButton"
              aria-expanded="false"
              aria-controls="mobileMenu"
              class="inline-flex items-center justify-center p-2 rounded-md text-indigo-700 hover:text-indigo-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
            >
              <span class="sr-only">Open menu</span>
              <!-- bars icon -->
              <svg
                id="menuOpenIcon"
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 6h16M4 12h16M4 18h16"
                />
              </svg>
              <!-- close icon (hidden by default) -->
              <svg
                id="menuCloseIcon"
                class="h-6 w-6 hidden"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>
        </div>
      </div>

      <!-- mobile menu (hidden by default) -->
      <div id="mobileMenu" class="md:hidden hidden border-t border-indigo-100">
        <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
          <a
            href="/"
            class="block px-3 py-2 rounded-md text-base font-medium text-indigo-700 hover:text-indigo-900"
            >Home</a
          >
          <a
            href="/gpccmp"
            class="block px-3 py-2 rounded-md text-base font-medium text-indigo-700 hover:text-indigo-900"
            >GPCCMP</a
          >
          <a
            href="/HealthAssessments"
            class="block px-3 py-2 rounded-md text-base font-medium text-indigo-700 hover:text-indigo-900"
            >Assessments</a
          >
          <a
            href="/about"
            class="block px-3 py-2 rounded-md text-base text-indigo-600 hover:text-indigo-800"
            >About</a
          >
          <a
            href="/developer"
            class="block px-3 py-2 rounded-md text-base text-indigo-600 hover:text-indigo-800"
            >Developer</a
          >
          <a
            href="/privacy"
            class="block px-3 py-2 rounded-md text-base text-indigo-600 hover:text-indigo-800"
            >Privacy</a
          >
          <a
            href="/contact"
            class="block px-3 py-2 rounded-md text-base text-indigo-600 hover:text-indigo-800"
            >Contact</a
          >
        </div>
      </div>
    </nav>
    <div class="container mx-auto p-4 sm:p-6 lg:p-8 mt-12">
      <header class="text-center mb-10">
        <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">
          Health assessment for permanent residents of residential aged care
          facilities
        </h1>
        <p class="text-md text-gray-600 mt-2">GP Health Assessment Tool</p>
        <p class="text-sm text-gray-700 mt-4 font-semibold">
          Developed by Dr Bobby Tork MD, FRACGP-RG
        </p>
        <p class="text-xs text-gray-500 mt-1">&copy; 2025 Dr Bobby Tork</p>
      </header>

      <div class="max-w-4xl mx-auto">
        <div id="form-container"></div>

        <div id="action-buttons" class="mt-8 flex justify-end space-x-4 hidden">
          <button
            id="clear-form-btn"
            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-gray-600 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500"
          >
            Clear Form
          </button>
          <button
            id="save-txt-btn"
            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
          >
            Save as .txt
          </button>
          <button
            id="save-rtf-btn"
            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
          >
            Save as .rtf
          </button>
        </div>

        <div id="report-container" class="mt-10 hidden">
          <div
            class="mb-10 border border-gray-200 rounded-xl shadow-lg overflow-hidden"
          >
            <div class="p-6 bg-white">
              <h2 class="text-2xl font-bold text-gray-800 mb-4">
                Generated Assessment Report
              </h2>
              <pre
                id="report-output"
                class="p-4 bg-gray-50 rounded-lg whitespace-pre-wrap font-mono text-sm"
              ></pre>
              <div class="mt-6 flex justify-end space-x-4">
                <button
                  id="copy-report-btn"
                  class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700"
                >
                  Copy to Clipboard
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="easter-egg-modal" class="modal-overlay hidden">
      <div class="modal-content text-center">
        <p class="font-semibold">Developed by Dr Bobby Tork MD, FRACGP-RG</p>
        <p class="text-sm">&copy; 2025 Dr Bobby Tork</p>
        <button
          id="close-easter-egg"
          class="mt-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700"
        >
          Close
        </button>
      </div>
    </div>
    <div id="clear-confirm-modal" class="modal-overlay hidden">
      <div class="modal-content">
        <h3 class="text-lg font-bold mb-2">Are you sure?</h3>
        <p class="text-gray-600 mb-4">
          All entered data will be lost. This action cannot be undone.
        </p>
        <div class="flex justify-center space-x-4">
          <button
            id="cancel-clear-btn"
            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-gray-700 bg-gray-200 hover:bg-gray-300"
          >
            Cancel
          </button>
          <button
            id="confirm-clear-btn"
            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700"
          >
            Clear Form
          </button>
        </div>
      </div>
    </div>
    <div id="restore-session-modal" class="modal-overlay hidden">
      <div class="modal-content">
        <h3 class="text-lg font-bold mb-2">Saved Session Found</h3>
        <p class="text-gray-600 mb-4">
          Would you like to restore your previously entered data or start a new
          assessment?
        </p>
        <div class="flex justify-center space-x-4">
          <button
            id="start-fresh-btn"
            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-gray-700 bg-gray-200 hover:bg-gray-300"
          >
            Start Fresh
          </button>
          <button
            id="restore-session-btn"
            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700"
          >
            Restore Session
          </button>
        </div>
      </div>
    </div>
    <div id="assessment-modal" class="modal-overlay hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modal-title" class="text-2xl font-bold">Assessment</h2>
          <div id="modal-score-display" class="score-display">Score: 0</div>
          <button id="modal-close-btn" class="modal-close-btn">&times;</button>
        </div>
        <div id="modal-body"></div>
        <div
          id="modal-footer"
          class="mt-6 flex justify-between items-center"
        ></div>
      </div>
    </div>
    <footer
      class="bg-indigo-950 text-indigo-100 border-t border-indigo-800 mt-auto"
    >
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
          <div class="col-span-1 md:col-span-2">
            <div class="flex items-center space-x-3 mb-4">
              <div
                class="w-9 h-9 bg-indigo-600 rounded-lg flex items-center justify-center shadow-sm"
              >
                <span class="text-white font-bold text-lg">GP</span>
              </div>
              <span class="font-bold text-xl text-white">GP Companion</span>
            </div>
            <p class="text-indigo-200 text-sm max-w-md">
              Comprehensive medical tools and health assessments designed for
              healthcare professionals. Streamline your workflow with our
              secure, privacy-focused platform.
            </p>
          </div>

          <div>
            <h3 class="font-semibold text-white mb-4">Quick Links</h3>
            <ul class="space-y-2">
              <li>
                <a
                  href="/about"
                  class="text-indigo-200 hover:text-white transition-colors text-sm block"
                >
                  About Website
                </a>
              </li>
              <li>
                <a
                  href="/developer"
                  class="text-indigo-200 hover:text-white transition-colors text-sm block"
                >
                  Developer
                </a>
              </li>
              <li>
                <a
                  href="/privacy"
                  class="text-indigo-200 hover:text-white transition-colors text-sm block"
                >
                  Privacy Policy
                </a>
              </li>
              <li>
                <a
                  href="/contact"
                  class="text-indigo-200 hover:text-white transition-colors text-sm block"
                >
                  Contact Developer
                </a>
              </li>
            </ul>
          </div>

          <div>
            <h3 class="font-semibold text-white mb-4">Tools</h3>
            <ul class="space-y-2">
              <li>
                <a
                  href="/gpccmp"
                  class="text-indigo-200 hover:text-white transition-colors text-sm block"
                >
                  GPCCMP Tool
                </a>
              </li>
              <li>
                <a
                  href="/HealthAssessments"
                  class="text-indigo-200 hover:text-white transition-colors text-sm block"
                >
                  Health Assessments
                </a>
              </li>
              <li>
                <a
                  href="/HealthAssessments"
                  class="text-indigo-200 hover:text-white transition-colors text-sm block"
                >
                  75+ Health Assessment
                </a>
              </li>
              <li>
                <a
                  href="/HealthAssessments"
                  class="text-indigo-200 hover:text-white transition-colors text-sm block"
                >
                  ATSI Health Assessment
                </a>
              </li>
            </ul>
          </div>
        </div>

        <div class="border-t border-indigo-800 mt-8 pt-8 text-center">
          <p class="text-indigo-300 text-sm">
            Â© 2024 GP Companion. All rights reserved. Designed for healthcare
            professionals.
          </p>
        </div>
      </div>
    </footer>

    <script>
      // --- Globals ---
      let completedAssessments = [];
      const LOCAL_STORAGE_KEY = "agedCareHealthAssessmentData";

      // --- DOM Element References ---
      const formContainer = document.getElementById("form-container");
      const saveTxtBtn = document.getElementById("save-txt-btn");
      const saveRtfBtn = document.getElementById("save-rtf-btn");
      const clearFormBtn = document.getElementById("clear-form-btn");
      const actionButtons = document.getElementById("action-buttons");
      const reportContainer = document.getElementById("report-container");
      const reportOutput = document.getElementById("report-output");
      const copyReportBtn = document.getElementById("copy-report-btn");
      const assessmentModal = document.getElementById("assessment-modal");
      const modalTitle = document.getElementById("modal-title");
      const modalBody = document.getElementById("modal-body");
      const modalFooter = document.getElementById("modal-footer");
      const modalCloseBtn = document.getElementById("modal-close-btn");
      const modalScoreDisplay = document.getElementById("modal-score-display");

      // --- Reusable HTML Templates ---
      const getChevronIcon = () =>
        `<svg class="chevron-icon w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>`;

      const getMbsSelectionHtml = () => `
            <div class="mb-10 border border-gray-200 rounded-xl shadow-lg overflow-hidden">
                <div class="text-xl font-bold text-white bg-indigo-700 px-6 py-3 flex justify-between items-center cursor-pointer"><h2 class="form-section-title">MBS Item Number</h2>${getChevronIcon()}</div>
                <div class="p-6 bg-white form-section-content">
                    <label class="block text-lg font-medium text-gray-700 mb-3">Select the appropriate MBS item number based on consultation time:</label>
                    <div class="space-y-3">
                        <label class="flex items-center"><input type="radio" name="mbs-item" value="701" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded mr-3"> <b>Item 701</b> - Brief health assessment lasting no more than 30 minutes</label>
                        <label class="flex items-center"><input type="radio" name="mbs-item" value="703" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded mr-3"> <b>Item 703</b> - Standard health assessment lasting at least 30 minutes and less than 45 minutes</label>
                        <label class="flex items-center"><input type="radio" name="mbs-item" value="705" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded mr-3"> <b>Item 705</b> - Long health assessment lasting at least 45 minutes and less than 60 minutes</label>
                        <label class="flex items-center"><input type="radio" name="mbs-item" value="707" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded mr-3"> <b>Item 707</b> - Prolonged health assessment lasting more than 60 minutes</label>
                    </div>
                    <div class="mt-4 p-3 bg-indigo-50 rounded-lg text-sm text-indigo-800">This health assessment is available annually to an eligible patient.</div>
                </div>
            </div>
        `;

      const getPatientDetailsHtml = () => {
        const today = new Date().toISOString().slice(0, 10);
        return `
            <div class="mb-10 border border-gray-200 rounded-xl shadow-lg overflow-hidden">
                <div class="text-xl font-bold text-white bg-indigo-700 px-6 py-3 flex justify-between items-center cursor-pointer"><h2 class="form-section-title">Patient Details</h2>${getChevronIcon()}</div>
                <div class="p-6 bg-white form-section-content">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 items-start">
                        <div><label for="patient-name" class="block text-sm font-medium text-gray-700 mb-1">Name: <span class="text-gray-400 font-normal">(optional)</span></label><input type="text" id="patient-name" class="input-field"></div>
                        <div><label for="assessment-date" class="block text-sm font-medium text-gray-700 mb-1">Assessment Date:</label><input type="date" id="assessment-date" class="input-field" value="${today}"></div>
                        <div><label for="patient-dob" class="block text-sm font-medium text-gray-700 mb-1">DOB:</label><input type="date" id="patient-dob" class="input-field"></div>
                         <div class="age-display-container">
                             <div id="patient-age-display" class="age-display">Age will be calculated</div>
                             <div id="patient-age-error" class="age-error"></div>
                         </div>
                        <div><label for="patient-medicare" class="block text-sm font-medium text-gray-700 mb-1">Medicare No: <span class="text-gray-400 font-normal">(optional)</span></label><input type="text" id="patient-medicare" class="input-field"></div>
                        <div>
                            <label for="patient-gender" class="block text-sm font-medium text-gray-700 mb-1">Gender:</label>
                            <select id="patient-gender" class="input-field">
                                <option value="">Select Gender</option><option value="male">Male</option><option value="female">Female</option>
                            </select>
                        </div>
                        <div class="sm:col-span-2">
                             <label class="flex items-center"><input type="checkbox" id="atsi-origin" class="h-4 w-4 text-indigo-600 mr-2"> Aboriginal and/or Torres Strait Islander origin</label>
                        </div>
                    </div>
                </div>
            </div>`;
      };

      const getImmunisationStatusHtml = () => `
            <div class="mb-10 border border-gray-200 rounded-xl shadow-lg overflow-hidden">
                <div class="text-xl font-bold text-white bg-indigo-700 px-6 py-3 flex justify-between items-center cursor-pointer"><h2 class="form-section-title">Immunisation Status</h2>${getChevronIcon()}</div>
                <div class="p-6 bg-white form-section-content">
                                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-8 gap-y-3">
                                      <label class="flex items-center"><input type="checkbox" id="influenza-utd" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded mr-3"> Influenza UTD</label>
                                      <label class="flex items-center"><input type="checkbox" id="tetanus-utd" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded mr-3"> Tetanus UTD</label>
                                      <label class="flex items-center"><input type="checkbox" id="pneumococcus-utd" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded mr-3"> Pneumococcus UTD</label>
                                      <label class="flex items-center"><input type="checkbox" id="covid-utd" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded mr-3"> COVID-19 UTD</label>
                                      <label class="flex items-center"><input type="checkbox" id="shingrix-utd" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded mr-3"> Shingrix UTD</label>
                                  </div>
                </div>
            </div>
        `;

      const getPlanAndRecsHtml = () => `
            <div class="mb-10 border border-gray-200 rounded-xl shadow-lg overflow-hidden">
                <div class="text-xl font-bold text-white bg-indigo-700 px-6 py-3 flex justify-between items-center cursor-pointer"><h2 class="form-section-title">Plan & Recommendations</h2>${getChevronIcon()}</div>
                <div class="p-6 bg-white form-section-content">
                    <h3 class="subsection-title">Recommended Actions, Screening and Immunisations</h3>
                    
                    <h4 class="font-semibold text-gray-700 mt-4 mb-2">Screening</h4>
                    <div id="screening-container" class="pl-2">
                        <label class="flex items-center my-2 hidden" id="rec-breast-screening-label"><input type="checkbox" value="Breast screening recommended."> Breast screening (Mammogram)</label>
                        <label class="flex items-center my-2 hidden" id="rec-bowel-screening-label"><input type="checkbox" value="Bowel cancer screening recommended."> Bowel cancer screening (FOBT/iFOBT)</label>
                        <label class="flex items-center my-2 hidden" id="rec-prostate-screening-label"><input type="checkbox" value="Prostate screening discussion recommended."> Prostate screening discussion</label>
                        <label class="flex items-center my-2 hidden" id="rec-cervical-screening-label"><input type="checkbox" value="Cervical screening recommended."> Cervical screening</label>
                        <label class="flex items-center my-2"><input type="checkbox" value="Osteoporosis screening recommended."> Osteoporosis screening</label>
                    </div>

                    <h4 class="font-semibold text-gray-700 mt-6 mb-2">Immunisations</h4>
                    <div id="immunisations-container" class="pl-2">
                        <label class="flex items-center my-2"><input type="checkbox" id="rec-influenza" value="Annual influenza immunisation recommended."> Annual influenza immunisation</label>
                        <label class="flex items-center my-2"><input type="checkbox" id="rec-covid" value="COVID-19 immunisation recommended."> COVID-19 immunisation</label>
                    </div>
                    <div id="other-immunisations-container" class="pl-2 mt-2 space-y-2"></div>
                    <button id="add-immunisation-btn" class="mt-2 ml-2 text-sm bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-1 px-3 rounded-md">+ Add Other</button>

                    <label for="plan-recommendations" class="block text-sm font-medium text-gray-700 mt-8 mb-1">Detail the management plan, referrals, and follow-up actions:</label>
                    <textarea id="plan-recommendations" class="input-field h-48"></textarea>
                </div>
            </div>`;

      // --- Dynamic Form Generation Function ---
      function getAgedCareForm() {
        return `
                ${getMbsSelectionHtml()}
                ${getPatientDetailsHtml()}
                <div class="mb-10 border border-gray-200 rounded-xl shadow-lg overflow-hidden">
                    <div class="text-xl font-bold text-white bg-indigo-700 px-6 py-3 flex justify-between items-center cursor-pointer"><h2 class="form-section-title">History & Medication</h2>${getChevronIcon()}</div>
                    <div class="p-6 bg-white form-section-content">
                        <label for="past-medical-history" class="block text-sm font-medium text-gray-700 mb-1">Past Medical History:</label>
                        <textarea id="past-medical-history" class="input-field h-24 mb-4"></textarea>
                        
                        <label for="regular-medications" class="block text-sm font-medium text-gray-700 mb-1">Regular Medications:</label>
                        <textarea id="regular-medications" class="input-field h-24 mb-4"></textarea>
                        
                        <label class="flex items-center mb-2"><input type="checkbox" id="meds-reviewed-checkbox" class="h-4 w-4 text-indigo-600 mr-2"> Medication list reviewed and reconciled with patient.</label>
                        <label class="flex items-center"><input type="checkbox" id="hmr-checkbox" class="h-4 w-4 text-indigo-600 mr-2"> Home Medication Review (HMR) recommended (Item 900)</label>
                    </div>
                </div>

                <div class="mb-10 border border-gray-200 rounded-xl shadow-lg overflow-hidden">
                    <div class="text-xl font-bold text-white bg-indigo-700 px-6 py-3 flex justify-between items-center cursor-pointer"><h2 class="form-section-title">Clinical & Functional Assessment</h2>${getChevronIcon()}</div>
                    <div class="p-6 bg-white form-section-content">
                        <h3 class="subsection-title">Vitals & Examinations</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div><label for="bp" class="block font-medium mb-1">BP (mmHg):</label><input type="text" id="bp" class="input-field" placeholder="e.g. 130/80"></div>
                            <div><label for="pulse-rate" class="block font-medium mb-1">Pulse (bpm):</label><input type="text" id="pulse-rate" class="input-field" placeholder="e.g. 70"></div>
                            <div><label for="pulse-rhythm" class="block font-medium mb-1">Rhythm:</label>
                                <select id="pulse-rhythm" class="input-field">
                                    <option value="Regular">Regular</option>
                                    <option value="Irregularly Irregular">Irregularly Irregular</option>
                                    <option value="Regularly Irregular">Regularly Irregular</option>
                                </select>
                            </div>
                            <div><label for="height" class="block font-medium mb-1">Height (cm):</label><input type="number" id="height" class="input-field" placeholder="e.g. 170"></div>
                            <div><label for="weight" class="block font-medium mb-1">Weight (kg):</label><input type="number" id="weight" class="input-field" placeholder="e.g. 75"></div>
                            <div class="age-display-container">
                                <div id="bmi-display" class="age-display">BMI will be calculated</div>
                            </div>
                        </div>
                        <div class="question-block">
                            <span class="font-medium">Has there been any recent unintentional weight changes?</span>
                            <div class="flex space-x-4 mt-1">
                                <label class="flex items-center"><input type="radio" name="weight-change" value="yes" class="mr-2"> Yes</label>
                                <label class="flex items-center"><input type="radio" name="weight-change" value="no" class="mr-2"> No</label>
                            </div>
                        </div>
                        <hr class="my-6">
                        <div class="space-y-2">
                            <label class="flex items-center"><input type="checkbox" id="ecg-checkbox" class="h-4 w-4 text-indigo-600 mr-2"> ECG performed (Item 11707)</label>
                            <div id="ecg-details-container" class="details-container hidden">
                                <label for="ecg-interpretation" class="block font-medium mb-1">Interpretation:</label>
                                <textarea id="ecg-interpretation" class="input-field" placeholder="ECG interpretation..."></textarea>
                            </div>
                            <label class="flex items-center"><input type="checkbox" id="abi-checkbox" class="h-4 w-4 text-indigo-600 mr-2"> ABI performed (Item 11610)</label>
                            <div id="abi-details-container" class="details-container hidden">
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label for="abi-left" class="block font-medium mb-1">Left:</label><input type="text" id="abi-left" class="input-field" placeholder="e.g. 1.1"></div>
                                    <div><label for="abi-right" class="block font-medium mb-1">Right:</label><input type="text" id="abi-right" class="input-field" placeholder="e.g. 1.2"></div>
                                </div>
                            </div>
                        </div>
                        <hr class="my-6">
                        <div class="space-y-2">
                            <label class="flex items-center"><input type="checkbox" id="cardio-exam-checkbox" class="h-4 w-4 text-indigo-600 mr-2"> Cardiovascular examination</label>
                            <div id="cardio-exam-details-container" class="details-container hidden">
                                <textarea id="cardio-exam-details" class="input-field" placeholder="Details of cardiovascular examination..."></textarea>
                            </div>
                            <label class="flex items-center"><input type="checkbox" id="resp-exam-checkbox" class="h-4 w-4 text-indigo-600 mr-2"> Respiratory examination</label>
                            <div id="resp-exam-details-container" class="details-container hidden">
                                <textarea id="resp-exam-details" class="input-field" placeholder="Details of respiratory examination..."></textarea>
                            </div>
                            <label class="flex items-center"><input type="checkbox" id="neuro-exam-checkbox" class="h-4 w-4 text-indigo-600 mr-2"> Neurological examination</label>
                            <div id="neuro-exam-details-container" class="details-container hidden">
                                <textarea id="neuro-exam-details" class="input-field" placeholder="Details of neurological examination..."></textarea>
                            </div>
                            <label class="flex items-center"><input type="checkbox" id="msk-exam-checkbox" class="h-4 w-4 text-indigo-600 mr-2"> Musculoskeletal examination</label>
                            <div id="msk-exam-details-container" class="details-container hidden">
                                <textarea id="msk-exam-details" class="input-field" placeholder="Details of musculoskeletal examination..."></textarea>
                            </div>
                            <label class="flex items-center"><input type="checkbox" id="abdo-exam-checkbox" class="h-4 w-4 text-indigo-600 mr-2"> Abdominal examination</label>
                            <div id="abdo-exam-details-container" class="details-container hidden">
                                <textarea id="abdo-exam-details" class="input-field" placeholder="Details of abdominal examination..."></textarea>
                            </div>
                             <label class="flex items-center"><input type="checkbox" id="other-exam-checkbox" class="h-4 w-4 text-indigo-600 mr-2"> Other examination</label>
                            <div id="other-exam-details-container" class="details-container hidden">
                                <textarea id="other-exam-details" class="input-field" placeholder="Details of other examination..."></textarea>
                            </div>
                        </div>

                        <h3 class="subsection-title">Physical Function</h3>
                        <div class="space-y-4">
                              <div class="question-block">
                                  <span class="font-medium">Has the patient had a fall in the last 3 months?</span>
                                  <div class="flex space-x-4 mt-1">
                                      <label class="flex items-center"><input type="radio" name="falls-risk" value="yes" class="mr-2"> Yes</label>
                                      <label class="flex items-center"><input type="radio" name="falls-risk" value="no" class="mr-2"> No</label>
                                  </div>
                                  <div id="falls-details-container" class="details-container hidden">
                                      <textarea id="falls-details" class="input-field" placeholder="Details of fall(s)..."></textarea>
                                  </div>
                              </div>
                            <div>
                                <label class="flex items-center"><input type="checkbox" id="adls-assessed-checkbox" class="h-4 w-4 text-indigo-600 mr-2"> Activities of Daily Living (ADLs) assessed.</label>
                                <div id="adls-details-container" class="details-container hidden">
                                    <select id="adls-status" class="input-field mb-2">
                                        <option value="Independent">Independent</option>
                                        <option value="Dependent">Dependent</option>
                                    </select>
                                    <textarea id="adls-details" class="input-field hidden" placeholder="Details of dependency..."></textarea>
                                </div>
                            </div>
                            <div>
                                <label class="flex items-center"><input type="checkbox" id="continence-assessed-checkbox" class="h-4 w-4 text-indigo-600 mr-2"> Continence assessed.</label>
                                <div id="continence-details-container" class="details-container hidden">
                                    <select id="continence-status" class="input-field mb-2">
                                        <option value="Continent">Continent</option>
                                        <option value="Incontinent">Incontinent</option>
                                    </select>
                                    <textarea id="continence-details" class="input-field hidden" placeholder="Details of incontinence..."></textarea>
                                </div>
                            </div>
                            <div>
                                <label class="flex items-center"><input type="checkbox" id="chronic-pain-checkbox" class="h-4 w-4 text-indigo-600 mr-2"> Chronic pain assessed</label>
                                <div id="chronic-pain-details-container" class="details-container hidden">
                                     <textarea id="chronic-pain-details" class="input-field" placeholder="Details of chronic pain..."></textarea>
                                </div>
                            </div>
                            <div>
                                <label class="flex items-center"><input type="checkbox" id="pressure-risk-checkbox" class="h-4 w-4 text-indigo-600 mr-2"> Risk of pressure injuries assessed</label>
                                <div id="pressure-risk-details-container" class="details-container hidden">
                                    <span class="font-medium block mb-2">Is the patient high risk for pressure injuries?</span>
                                    <div class="flex space-x-4">
                                         <label class="flex items-center"><input type="radio" name="pressure-high-risk" value="yes" class="mr-2"> Yes</label>
                                         <label class="flex items-center"><input type="radio" name="pressure-high-risk" value="no" class="mr-2"> No</label>
                                    </div>
                                    <textarea id="pressure-risk-details" class="input-field mt-2" placeholder="Details of pressure injury risk..."></textarea>
                                </div>
                            </div>
                            <div>
                                <label class="flex items-center"><input type="checkbox" id="vision-checkbox" class="h-4 w-4 text-indigo-600 mr-2"> Vision checked</label>
                                <div id="vision-details-container" class="details-container hidden">
                                    <div class="grid grid-cols-2 gap-2 items-center mb-2">
                                        <label class="flex items-center"><input type="radio" name="vision-correction" value="Corrected" class="mr-2"> Corrected</label>
                                        <label class="flex items-center"><input type="radio" name="vision-correction" value="Uncorrected" class="mr-2"> Uncorrected</label>
                                    </div>
                                    <div class="grid grid-cols-3 gap-2">
                                        <input type="text" id="vision-va-r" class="input-field" placeholder="VA R">
                                        <input type="text" id="vision-va-l" class="input-field" placeholder="VA L">
                                        <input type="text" id="vision-va-b" class="input-field" placeholder="VA Both">
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="flex items-center"><input type="checkbox" id="hearing-checkbox" class="h-4 w-4 text-indigo-600 mr-2"> Hearing checked</label>
                                <div id="hearing-details-container" class="details-container hidden">
                                    <select id="hearing-status" class="input-field mb-2">
                                        <option value="Adequate">Adequate</option>
                                        <option value="Inadequate">Inadequate</option>
                                    </select>
                                    <label class="flex items-center"><input type="checkbox" id="hearing-aid-used" class="h-4 w-4 text-indigo-600 mr-2"> Hearing aid used</label>
                                </div>
                            </div>
                            <div>
                                <label class="flex items-center"><input type="checkbox" id="dental-checkbox" class="h-4 w-4 text-indigo-600 mr-2"> Dental health assessed</label>
                                <div id="dental-details-container" class="details-container hidden">
                                    <textarea id="dental-details" class="input-field" placeholder="Details of dental assessment..."></textarea>
                                </div>
                            </div>
                            <div>
                                <label class="flex items-center"><input type="checkbox" id="foot-checkbox" class="h-4 w-4 text-indigo-600 mr-2"> Foot health assessed</label>
                                <div id="foot-details-container" class="details-container hidden">
                                    <textarea id="foot-details" class="input-field" placeholder="Details of foot assessment..."></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4">
                            <label for="other-physical-assessment" class="block text-sm font-medium text-gray-700 mb-1">Other physical function assessment:</label>
                            <textarea id="other-physical-assessment" class="input-field h-20"></textarea>
                        </div>


                        <h3 class="subsection-title">Social Function</h3>
                        <div class="space-y-4">
                            <div class="question-block">
                                <span class="font-medium">Patient had regular friend/family member visitors?</span>
                                <div class="flex space-x-4 mt-1">
                                    <label class="flex items-center"><input type="radio" name="visitors-status" value="yes" class="mr-2"> Yes</label>
                                    <label class="flex items-center"><input type="radio" name="visitors-status" value="no" class="mr-2"> No</label>
                                </div>
                                <div id="visitors-details-container" class="details-container hidden">
                                    <textarea id="visitors-details" class="input-field" placeholder="Details of visitors..."></textarea>
                                </div>
                            </div>
                            <div class="question-block">
                                <span class="font-medium">Social Isolation Screen: Does the patient often feel lonely or isolated?</span>
                                 <div class="flex space-x-4 mt-1">
                                      <label class="flex items-center"><input type="radio" name="social-isolation" value="yes" class="mr-2"> Yes</label>
                                      <label class="flex items-center"><input type="radio" name="social-isolation" value="no" class="mr-2"> No</label>
                                 </div>
                                 <div id="social-isolation-details-container" class="details-container hidden">
                                     <textarea id="social-isolation-details" class="input-field" placeholder="Details..."></textarea>
                                 </div>
                            </div>
                             <div class="question-block">
                                <span class="font-medium">Does the patient have an Advanced Care Plan?</span>
                                <div class="flex space-x-4 mt-1">
                                    <label class="flex items-center"><input type="radio" name="acp" value="yes" class="mr-2"> Yes</label>
                                    <label class="flex items-center"><input type="radio" name="acp" value="no" class="mr-2"> No</label>
                                </div>
                                <div id="acp-details-container" class="details-container hidden">
                                    <label for="resuscitation-status" class="block font-medium mb-1">Resuscitation Status:</label>
                                    <textarea id="resuscitation-status" class="input-field" placeholder="Enter resuscitation status..."></textarea>
                                </div>
                            </div>
                            <div class="mt-4">
                                <label for="other-social-assessment" class="block text-sm font-medium text-gray-700 mb-1">Other social function assessment:</label>
                                <textarea id="other-social-assessment" class="input-field h-20"></textarea>
                            </div>
                        </div>

                        <h3 class="subsection-title">Psychological Function</h3>
                        <label class="flex items-center"><input type="checkbox" id="cognition-assessed-checkbox" class="h-4 w-4 text-indigo-600 mr-2"> Cognition assessed</label>
                        <div id="cognition-details-container" class="details-container hidden">
                            <div class="grid grid-cols-2 gap-4 items-start">
                                <select id="cognition-tool" class="input-field">
                                    <option value="">Select Tool...</option>
                                    <option value="MMSE">MMSE</option>
                                    <option value="MoCA">MoCA</option>
                                </select>
                                <div>
                                    <input type="text" id="cognition-score" class="input-field" placeholder="Score">
                                    <a href="#" id="cognition-link" class="text-blue-600 hover:underline text-sm mt-1 block text-right hidden">Complete Assessment</a>
                                    <div id="cognition-interpretation" class="interpretation-box hidden mt-2"></div>
                                </div>
                            </div>
                        </div>
                        <label class="flex items-center"><input type="checkbox" id="mood-assessed-checkbox" class="h-4 w-4 text-indigo-600 mr-2"> Mood assessed</label>
                        <div id="mood-details-container" class="details-container hidden">
                            <div class="grid grid-cols-2 gap-4 items-start">
                                <select id="mood-tool" class="input-field">
                                    <option value="">Select Tool...</option>
                                    <option value="K10">K10</option>
                                    <option value="GDS">GDS</option>
                                    <option value="DASS21">DASS-21</option>
                                </select>
                                <div>
                                    <input type="text" id="mood-score" class="input-field" placeholder="Score">
                                    <a href="#" id="mood-link" class="text-blue-600 hover:underline text-sm mt-1 block text-right hidden">Complete Assessment</a>
                                    <div id="mood-interpretation" class="interpretation-box hidden mt-2"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mb-10 border border-gray-200 rounded-xl shadow-lg overflow-hidden">
                    <div class="text-xl font-bold text-white bg-indigo-700 px-6 py-3 flex justify-between items-center cursor-pointer"><h2 class="form-section-title">SNAP</h2>${getChevronIcon()}</div>
                    <div class="p-6 bg-white form-section-content">
                        <div class="space-y-4">
                            <div class="snap-item">
                                <div class="flex items-center">
                                    <input type="checkbox" id="assess-smoking" class="h-4 w-4 text-indigo-600 mr-3">
                                    <label for="assess-smoking" class="font-semibold text-gray-800">S - Smoking Status</label>
                                </div>
                                <div id="smoking-details-container" class="details-container hidden">
                                    <select id="smoking-status" class="input-field">
                                        <option value="">Select status...</option>
                                        <option value="current">Current Smoker</option>
                                        <option value="ex">Ex-smoker</option>
                                        <option value="non">Non-smoker</option>
                                    </select>
                                </div>
                            </div>

                            <div class="snap-item">
                                <div class="flex items-center">
                                    <input type="checkbox" id="assess-nutrition" class="h-4 w-4 text-indigo-600 mr-3">
                                    <label for="assess-nutrition" class="font-semibold text-gray-800">N - Nutrition</label>
                                </div>
                                <div id="nutrition-details-container" class="details-container hidden">
                                    <select id="nutrition-status" class="input-field">
                                        <option value="">Select diet type...</option>
                                        <option value="adequate">Adequate</option>
                                        <option value="inadequate">Inadequate</option>
                                    </select>
                                    <textarea id="nutrition-details" class="input-field mt-2" placeholder="Details of nutrition assessment..."></textarea>
                                </div>
                            </div>

                            <div class="snap-item">
                                <div class="flex items-center">
                                    <input type="checkbox" id="assess-alcohol" class="h-4 w-4 text-indigo-600 mr-3">
                                    <label for="assess-alcohol" class="font-semibold text-gray-800">A - Alcohol</label>
                                </div>
                                <div id="alcohol-details-container" class="details-container hidden">
                                    <div class="flex items-center space-x-2">
                                        <input type="number" id="alcohol-drinks" class="input-field w-1/2" placeholder="Std drinks">
                                        <select id="alcohol-period" class="input-field w-1/2">
                                            <option value="week">per week</option>
                                            <option value="day">per day</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="snap-item">
                                <div class="flex items-center">
                                    <input type="checkbox" id="assess-activity" class="h-4 w-4 text-indigo-600 mr-3">
                                    <label for="assess-activity" class="font-semibold text-gray-800">P - Physical Activity</label>
                                </div>
                                <div id="activity-details-container" class="details-container hidden">
                                    <div class="flex items-center space-x-2">
                                        <input type="number" id="activity-minutes" class="input-field" placeholder="Minutes of exercise">
                                        <span class="text-gray-600">per week</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                ${getImmunisationStatusHtml()}
                ${getPlanAndRecsHtml()}
            `;
      }

      // --- CORE SCRIPT LOGIC ---
      function initializeForm() {
        formContainer.innerHTML = getAgedCareForm();
        actionButtons.classList.remove("hidden");
        addAccordionListeners();
        addDynamicListeners();
        completedAssessments = [];
      }

      clearFormBtn.addEventListener("click", () => {
        document
          .getElementById("clear-confirm-modal")
          .classList.remove("hidden");
      });
      document
        .getElementById("cancel-clear-btn")
        .addEventListener("click", () => {
          document
            .getElementById("clear-confirm-modal")
            .classList.add("hidden");
        });
      document
        .getElementById("confirm-clear-btn")
        .addEventListener("click", () => {
          document
            .getElementById("clear-confirm-modal")
            .classList.add("hidden");
          initializeForm();
          reportContainer.classList.add("hidden");
          reportOutput.textContent = "";
          localStorage.removeItem(LOCAL_STORAGE_KEY); // Clear saved data
        });

      saveTxtBtn.addEventListener("click", () =>
        generateAndDisplayReport(true, "txt")
      );
      saveRtfBtn.addEventListener("click", () =>
        generateAndDisplayReport(true, "rtf")
      );

      copyReportBtn.addEventListener("click", () => {
        const textArea = document.createElement("textarea");
        textArea.value = reportOutput.textContent;
        document.body.appendChild(textArea);
        textArea.select();
        try {
          document.execCommand("copy");
          copyReportBtn.textContent = "Copied!";
          setTimeout(() => {
            copyReportBtn.textContent = "Copy to Clipboard";
          }, 2000);
        } catch (err) {
          console.error("Fallback: Oops, unable to copy", err);
        }
        document.body.removeChild(textArea);
      });

      function calculateAndDisplayAge() {
        const dobInput = document.getElementById("patient-dob");
        const ageDisplay = document.getElementById("patient-age-display");
        const ageError = document.getElementById("patient-age-error");
        if (!dobInput || !ageDisplay || !ageError) return;

        const dob = dobInput.value;
        ageError.textContent = ""; // Clear previous error messages
        if (!dob) {
          ageDisplay.innerHTML = "Age will be calculated";
          updateScreeningVisibility(); // Update visibility even if DOB is cleared
          return;
        }

        const birthDate = new Date(dob);
        const today = new Date();
        let age = today.getFullYear() - birthDate.getFullYear();
        const m = today.getMonth() - birthDate.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;

        ageDisplay.innerHTML = `Age: ${age}`;

        // Update screening recommendations based on new age
        updateScreeningVisibility();
      }

      function calculateBmi() {
        const heightInput = document.getElementById("height");
        const weightInput = document.getElementById("weight");
        const bmiDisplay = document.getElementById("bmi-display");
        if (!heightInput || !weightInput || !bmiDisplay) return;

        const height = parseFloat(heightInput.value);
        const weight = parseFloat(weightInput.value);

        if (height > 0 && weight > 0) {
          const heightInMeters = height / 100;
          const bmi = weight / (heightInMeters * heightInMeters);
          let interpretation = "";
          if (bmi < 18.5) interpretation = " (Underweight)";
          else if (bmi >= 18.5 && bmi <= 24.9)
            interpretation = " (Healthy Weight)";
          else if (bmi >= 25 && bmi <= 29.9) interpretation = " (Overweight)";
          else if (bmi >= 30) interpretation = " (Obese)";
          bmiDisplay.textContent = `BMI: ${bmi.toFixed(1)}${interpretation}`;
        } else {
          bmiDisplay.textContent = "BMI will be calculated";
        }
        updateManagementPlan();
      }

      function addAccordionListeners() {
        document.querySelectorAll(".bg-indigo-700").forEach((header) => {
          if (header.dataset.listener) return;
          header.dataset.listener = true;
          header.addEventListener("click", () => {
            const content = header.nextElementSibling;
            const chevron = header.querySelector(".chevron-icon");
            content.classList.toggle("collapsed");
            chevron.classList.toggle("rotated");
          });
        });
      }

      const allAutoRecs = new Set([
        "- Consideration of referral for DMMR (Item 900).",
        "- Irregular pulse detected. Recommend ECG and further evaluation for arrhythmia (e.g., Atrial Fibrillation).",
        "- Unintentional weight change noted. Recommend review and further assessment (e.g., blood tests, nutritional review).",
        "- ABI < 0.9 suggests PVD. Monitor and investigate as clinically indicated.",
        "- Assess mobility and falls risk further; consider OT referral.",
        "- Patient is dependent for some ADLs. Formal assessment and needs review documented.",
        "- Consider further assessment, investigation and management of incontinence.",
        "- Patient is high risk for pressure injuries. Implement a prevention plan including regular repositioning, use of pressure-relieving surfaces, and skin moisture management.",
        "- Vision impairment noted. Refer to optometrist/ophthalmologist for formal assessment.",
        "- Hearing impairment noted. Refer for audiology assessment.",
        "- Patient reports feeling lonely/isolated. Recommend discussion with facility social worker and encourage participation in available social activities.",
        "- Discuss importance of and offer to complete an Advanced Care Plan.",
        "- Cognitive score may indicate impairment (MoCA < 26). Consider further investigation and/or referral.",
        "- Cognitive score may indicate impairment (MMSE < 24). Consider further investigation and/or referral.",
        "- DASS-21 score indicates symptoms of depression, anxiety, or stress. Review and consider mental health care plan.",
        "- GDS score > 5 suggests depression. Consider further assessment.",
        "- K10 score >= 20 suggests psychological distress. Consider mental health care plan.",
        "- Smoking cessation advice offered and patient provided with resources.",
        "- Nutritional assessment and advice provided. Consider dietician referral.",
        "- Discussed alcohol intake and recommended reduction to safe levels (<=10 std drinks/week).",
        "- Discussed benefits of physical activity and strategies to increase to 150 mins/week.",
        "- BMI indicates patient is underweight. Recommend nutritional assessment and investigation for underlying causes.",
        "- BMI indicates patient is overweight. Recommend lifestyle advice on diet and physical activity.",
        "- BMI indicates patient is obese. Recommend comprehensive lifestyle management plan including diet, exercise, and consideration of comorbidities.",
      ]);

      function updateManagementPlan() {
        const planTextarea = document.getElementById("plan-recommendations");
        if (!planTextarea) return;

        const currentLines = planTextarea.value.split("\n");
        const userEnteredText = currentLines
          .filter((line) => !allAutoRecs.has(line.trim()))
          .join("\n")
          .trim();

        let newAutoRecs = new Set();
        const addRec = (rec) => newAutoRecs.add(rec);

        const isChecked = (id) => document.getElementById(id)?.checked;
        const getValue = (id) => document.getElementById(id)?.value || "";
        const getRadioValue = (name) =>
          document.querySelector(`input[name="${name}"]:checked`)?.value;

        // --- MEDICATION REVIEW ---
        if (isChecked("hmr-checkbox"))
          addRec("- Consideration of referral for DMMR (Item 900).");

        // --- VITALS & EXAMINATIONS ---
        const rhythm = getValue("pulse-rhythm");
        if (
          rhythm === "Irregularly Irregular" ||
          rhythm === "Regularly Irregular"
        ) {
          addRec(
            "- Irregular pulse detected. Recommend ECG and further evaluation for arrhythmia (e.g., Atrial Fibrillation)."
          );
        }
        if (getRadioValue("weight-change") === "yes") {
          addRec(
            "- Unintentional weight change noted. Recommend review and further assessment (e.g., blood tests, nutritional review)."
          );
        }
        const abiLeft = parseFloat(getValue("abi-left"));
        const abiRight = parseFloat(getValue("abi-right"));
        if (
          (!isNaN(abiLeft) && abiLeft < 0.9) ||
          (!isNaN(abiRight) && abiRight < 0.9)
        ) {
          addRec(
            "- ABI < 0.9 suggests PVD. Monitor and investigate as clinically indicated."
          );
        }
        const bmiText =
          document.getElementById("bmi-display")?.textContent || "";
        if (bmiText.includes("Underweight")) {
          addRec(
            "- BMI indicates patient is underweight. Recommend nutritional assessment and investigation for underlying causes."
          );
        } else if (bmiText.includes("Overweight")) {
          addRec(
            "- BMI indicates patient is overweight. Recommend lifestyle advice on diet and physical activity."
          );
        } else if (bmiText.includes("Obese")) {
          addRec(
            "- BMI indicates patient is obese. Recommend comprehensive lifestyle management plan including diet, exercise, and consideration of comorbidities."
          );
        }

        // --- PHYSICAL FUNCTION ---
        if (getRadioValue("falls-risk") === "yes")
          addRec(
            "- Assess mobility and falls risk further; consider OT referral."
          );
        if (getValue("adls-status") === "Dependent")
          addRec(
            "- Patient is dependent for some ADLs. Formal assessment and needs review documented."
          );
        if (getValue("continence-status") === "Incontinent")
          addRec(
            "- Consider further assessment, investigation and management of incontinence."
          );
        if (getRadioValue("pressure-high-risk") === "yes")
          addRec(
            "- Patient is high risk for pressure injuries. Implement a prevention plan including regular repositioning, use of pressure-relieving surfaces, and skin moisture management."
          );
        const vaR = getValue("vision-va-r").split("/")[1];
        const vaL = getValue("vision-va-l").split("/")[1];
        if ((vaR && parseInt(vaR) > 12) || (vaL && parseInt(vaL) > 12)) {
          addRec(
            "- Vision impairment noted. Refer to optometrist/ophthalmologist for formal assessment."
          );
        }
        if (getValue("hearing-status") === "Inadequate") {
          addRec("- Hearing impairment noted. Refer for audiology assessment.");
        }

        // --- SOCIAL FUNCTION ---
        if (getRadioValue("social-isolation") === "yes")
          addRec(
            "- Patient reports feeling lonely/isolated. Recommend discussion with facility social worker and encourage participation in available social activities."
          );
        if (getRadioValue("acp") === "no")
          addRec(
            "- Discuss importance of and offer to complete an Advanced Care Plan."
          );

        // --- PSYCHOLOGICAL FUNCTION ---
        const cogTool = getValue("cognition-tool");
        const cogScoreText = getValue("cognition-score");
        if (cogTool && cogScoreText) {
          const cogScore = parseInt(cogScoreText.split("/")[0]);
          if (cogTool === "MoCA" && !isNaN(cogScore) && cogScore < 26)
            addRec(
              "- Cognitive score may indicate impairment (MoCA < 26). Consider further investigation and/or referral."
            );
          if (cogTool === "MMSE" && !isNaN(cogScore) && cogScore < 24)
            addRec(
              "- Cognitive score may indicate impairment (MMSE < 24). Consider further investigation and/or referral."
            );
        }

        const moodTool = getValue("mood-tool");
        const moodScoreText = getValue("mood-score");
        if (moodTool && moodScoreText) {
          if (moodTool === "DASS21") {
            if (
              moodScoreText.includes("D:") &&
              (parseInt(moodScoreText.split("D:")[1].split(",")[0]) > 9 ||
                parseInt(moodScoreText.split("A:")[1].split(",")[0]) > 7 ||
                parseInt(moodScoreText.split("S:")[1]) > 14)
            ) {
              addRec(
                "- DASS-21 score indicates symptoms of depression, anxiety, or stress. Review and consider mental health care plan."
              );
            }
          } else {
            const moodScore = parseInt(moodScoreText.split("/")[0]);
            if (moodTool === "GDS" && !isNaN(moodScore) && moodScore > 5)
              addRec(
                "- GDS score > 5 suggests depression. Consider further assessment."
              );
            if (moodTool === "K10" && !isNaN(moodScore) && moodScore >= 20)
              addRec(
                "- K10 score >= 20 suggests psychological distress. Consider mental health care plan."
              );
          }
        }

        // --- SNAP ---
        if (
          isChecked("assess-smoking") &&
          getValue("smoking-status") === "current"
        )
          addRec(
            "- Smoking cessation advice offered and patient provided with resources."
          );
        if (
          isChecked("assess-nutrition") &&
          getValue("nutrition-status") === "inadequate"
        )
          addRec(
            "- Nutritional assessment and advice provided. Consider dietician referral."
          );
        const alcoholDrinks = parseInt(getValue("alcohol-drinks"));
        if (
          isChecked("assess-alcohol") &&
          !isNaN(alcoholDrinks) &&
          alcoholDrinks > 10 &&
          getValue("alcohol-period") === "week"
        ) {
          addRec(
            "- Discussed alcohol intake and recommended reduction to safe levels (<=10 std drinks/week)."
          );
        }
        const activityMins = parseInt(getValue("activity-minutes"));
        if (
          isChecked("assess-activity") &&
          !isNaN(activityMins) &&
          activityMins < 150
        ) {
          addRec(
            "- Discussed benefits of physical activity and strategies to increase to 150 mins/week."
          );
        }

        const recommendationsText = Array.from(newAutoRecs).join("\n");

        let finalText = recommendationsText;
        if (recommendationsText && userEnteredText) {
          finalText += "\n\n";
        }
        finalText += userEnteredText;
        planTextarea.value = finalText;
      }

      function updateScreeningVisibility() {
        const dob = document.getElementById("patient-dob")?.value;
        const gender = document.getElementById("patient-gender")?.value;

        const breastLabel = document.getElementById(
          "rec-breast-screening-label"
        );
        const bowelLabel = document.getElementById("rec-bowel-screening-label");
        const prostateLabel = document.getElementById(
          "rec-prostate-screening-label"
        );
        const cervicalLabel = document.getElementById(
          "rec-cervical-screening-label"
        );

        if (!breastLabel) return; // Exit if elements aren't on the page yet

        if (!dob) {
          // If no DOB, hide all conditional screenings
          [breastLabel, bowelLabel, prostateLabel, cervicalLabel].forEach(
            (el) => el.classList.add("hidden")
          );
          return;
        }

        const birthDate = new Date(dob);
        const today = new Date();
        let age = today.getFullYear() - birthDate.getFullYear();
        const m = today.getMonth() - birthDate.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;

        // Breast: Female, 50-75
        breastLabel.classList.toggle(
          "hidden",
          !(gender === "female" && age >= 50 && age <= 75)
        );
        // Bowel: 50-75
        bowelLabel.classList.toggle("hidden", !(age >= 50 && age <= 75));
        // Prostate: Male, >=50
        prostateLabel.classList.toggle(
          "hidden",
          !(gender === "male" && age >= 50)
        );
        // Cervical: Female, <75
        cervicalLabel.classList.toggle(
          "hidden",
          !(gender === "female" && age < 75)
        );
      }

      function addDynamicListeners() {
        // --- Patient Details Listeners ---
        document
          .getElementById("patient-dob")
          ?.addEventListener("change", calculateAndDisplayAge);
        document
          .getElementById("patient-gender")
          ?.addEventListener("change", updateScreeningVisibility);
        document
          .getElementById("patient-name")
          ?.addEventListener("input", (e) => {
            if (e.target.value.toLowerCase() === atob("YmlnIGJyb3RoZXIh")) {
              document
                .getElementById("easter-egg-modal")
                .classList.remove("hidden");
            }
          });
        document
          .getElementById("close-easter-egg")
          ?.addEventListener("click", () => {
            document.getElementById("easter-egg-modal").classList.add("hidden");
          });

        // --- Vitals Listeners ---
        document
          .getElementById("height")
          ?.addEventListener("input", calculateBmi);
        document
          .getElementById("weight")
          ?.addEventListener("input", calculateBmi);
        document
          .getElementById("plan-recommendations")
          ?.addEventListener("input", saveFormToLocalStorage);

        // --- Generic Toggle Setups ---
        const setupToggle = (checkboxId, detailsId) => {
          const checkbox = document.getElementById(checkboxId);
          const details = document.getElementById(detailsId);
          if (checkbox && details) {
            checkbox.addEventListener("change", (e) => {
              details.classList.toggle("hidden", !e.target.checked);
            });
          }
        };
        const setupSelectToggle = (
          selectId,
          dependentTextareaId,
          valueToShowOn
        ) => {
          const select = document.getElementById(selectId);
          const textarea = document.getElementById(dependentTextareaId);
          if (select && textarea) {
            select.addEventListener("change", (e) => {
              textarea.classList.toggle(
                "hidden",
                e.target.value !== valueToShowOn
              );
              updateManagementPlan();
            });
          }
        };
        const setupRadioToggle = (radioName, detailsId, valueToShowOn) => {
          document
            .querySelectorAll(`input[name="${radioName}"]`)
            .forEach((radio) => {
              radio.addEventListener("change", (e) => {
                const details = document.getElementById(detailsId);
                if (details) {
                  details.classList.toggle(
                    "hidden",
                    e.target.value !== valueToShowOn
                  );
                }
              });
            });
        };

        // --- Apply Toggles ---
        const toggleMap = {
          "ecg-checkbox": "ecg-details-container",
          "abi-checkbox": "abi-details-container",
          "cardio-exam-checkbox": "cardio-exam-details-container",
          "resp-exam-checkbox": "resp-exam-details-container",
          "neuro-exam-checkbox": "neuro-exam-details-container",
          "msk-exam-checkbox": "msk-exam-details-container",
          "abdo-exam-checkbox": "abdo-exam-details-container",
          "other-exam-checkbox": "other-exam-details-container",
          "vision-checkbox": "vision-details-container",
          "hearing-checkbox": "hearing-details-container",
          "dental-checkbox": "dental-details-container",
          "foot-checkbox": "foot-details-container",
          "adls-assessed-checkbox": "adls-details-container",
          "continence-assessed-checkbox": "continence-details-container",
          "chronic-pain-checkbox": "chronic-pain-details-container",
          "pressure-risk-checkbox": "pressure-risk-details-container",
          "cognition-assessed-checkbox": "cognition-details-container",
          "mood-assessed-checkbox": "mood-details-container",
          "assess-smoking": "smoking-details-container",
          "assess-nutrition": "nutrition-details-container",
          "assess-alcohol": "alcohol-details-container",
          "assess-activity": "activity-details-container",
        };
        Object.entries(toggleMap).forEach(([checkboxId, detailsId]) =>
          setupToggle(checkboxId, detailsId)
        );

        setupRadioToggle("falls-risk", "falls-details-container", "yes");
        setupRadioToggle("acp", "acp-details-container", "yes");
        setupRadioToggle(
          "social-isolation",
          "social-isolation-details-container",
          "yes"
        );
        setupRadioToggle(
          "visitors-status",
          "visitors-details-container",
          "yes"
        );
        setupSelectToggle("adls-status", "adls-details", "Dependent");
        setupSelectToggle(
          "continence-status",
          "continence-details",
          "Incontinent"
        );

        // --- Immunisation UTD Listeners ---
        const influenzaUtdCheckbox = document.getElementById("influenza-utd");
        const covidUtdCheckbox = document.getElementById("covid-utd");
        const recInfluenzaCheckbox = document.getElementById("rec-influenza");
        const recCovidCheckbox = document.getElementById("rec-covid");

        influenzaUtdCheckbox?.addEventListener("change", (e) => {
          if (recInfluenzaCheckbox) {
            recInfluenzaCheckbox.disabled = e.target.checked;
            if (e.target.checked) {
              recInfluenzaCheckbox.checked = false;
            }
          }
        });

        covidUtdCheckbox?.addEventListener("change", (e) => {
          if (recCovidCheckbox) {
            recCovidCheckbox.disabled = e.target.checked;
            if (e.target.checked) {
              recCovidCheckbox.checked = false;
            }
          }
        });

        // --- Listeners for Plan Updates ---
        const planUpdateElements = [
          "hmr-checkbox",
          "pulse-rhythm",
          "adls-status",
          "continence-status",
          "cognition-score",
          "abi-left",
          "abi-right",
          "vision-va-r",
          "vision-va-l",
          "vision-va-b",
          "hearing-status",
          "smoking-status",
          "nutrition-status",
          "alcohol-drinks",
          "activity-minutes",
          "mood-score",
          ...document.querySelectorAll('input[name="falls-risk"]'),
          ...document.querySelectorAll('input[name="weight-change"]'),
          ...document.querySelectorAll('input[name="pressure-high-risk"]'),
          ...document.querySelectorAll('input[name="acp"]'),
          ...document.querySelectorAll('input[name="social-isolation"]'),
        ];
        planUpdateElements.forEach((elementOrId) => {
          const el =
            typeof elementOrId === "string"
              ? document.getElementById(elementOrId)
              : elementOrId;
          if (el) {
            el.addEventListener("change", updateManagementPlan);
            if (
              el.tagName === "INPUT" &&
              el.type !== "radio" &&
              el.type !== "checkbox"
            )
              el.addEventListener("input", updateManagementPlan);
          }
        });

        // --- Assessment Launcher Listeners ---
        const setupLauncherLink = (toolSelectId, scoreInputId, linkId) => {
          const toolSelect = document.getElementById(toolSelectId);
          const link = document.getElementById(linkId);
          toolSelect?.addEventListener("change", () => {
            link.classList.toggle("hidden", toolSelect.value === "");
          });
          link?.addEventListener("click", (e) => {
            e.preventDefault();
            const tool = toolSelect.value;
            if (tool) openAssessmentModal(tool, scoreInputId);
          });
        };
        setupLauncherLink(
          "cognition-tool",
          "cognition-score",
          "cognition-link"
        );
        setupLauncherLink("mood-tool", "mood-score", "mood-link");

        // Add other immunisation
        document
          .getElementById("add-immunisation-btn")
          ?.addEventListener("click", () => {
            const container = document.getElementById(
              "other-immunisations-container"
            );
            const newImmunisation = document.createElement("div");
            newImmunisation.className = "flex items-center mt-2";
            newImmunisation.innerHTML = `
                    <label class="flex items-center my-2 flex-grow"><input type="checkbox" checked data-custom="true" class="h-4 w-4 text-indigo-600 mr-2"> <input type="text" class="flex-grow p-1 border-b focus:outline-none focus:border-indigo-500" placeholder="Enter immunisation name..."></label>
                    <button class="ml-4 text-red-500 hover:text-red-700 font-bold cursor-pointer" onclick="this.parentElement.remove()">X</button>
                `;
            container.appendChild(newImmunisation);
            newImmunisation.querySelector('input[type="text"]').focus();
          });

        // --- Auto-save listeners ---
        formContainer.addEventListener("input", saveFormToLocalStorage);
        formContainer.addEventListener("change", saveFormToLocalStorage);
      }

      function generateAndDisplayReport(download = false, format = "txt") {
        const reportText = buildReportFromForm();
        reportOutput.textContent = reportText;
        reportContainer.classList.remove("hidden");
        window.scrollTo({
          top: document.body.scrollHeight,
          behavior: "smooth",
        });

        if (download) {
          const patientName =
            document
              .getElementById("patient-name")
              ?.value.trim()
              .replace(/ /g, "_") || "report";
          const fileName = `AgedCare_HealthAssessment_${patientName}`;
          if (format === "rtf") {
            const rtfContent = convertToRtf(reportText, completedAssessments);
            downloadFile(`${fileName}.rtf`, rtfContent, "application/rtf");
          } else {
            downloadFile(`${fileName}.txt`, reportText, "text/plain");
          }
        }
      }

      function downloadFile(filename, content, mimeType) {
        const element = document.createElement("a");
        const blob = new Blob([content], { type: mimeType });
        element.href = URL.createObjectURL(blob);
        element.download = filename;
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
      }

      function convertToRtf(plainText, assessmentsArray) {
        let lines = plainText.split("\n");

        // Extract and remove the MBS line from the main text body for special formatting
        const mbsLineIndex = lines.findIndex((line) =>
          line.startsWith("MBS Item Number:")
        );
        let mbsLine = "";
        if (mbsLineIndex !== -1) {
          mbsLine = lines.splice(mbsLineIndex, 1)[0];
          // Also remove the blank line that follows it
          if (lines[mbsLineIndex] === "") {
            lines.splice(mbsLineIndex, 1);
          }
        }

        // The first line is now the title, which we will replace
        lines.shift();

        let rtfBody = "";
        const newTitle =
          "Health assessment for permanent residents of residential aged care facilities";

        // Add formatted title (Size 16 = 32 half-points)
        rtfBody += `{\\pard\\qc\\b\\fs32 ${newTitle
          .replace(/\\/g, "\\\\")
          .replace(/{/g, "\\{")
          .replace(/}/g, "\\}")}\\b0\\par}\n`;

        // Add formatted MBS number (Size 12 = 24 half-points)
        if (mbsLine) {
          rtfBody += `{\\pard\\qc\\fs24 ${mbsLine
            .replace(/\\/g, "\\\\")
            .replace(/{/g, "\\{")
            .replace(/}/g, "\\}")}\\par}\\par\n`;
        }

        // Process the rest of the lines
        let rtf = lines
          .join("\n")
          .replace(/\\/g, "\\\\")
          .replace(/{/g, "\\{")
          .replace(/}/g, "\\}");
        let remainingRtfLines = rtf.split("\n").map((line) => {
          const trimmedLine = line.trim();

          if (trimmedLine.match(/^[A-Z\s&'(),-]{5,}:$/)) {
            return `{\\pard\\sa100\\sl276\\slmult1\\b\\ul ${trimmedLine.slice(
              0,
              -1
            )}\\ul0\\b0\\par}`;
          }

          if (trimmedLine.startsWith("- ")) {
            return `{\\pard\\fi-360\\li720\\sa100\\sl276\\slmult1 -\\tab ${trimmedLine.substring(
              2
            )}\\par}`;
          }

          if (trimmedLine.length > 0) {
            return `{\\pard\\sa100\\sl276\\slmult1 ${trimmedLine}\\par}`;
          }
          return "{\\pard\\sa100\\par}"; // Use this for blank lines to ensure spacing
        });

        rtfBody += remainingRtfLines.join("\n");

        // Append assessments on new pages
        if (assessmentsArray && assessmentsArray.length > 0) {
          assessmentsArray.forEach((assessmentData) => {
            if (assessmentData && assessmentData.text) {
              rtfBody += "\\page\n";
              const titleRtf = assessmentData.title
                .replace(/\\/g, "\\\\")
                .replace(/{/g, "\\{")
                .replace(/}/g, "\\}");
              rtfBody += `{\\pard\\sa200\\sl276\\slmult1\\b\\f0\\fs28 ${titleRtf}\\b0\\par}\\par\n`;

              const assessmentRtf = assessmentData.text
                .replace(/\\/g, "\\\\")
                .replace(/{/g, "\\{")
                .replace(/}/g, "\\}")
                .split("\n")
                .map((line) => {
                  if (line.trim() === "") return "{\\pard\\sa100\\par}";
                  return `{\\pard\\sa100\\sl276\\slmult1\\fi0 ${line.trim()}\\par}`;
                })
                .join("\n");
              rtfBody += assessmentRtf;
            }
          });
        }

        return `{\\rtf1\\ansi\\deff0{\\fonttbl{\\f0 Inter;}}\\fs22\\sl360\\slmult1\n${rtfBody}\n}`;
      }

      function buildReportFromForm() {
        let report = "";
        const getValue = (id) =>
          document.getElementById(id)?.value.trim() || "";
        const isChecked = (id) => document.getElementById(id)?.checked;
        const getRadioValue = (name) =>
          document.querySelector(`input[name="${name}"]:checked`)?.value;
        const formatAusDate = (dateString) => {
          if (!dateString) return "N/A";
          const [year, month, day] = dateString.split("-");
          return `${day}/${month}/${year}`;
        };

        const addSection = (title, content) => {
          const cleanedContent = content.filter(
            (line) =>
              line &&
              line.trim() !== "" &&
              !line.endsWith(": N/A") &&
              !line.endsWith(": ")
          );
          if (cleanedContent.length > 0) {
            report += `${title.toUpperCase()}:\n${cleanedContent
              .map((line) => `- ${line.replace(/^- /, "")}`)
              .join("\n")}\n\n`;
          }
        };

        const addFreeTextSection = (title, elementId) => {
          const content = getValue(elementId);
          if (content) {
            report += `${title.toUpperCase()}:\n${content}\n\n`;
          }
        };

        report += `Health assessment for permanent residents of residential aged care facilities\n`;
        report += `MBS Item Number: ${getRadioValue("mbs-item") || "N/A"}\n\n`;

        const patientDetails = [
          `Name: ${getValue("patient-name") || "N/A"}`,
          `DOB: ${formatAusDate(getValue("patient-dob"))}`,
          `Age: ${
            document
              .getElementById("patient-age-display")
              ?.textContent.replace("Age: ", "") || "N/A"
          }`,
          `Gender: ${getValue("patient-gender") || "N/A"}`,
          `Medicare: ${getValue("patient-medicare") || "N/A"}`,
          `Date: ${formatAusDate(getValue("assessment-date"))}`,
          `Aboriginal and/or Torres Strait Islander origin: ${
            isChecked("atsi-origin") ? "Yes" : "No"
          }`,
        ];
        addSection("PATIENT DETAILS", patientDetails);

        addFreeTextSection("PAST MEDICAL HISTORY", "past-medical-history");
        addFreeTextSection("REGULAR MEDICATIONS", "regular-medications");

        let medReview = [];
        if (isChecked("meds-reviewed-checkbox"))
          medReview.push(
            "Medication list reviewed and reconciled with patient."
          );
        if (isChecked("hmr-checkbox"))
          medReview.push(
            "Home Medication Review (HMR) recommended (Item Number 900)."
          );
        addSection("MEDICATION REVIEW", medReview);

        let vitals = [];
        if (getValue("bp")) vitals.push(`BP: ${getValue("bp")} mmHg`);
        if (getValue("pulse-rate"))
          vitals.push(
            `Pulse: ${getValue("pulse-rate")} bpm, Rhythm: ${getValue(
              "pulse-rhythm"
            )}`
          );
        if (getValue("height")) vitals.push(`Height: ${getValue("height")} cm`);
        if (getValue("weight")) vitals.push(`Weight: ${getValue("weight")} kg`);
        if (
          document.getElementById("bmi-display")?.textContent.includes("BMI:")
        )
          vitals.push(document.getElementById("bmi-display").textContent);
        vitals.push(
          `Recent unintentional weight changes: ${
            getRadioValue("weight-change") || "N/A"
          }`
        );
        if (isChecked("ecg-checkbox"))
          vitals.push(
            `ECG Interpretation: ${
              getValue("ecg-interpretation") || "Not specified"
            }`
          );
        if (isChecked("abi-checkbox"))
          vitals.push(
            `ABI: Left ${getValue("abi-left") || "N/A"}, Right ${
              getValue("abi-right") || "N/A"
            }`
          );
        if (isChecked("cardio-exam-checkbox"))
          vitals.push(
            `Cardiovascular Exam: ${
              getValue("cardio-exam-details") || "Not specified"
            }`
          );
        if (isChecked("resp-exam-checkbox"))
          vitals.push(
            `Respiratory Exam: ${
              getValue("resp-exam-details") || "Not specified"
            }`
          );
        if (isChecked("neuro-exam-checkbox"))
          vitals.push(
            `Neurological Exam: ${
              getValue("neuro-exam-details") || "Not specified"
            }`
          );
        if (isChecked("msk-exam-checkbox"))
          vitals.push(
            `Musculoskeletal Exam: ${
              getValue("msk-exam-details") || "Not specified"
            }`
          );
        if (isChecked("abdo-exam-checkbox"))
          vitals.push(
            `Abdominal Exam: ${
              getValue("abdo-exam-details") || "Not specified"
            }`
          );
        if (isChecked("other-exam-checkbox"))
          vitals.push(
            `Other Exam: ${getValue("other-exam-details") || "Not specified"}`
          );
        addSection("VITALS & EXAMINATIONS", vitals);

        let physicalFunc = [];
        physicalFunc.push(
          `Falls History: ${
            getRadioValue("falls-risk") === "yes"
              ? `Fall in last 3 months. Details: ${
                  getValue("falls-details") || "N/A"
                }`
              : "No falls in last 3 months."
          }`
        );
        if (isChecked("adls-assessed-checkbox"))
          physicalFunc.push(
            `ADLs: ${getValue("adls-status")}${
              getValue("adls-status") === "Dependent"
                ? `. Details: ${getValue("adls-details") || "N/A"}`
                : "."
            }`
          );
        if (isChecked("continence-assessed-checkbox"))
          physicalFunc.push(
            `Continence: ${getValue("continence-status")}${
              getValue("continence-status") === "Incontinent"
                ? `. Details: ${getValue("continence-details") || "N/A"}`
                : "."
            }`
          );
        if (isChecked("chronic-pain-checkbox"))
          physicalFunc.push(
            `Chronic Pain: Assessed. Details: ${
              getValue("chronic-pain-details") || "Not specified"
            }`
          );
        if (isChecked("pressure-risk-checkbox"))
          physicalFunc.push(
            `Pressure Injury Risk: Assessed. High Risk: ${
              getRadioValue("pressure-high-risk") || "N/A"
            }. Details: ${getValue("pressure-risk-details") || "Not specified"}`
          );
        if (isChecked("vision-checkbox"))
          physicalFunc.push(
            `Vision checked: ${
              getRadioValue("vision-correction") || "N/A"
            }, R:${getValue("vision-va-r")}, L:${getValue(
              "vision-va-l"
            )}, B:${getValue("vision-va-b")}`
          );
        if (isChecked("hearing-checkbox"))
          physicalFunc.push(
            `Hearing: ${getValue("hearing-status")}${
              isChecked("hearing-aid-used") ? " (uses aid)" : ""
            }`
          );
        if (isChecked("dental-checkbox"))
          physicalFunc.push(
            `Dental health assessed. Details: ${
              getValue("dental-details") || "Not specified"
            }`
          );
        if (isChecked("foot-checkbox"))
          physicalFunc.push(
            `Foot health assessed. Details: ${
              getValue("foot-details") || "Not specified"
            }`
          );
        if (getValue("other-physical-assessment"))
          physicalFunc.push(
            `Other Physical Assessment: ${getValue(
              "other-physical-assessment"
            )}`
          );
        addSection("PHYSICAL FUNCTION", physicalFunc);

        let socialFunc = [];
        let visitorsText = `Regular visitors: ${getRadioValue(
          "visitors-status"
        )}`;
        if (getRadioValue("visitors-status") === "yes")
          visitorsText += `. Details: ${getValue("visitors-details") || "N/A"}`;
        socialFunc.push(visitorsText);

        let socialIsoText = `Feels lonely/isolated: ${getRadioValue(
          "social-isolation"
        )}`;
        if (getRadioValue("social-isolation") === "yes")
          socialIsoText += `. Details: ${
            getValue("social-isolation-details") || "N/A"
          }`;
        socialFunc.push(socialIsoText);

        socialFunc.push(
          `Advanced Care Plan: ${
            getRadioValue("acp") === "yes"
              ? `Yes. Status: ${getValue("resuscitation-status") || "N/A"}`
              : "No"
          }`
        );

        if (getValue("other-social-assessment"))
          socialFunc.push(
            `Other Social Assessment: ${getValue("other-social-assessment")}`
          );
        addSection("SOCIAL FUNCTION", socialFunc);

        let psychFunc = [];
        if (
          isChecked("cognition-assessed-checkbox") &&
          getValue("cognition-tool")
        ) {
          psychFunc.push(
            `Cognition Screen (${getValue("cognition-tool")}): ${
              getValue("cognition-score") || "N/A"
            }`
          );
        }
        if (isChecked("mood-assessed-checkbox") && getValue("mood-tool")) {
          psychFunc.push(
            `Mood Screen (${getValue("mood-tool")}): ${
              getValue("mood-score") || "N/A"
            }`
          );
        }
        addSection("PSYCHOLOGICAL FUNCTION", psychFunc);

        let snap = [];
        if (isChecked("assess-smoking"))
          snap.push(`Smoking: ${getValue("smoking-status")}`);
        if (isChecked("assess-nutrition"))
          snap.push(
            `Nutrition: ${getValue("nutrition-status")}. Details: ${
              getValue("nutrition-details") || "Not specified"
            }`
          );
        if (isChecked("assess-alcohol"))
          snap.push(
            `Alcohol: ${getValue("alcohol-drinks")} std drinks / ${getValue(
              "alcohol-period"
            )}`
          );
        if (isChecked("assess-activity"))
          snap.push(
            `Physical Activity: ${getValue("activity-minutes")} mins/week`
          );
        addSection(
          "SNAP (SMOKING, NUTRITION, ALCOHOL, PHYSICAL ACTIVITY)",
          snap
        );

        let immunisationStatus = [];
        if (isChecked("influenza-utd"))
          immunisationStatus.push("Influenza: Up to date");
        if (isChecked("tetanus-utd"))
          immunisationStatus.push("Tetanus: Up to date");
        if (isChecked("pneumococcus-utd"))
          immunisationStatus.push("Pneumococcus: Up to date");
        if (isChecked("covid-utd"))
          immunisationStatus.push("COVID-19: Up to date");
        if (isChecked("shingrix-utd"))
          immunisationStatus.push("Shingrix: Up to date");
        addSection("IMMUNISATION STATUS", immunisationStatus);

        addFreeTextSection("PLAN & RECOMMENDATIONS", "plan-recommendations");

        return report.trim();
      }

      // --- ASSESSMENT MODAL LOGIC (INTEGRATED) ---

      const assessmentTemplates = {
        MMSE: {
          title: "Standardised Mini-Mental State Examination (SMMSE)",
          type: "custom-score",
          maxScore: 30,
          getInterpretation: (score) => {
            if (score >= 24)
              return "Score does not suggest significant cognitive impairment.";
            if (score >= 18) return "Score suggests mild cognitive impairment.";
            if (score >= 10)
              return "Score suggests moderate cognitive impairment.";
            return "Score suggests severe cognitive impairment.";
          },
          html: () => `
                    <div id="assessment-form-content">
                        <div id="mmse-main-form">
                            <div class="task-group">
                                <h4>Orientation to Time (5 points)</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-2">
                                    <label class="checkbox-label"><input type="checkbox" data-score="1"> What year is this?</label>
                                    <label class="checkbox-label"><input type="checkbox" data-score="1"> What season is this?</label>
                                    <label class="checkbox-label"><input type="checkbox" data-score="1"> What month is this?</label>
                                    <label class="checkbox-label"><input type="checkbox" data-score="1"> What is today's date?</label>
                                    <label class="checkbox-label"><input type="checkbox" data-score="1"> What day of the week is this?</label>
                                </div>
                            </div>
                            <div class="task-group">
                                <h4>Orientation to Place (5 points)</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-2">
                                    <label class="checkbox-label"><input type="checkbox" data-score="1"> What country are we in?</label>
                                    <label class="checkbox-label"><input type="checkbox" data-score="1"> What state are we in?</label>
                                    <label class="checkbox-label"><input type="checkbox" data-score="1"> What city/town are we in?</label>
                                    <label class="checkbox-label"><input type="checkbox" data-score="1"> What is the name of this building?</label>
                                    <label class="checkbox-label"><input type="checkbox" data-score="1"> What floor of the building are we on?</label>
                                </div>
                            </div>
                            <div class="task-group">
                                <h4>Registration (3 points)</h4>
                                <p class="text-sm text-gray-600 mb-2">"I am going to name three objects. When I am finished, I want you to repeat them. Remember what they are because I am going to ask you to name them again in a few minutes." (Ball, Car, Man)</p>
                                <input type="number" min="0" max="3" class="input-field" data-score-input placeholder="Score for first attempt (0-3)">
                            </div>
                            <div class="task-group">
                                <h4>Attention & Calculation (5 points)</h4>
                                <p class="text-sm text-gray-600 mb-2">"Spell the word WORLD backwards." (D-L-R-O-W)</p>
                                <input type="number" min="0" max="5" class="input-field" data-score-input placeholder="Enter score (0-5)">
                            </div>
                            <div class="task-group">
                                <h4>Recall (3 points)</h4>
                                <p class="text-sm text-gray-600 mb-2">"Now what were the three objects I asked you to remember?"</p>
                                <input type="number" min="0" max="3" class="input-field" data-score-input placeholder="Enter score (0-3)">
                            </div>
                            <div class="task-group">
                                <h4>Language & Praxis (9 points)</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-2">
                                    <label class="checkbox-label"><input type="checkbox" data-score="1"> Naming a watch (1 pt)</label>
                                    <label class="checkbox-label"><input type="checkbox" data-score="1"> Naming a pencil (1 pt)</label>
                                    <label class="checkbox-label"><input type="checkbox" data-score="1"> Repeating "No ifs, ands, or buts" (1 pt)</label>
                                    <label class="checkbox-label"><input type="checkbox" data-score="1"> Reading and obeying "Close your eyes" (1 pt)</label>
                                    <label class="checkbox-label"><input type="checkbox" data-score="1"> Writing a sentence (1 pt)</label>
                                    <label class="checkbox-label"><input type="checkbox" data-score="1"> Takes paper in correct (non-dominant) hand (1 pt)</label>
                                    <label class="checkbox-label"><input type="checkbox" data-score="1"> Folds paper in half (1 pt)</label>
                                    <label class="checkbox-label"><input type="checkbox" data-score="1"> Puts paper on the floor (1 pt)</label>
                                </div>
                                <div class="mt-4">
                                    <p class="mb-2">Copying intersecting pentagons (1 pt):</p>
                                    <svg width="300" height="150" viewBox="0 0 150 70" class="border rounded-md p-2 bg-white">
                                        <polygon points="50,10 80,30 65,60 35,60 20,30" stroke="black" fill="none" stroke-width="2"/>
                                        <polygon points="100,10 130,30 115,60 85,60 70,30" stroke="black" fill="none" stroke-width="2"/>
                                    </svg>
                                    <label class="checkbox-label mt-2"><input type="checkbox" data-score="1" id="mmse-copy"> Award 1 point if correct</label>
                                </div>
                            </div>
                        </div>
                        <div id="mmse-close-eyes-page" class="hidden text-center py-20">
                            <p class="text-6xl font-bold">Close your eyes</p>
                        </div>
                    </div>
                `,
        },
        MoCA: {
          title: "Montreal Cognitive Assessment (MoCA)",
          type: "custom-score",
          maxScore: 30,
          getInterpretation: (score) => {
            if (score >= 26) return "Score is within the normal range.";
            return "Score < 26 suggests mild cognitive impairment.";
          },
          html: () => `
                    <div id="assessment-form-content" class="space-y-4">
                        <div class="task-group">
                            <h4>Visuospatial / Executive</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <p class="font-medium">Alternating Trail Making (1 pt)</p>
                                    <svg id="trail-making-svg" width="375" height="225" viewBox="0 0 200 120" class="bg-white border rounded-md p-2 mt-2">
                                    </svg>
                                    <div class="flex space-x-2 mt-2">
                                        <button type="button" id="reset-trails-btn" class="text-xs bg-gray-200 px-2 py-1 rounded">Reset</button>
                                        <label class="checkbox-label text-sm mb-0"><input type="checkbox" data-score="1" id="moca-trails"> Correct</label>
                                    </div>
                                </div>
                                <div class="flex flex-col justify-between">
                                    <div>
                                        <p class="font-medium">Copy Cube (1 pt)</p>
                                        <svg width="180" height="180" viewBox="0 0 80 80" class="bg-white border rounded-md p-2 mt-2">
                                            <rect x="20" y="20" width="40" height="40" stroke="black" fill="none" stroke-width="2"/>
                                            <rect x="35" y="5" width="40" height="40" stroke="black" fill="none" stroke-width="2"/>
                                            <line x1="20" y1="20" x2="35" y2="5" stroke="black" stroke-width="2"/>
                                            <line x1="60" y1="20" x2="75" y2="5" stroke="black" stroke-width="2"/>
                                            <line x1="20" y1="60" x2="35" y2="45" stroke="black" stroke-width="2"/>
                                            <line x1="60" y1="60" x2="75" y2="45" stroke="black" stroke-width="2"/>
                                        </svg>
                                    </div>
                                    <label class="checkbox-label"><input type="checkbox" data-score="1" id="moca-cube"> Correct</label>
                                </div>
                            </div>
                            <div class="mt-4">
                                <p class="font-medium">Draw Clock (ten past eleven) (3 pts)</p>
                                <div class="flex items-center justify-between mt-2">
                                    <svg width="225" height="225" viewBox="0 0 100 100" class="bg-white border rounded-md"><circle cx="50" cy="50" r="45" stroke="black" fill="none" stroke-width="2"/></svg>
                                    <div class="space-y-1">
                                        <label class="checkbox-label"><input type="checkbox" data-score="1" id="moca-clock-contour"> Contour (1 pt)</label>
                                        <label class="checkbox-label"><input type="checkbox" data-score="1" id="moca-clock-numbers"> Numbers (1 pt)</label>
                                        <label class="checkbox-label"><input type="checkbox" data-score="1" id="moca-clock-hands"> Hands (1 pt)</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="task-group">
                            <h4>Naming (3 points)</h4>
                             <div class="grid grid-cols-3 gap-4 items-center text-center">
                                 <div class="flex flex-col items-center">
                                     <a href="https://placehold.co/600x400/EEE/31343C?text=LION" target="_blank" onclick="event.preventDefault(); openImagePopup(this.href);" class="text-blue-600 hover:underline mb-2">View Lion</a>
                                     <label class="checkbox-label justify-center"><input type="checkbox" data-score="1" id="moca-name-lion"> Correct</label>
                                 </div>
                                 <div class="flex flex-col items-center">
                                      <a href="https://placehold.co/600x400/EEE/31343C?text=RHINOCEROS" target="_blank" onclick="event.preventDefault(); openImagePopup(this.href);" class="text-blue-600 hover:underline mb-2">View Rhinoceros</a>
                                     <label class="checkbox-label justify-center"><input type="checkbox" data-score="1" id="moca-name-rhino"> Correct</label>
                                 </div>
                                 <div class="flex flex-col items-center">
                                      <a href="https://placehold.co/600x400/EEE/31343C?text=CAMEL" target="_blank" onclick="event.preventDefault(); openImagePopup(this.href);" class="text-blue-600 hover:underline mb-2">View Camel</a>
                                     <label class="checkbox-label justify-center"><input type="checkbox" data-score="1" id="moca-name-camel"> Correct</label>
                                 </div>
                             </div>
                        </div>
                        <div class="task-group">
                             <h4>Memory</h4>
                             <p class="text-sm text-gray-600">Read list of 5 words, patient recalls. Perform 2 trials. No points on this part.</p>
                             <p class="font-medium mt-1">FACE, VELVET, CHURCH, DAISY, RED</p>
                        </div>
                        <div class="task-group">
                             <h4>Attention (6 points)</h4>
                             <label class="checkbox-label"><input type="checkbox" data-score="1" id="moca-digit-fwd"> Forward Digit Span correct (1 pt)</label>
                             <label class="checkbox-label"><input type="checkbox" data-score="1" id="moca-digit-bwd"> Backward Digit Span correct (1 pt)</label>
                             <label class="checkbox-label"><input type="checkbox" data-score="1" id="moca-vigilance"> Vigilance (Tapping on 'A') correct (1 pt)</label>
                             <div>
                                 <p class="mt-2 mb-1 font-medium">Serial 7s (93, 86, 79, 72, 65):</p>
                                 <input type="number" min="0" max="3" class="input-field" data-score-input id="moca-serial7" placeholder="Enter score (0-3 pts)">
                             </div>
                        </div>
                        <div class="task-group">
                            <h4>Language (2 points)</h4>
                            <div>
                                <p class="mb-1">Repeat: "I only know that John is the one to help today."</p>
                                <label class="checkbox-label"><input type="checkbox" data-score="1" id="moca-lang-rep1"> Correct (1 pt)</label>
                            </div>
                             <div>
                                <p class="mt-2 mb-1">Repeat: "The cat always hid under the couch when dogs were in the room."</p>
                                <label class="checkbox-label"><input type="checkbox" data-score="1" id="moca-lang-rep2"> Correct (1 pt)</label>
                            </div>
                        </div>
                         <div class="task-group">
                            <h4>Fluency (1 point)</h4>
                            <div>
                                <p class="mt-2 mb-1">Name max words starting with 'F' in 60s. (Score 1 pt if >=11 words)</p>
                                <label class="checkbox-label"><input type="checkbox" data-score="1" id="moca-lang-fluency"> >= 11 words (1 pt)</label>
                            </div>
                        </div>
                        <div class="task-group">
                            <h4>Abstraction (2 points)</h4>
                            <label class="checkbox-label"><input type="checkbox" data-score="1" id="moca-abs-train"> Train-Bicycle (e.g., means of transport) (1 pt)</label>
                            <label class="checkbox-label"><input type="checkbox" data-score="1" id="moca-abs-watch"> Watch-Ruler (e.g., measuring instruments) (1 pt)</label>
                        </div>
                        <div class="task-group">
                             <h4>Delayed Recall (5 points)</h4>
                             <p class="text-sm text-gray-600 mb-2">FACE, VELVET, CHURCH, DAISY, RED. 1 point per word recalled without cues.</p>
                             <input type="number" min="0" max="5" class="input-field" data-score-input id="moca-recall" placeholder="Enter score (0-5)">
                        </div>
                        <div class="task-group">
                            <h4>Orientation (6 points)</h4>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                <label class="checkbox-label"><input type="checkbox" data-score="1"> Date</label>
                                <label class="checkbox-label"><input type="checkbox" data-score="1"> Month</label>
                                <label class="checkbox-label"><input type="checkbox" data-score="1"> Year</label>
                                <label class="checkbox-label"><input type="checkbox" data-score="1"> Day</label>
                                <label class="checkbox-label"><input type="checkbox" data-score="1"> Place</label>
                                <label class="checkbox-label"><input type="checkbox" data-score="1"> City</label>
                            </div>
                        </div>
                        <div class="task-group">
                            <h4>Education adjustment</h4>
                            <label class="checkbox-label"><input type="checkbox" data-score="1" id="moca-education"> Add 1 point if education is 12 years or less</label>
                        </div>
                    </div>
                `,
        },
        K10: {
          title: "Kessler Psychological Distress Scale (K10)",
          type: "radio-sum",
          maxScore: 50,
          getInterpretation: (score) => {
            if (score <= 19)
              return "Score suggests the patient is likely to be well.";
            if (score <= 24) return "Score suggests a mild mental disorder.";
            if (score <= 29)
              return "Score suggests a moderate mental disorder.";
            return "Score suggests a severe mental disorder.";
          },
          html: () => `
                    <p class="text-gray-600 mb-4">Over the last 4 weeks, about how often did the patient feel...</p>
                    <div id="assessment-form-content" class="grid grid-cols-1 md:grid-cols-2 gap-x-8">
                        ${[
                          "Tired out for no good reason?",
                          "Nervous?",
                          "So nervous that nothing could calm them down?",
                          "Hopeless?",
                          "Restless or fidgety?",
                          "So restless they could not sit still?",
                          "Depressed?",
                          "That everything was an effort?",
                          "So sad that nothing could cheer them up?",
                          "Worthless?",
                        ]
                          .map(
                            (q, i) => `
                        <div class="assessment-question">
                            <p class="font-medium mb-2">${i + 1}. ${q}</p>
                            <div class="assessment-options text-sm space-y-2">
                                <label class="radio-label mb-0"><input type="radio" name="k10-q${i}" value="1"> None of the time</label>
                                <label class="radio-label mb-0"><input type="radio" name="k10-q${i}" value="2"> A little of the time</label>
                                <label class="radio-label mb-0"><input type="radio" name="k10-q${i}" value="3"> Some of the time</label>
                                <label class="radio-label mb-0"><input type="radio" name="k10-q${i}" value="4"> Most of the time</label>
                                <label class="radio-label mb-0"><input type="radio" name="k10-q${i}" value="5"> All of the time</label>
                            </div>
                        </div>`
                          )
                          .join("")}
                    </div>
                `,
        },
        GDS: {
          title: "Geriatric Depression Scale (GDS-15)",
          type: "gds-score",
          maxScore: 15,
          getInterpretation: (score) => {
            if (score <= 5) return "Score is within the normal range.";
            return "Score > 5 is suggestive of depression and warrants a follow-up comprehensive assessment.";
          },
          html: () => `
                    <p class="text-gray-600 mb-4">Choose the best answer for how you have felt over the past week.</p>
                    <div id="assessment-form-content" class="grid grid-cols-1 md:grid-cols-2 gap-x-8">
                        ${[
                          {
                            q: "Are you basically satisfied with your life?",
                            depressive: "no",
                          },
                          {
                            q: "Have you dropped many of your activities and interests?",
                            depressive: "yes",
                          },
                          {
                            q: "Do you feel that your life is empty?",
                            depressive: "yes",
                          },
                          { q: "Do you often get bored?", depressive: "yes" },
                          {
                            q: "Are you in good spirits most of the time?",
                            depressive: "no",
                          },
                          {
                            q: "Are you afraid that something bad is going to happen to you?",
                            depressive: "yes",
                          },
                          {
                            q: "Do you feel happy most of the time?",
                            depressive: "no",
                          },
                          {
                            q: "Do you often feel helpless?",
                            depressive: "yes",
                          },
                          {
                            q: "Do you prefer to stay at home, rather than going out and doing new things?",
                            depressive: "yes",
                          },
                          {
                            q: "Do you feel you have more problems with memory than most?",
                            depressive: "yes",
                          },
                          {
                            q: "Do you think it is wonderful to be alive now?",
                            depressive: "no",
                          },
                          {
                            q: "Do you feel pretty worthless the way you are now?",
                            depressive: "yes",
                          },
                          {
                            q: "Do you feel full of energy?",
                            depressive: "no",
                          },
                          {
                            q: "Do you feel that your situation is hopeless?",
                            depressive: "yes",
                          },
                          {
                            q: "Do you think that most people are better off than you are?",
                            depressive: "yes",
                          },
                        ]
                          .map(
                            (item, i) => `
                        <div class="assessment-question">
                            <p class="font-medium mb-2">${i + 1}. ${item.q}</p>
                            <div class="assessment-options text-sm" data-depressive-answer="${
                              item.depressive
                            }">
                                <label class="radio-label mb-0"><input type="radio" name="gds-q${i}" value="yes"> Yes</label>
                                <label class="radio-label mb-0"><input type="radio" name="gds-q${i}" value="no"> No</label>
                            </div>
                        </div>`
                          )
                          .join("")}
                    </div>
                `,
        },
        DASS21: {
          title: "Depression Anxiety Stress Scales (DASS-21)",
          type: "dass-score",
          maxScore: 42, // Per scale
          getInterpretation: (scores) => {
            const { d, a, s } = scores;
            let interp = [];
            // Depression
            if (d <= 9) interp.push("Depression: Normal");
            else if (d <= 13) interp.push("Depression: Mild");
            else if (d <= 20) interp.push("Depression: Moderate");
            else if (d <= 27) interp.push("Depression: Severe");
            else interp.push("Depression: Extremely Severe");
            // Anxiety
            if (a <= 7) interp.push("Anxiety: Normal");
            else if (a <= 9) interp.push("Anxiety: Mild");
            else if (a <= 14) interp.push("Anxiety: Moderate");
            else if (a <= 19) interp.push("Anxiety: Severe");
            else interp.push("Anxiety: Extremely Severe");
            // Stress
            if (s <= 14) interp.push("Stress: Normal");
            else if (s <= 18) interp.push("Stress: Mild");
            else if (s <= 25) interp.push("Stress: Moderate");
            else if (s <= 33) interp.push("Stress: Severe");
            else interp.push("Stress: Extremely Severe");
            return interp.join("; ");
          },
          html: () => `
                     <p class="text-gray-600 mb-4">Please read each statement and indicate how much the statement applied to you <b>over the past week</b>.</p>
                     <div id="assessment-form-content" class="grid grid-cols-1 md:grid-cols-2 gap-x-8">
                          ${[
                            {
                              q: "I found it hard to wind down",
                              scale: "stress",
                            },
                            {
                              q: "I was aware of dryness of my mouth",
                              scale: "anxiety",
                            },
                            {
                              q: "I couldnât seem to experience any positive feeling at all",
                              scale: "depression",
                            },
                            {
                              q: "I experienced breathing difficulty",
                              scale: "anxiety",
                            },
                            {
                              q: "I found it difficult to work up the initiative to do things",
                              scale: "depression",
                            },
                            {
                              q: "I tended to over-react to situations",
                              scale: "stress",
                            },
                            {
                              q: "I experienced trembling (e.g. in the hands)",
                              scale: "anxiety",
                            },
                            {
                              q: "I felt that I was using a lot of nervous energy",
                              scale: "stress",
                            },
                            {
                              q: "I was worried about situations in which I might panic",
                              scale: "anxiety",
                            },
                            {
                              q: "I felt that I had nothing to look forward to",
                              scale: "depression",
                            },
                            {
                              q: "I found myself getting agitated",
                              scale: "stress",
                            },
                            {
                              q: "I found it difficult to relax",
                              scale: "stress",
                            },
                            {
                              q: "I felt down-hearted and blue",
                              scale: "depression",
                            },
                            {
                              q: "I was intolerant of anything that kept me from getting on",
                              scale: "stress",
                            },
                            {
                              q: "I felt I was close to panic",
                              scale: "anxiety",
                            },
                            {
                              q: "I was unable to become enthusiastic about anything",
                              scale: "depression",
                            },
                            {
                              q: "I felt I was not worth much as a person",
                              scale: "depression",
                            },
                            {
                              q: "I felt that I was rather touchy",
                              scale: "stress",
                            },
                            {
                              q: "I was aware of the action of my heart in the absence of physical exertion",
                              scale: "anxiety",
                            },
                            {
                              q: "I felt scared without any good reason",
                              scale: "anxiety",
                            },
                            {
                              q: "I felt that life was meaningless",
                              scale: "depression",
                            },
                          ]
                            .map(
                              (item, i) => `
                         <div class="assessment-question" data-scale="${
                           item.scale
                         }">
                              <p class="font-medium mb-2">${i + 1}. ${
                                item.q
                              }</p>
                              <div class="assessment-options text-sm space-y-2">
                                   <label class="radio-label mb-0"><input type="radio" name="dass-q${i}" value="0"> Did not apply to me at all</label>
                                   <label class="radio-label mb-0"><input type="radio" name="dass-q${i}" value="1"> Applied to me to some degree</label>
                                   <label class="radio-label mb-0"><input type="radio" name="dass-q${i}" value="2"> Applied to me to a considerable degree</label>
                                   <label class="radio-label mb-0"><input type="radio" name="dass-q${i}" value="3"> Applied to me very much</label>
                              </div>
                         </div>`
                            )
                            .join("")}
                     </div>
                `,
        },
      };

      function calculateCurrentScore(template) {
        let score = 0;
        if (!modalBody) return 0;

        if (template.type === "custom-score") {
          modalBody
            .querySelectorAll("[data-score]:checked")
            .forEach((checkbox) => {
              score += parseInt(checkbox.dataset.score) || 0;
            });
          modalBody.querySelectorAll("[data-score-input]").forEach((input) => {
            score += parseInt(input.value) || 0;
          });
        } else if (
          template.type === "radio-sum" ||
          template.type === "dass-score"
        ) {
          modalBody
            .querySelectorAll('input[type="radio"]:checked')
            .forEach((radio) => {
              score += parseInt(radio.value) || 0;
            });
        } else if (template.type === "gds-score") {
          modalBody
            .querySelectorAll(".assessment-options")
            .forEach((optionSet) => {
              const depressiveAnswer = optionSet.dataset.depressiveAnswer;
              const selectedRadio = optionSet.querySelector(
                'input[type="radio"]:checked'
              );
              if (selectedRadio && selectedRadio.value === depressiveAnswer) {
                score++;
              }
            });
        }
        return score;
      }

      function generateAssessmentTextReport(template) {
        let report = "";
        const modal = document.getElementById("assessment-modal");
        if (!modal) return "";

        const formContainer = template.title.includes("MMSE")
          ? modal.querySelector("#mmse-main-form")
          : modal.querySelector("#assessment-form-content");

        formContainer
          .querySelectorAll(".task-group, .assessment-question")
          .forEach((group) => {
            const titleEl = group.querySelector("h4, p.font-medium");
            if (titleEl) {
              const titleText = titleEl.textContent.trim();
              if (titleText) {
                report += `${titleText}\n`;
                report += "-".repeat(titleText.length) + "\n";
              }
            }

            const instructionEl = group.querySelector("p.text-sm");
            if (instructionEl) {
              report += `  Instruction: ${instructionEl.textContent.trim()}\n`;
            }

            group
              .querySelectorAll('input[type="checkbox"], input[type="radio"]')
              .forEach((input) => {
                const label = input.closest("label");
                if (label) {
                  const symbol = input.checked ? "[X]" : "[ ]";
                  report += `  ${symbol} ${label.textContent.trim()}\n`;
                }
              });

            group
              .querySelectorAll('input[type="number"], input[type="text"]')
              .forEach((input) => {
                if (input.value) {
                  report += `  - Response: ${input.value}\n`;
                }
              });
            report += "\n";
          });
        return report;
      }

      function handleFinalise(template, targetInputId) {
        try {
          let finalScore = calculateCurrentScore(template);
          const targetInput = document.getElementById(targetInputId);
          const interpretationBox = targetInput.parentElement.querySelector(
            ".interpretation-box"
          );

          if (!targetInput) {
            console.error("Target input not found:", targetInputId);
            return;
          }

          const reportText = generateAssessmentTextReport(template);
          completedAssessments.push({
            title: template.title,
            text: reportText,
          });

          targetInput.removeAttribute("data-dass-d");
          targetInput.removeAttribute("data-dass-a");
          targetInput.removeAttribute("data-dass-s");

          if (template.type === "dass-score") {
            let depressionScore = 0,
              anxietyScore = 0,
              stressScore = 0;
            modalBody.querySelectorAll(".assessment-question").forEach((q) => {
              const scale = q.dataset.scale;
              const checkedRadio = q.querySelector(
                'input[type="radio"]:checked'
              );
              if (checkedRadio) {
                const value = parseInt(checkedRadio.value) || 0;
                if (scale === "depression") depressionScore += value;
                else if (scale === "anxiety") anxietyScore += value;
                else if (scale === "stress") stressScore += value;
              }
            });

            const finalDepression = depressionScore * 2;
            const finalAnxiety = anxietyScore * 2;
            const finalStress = stressScore * 2;

            const dassResultsEl = document.getElementById("dass-results");
            if (dassResultsEl) {
              dassResultsEl.innerHTML = `
                            <span class="mr-4">Depression: <b>${finalDepression}</b></span>
                            <span class="mr-4">Anxiety: <b>${finalAnxiety}</b></span>
                            <span>Stress: <b>${finalStress}</b></span>
                        `;
            }

            targetInput.setAttribute("data-dass-d", finalDepression);
            targetInput.setAttribute("data-dass-a", finalAnxiety);
            targetInput.setAttribute("data-dass-s", finalStress);

            targetInput.value = `D:${finalDepression}, A:${finalAnxiety}, S:${finalStress}`;
            if (interpretationBox && template.getInterpretation) {
              interpretationBox.textContent = template.getInterpretation({
                d: finalDepression,
                a: finalAnxiety,
                s: finalStress,
              });
              interpretationBox.classList.remove("hidden");
            }
            setTimeout(closeAssessmentModal, 4000);
          } else {
            targetInput.value = `${finalScore} / ${template.maxScore}`;
            if (interpretationBox && template.getInterpretation) {
              interpretationBox.textContent =
                template.getInterpretation(finalScore);
              interpretationBox.classList.remove("hidden");
            }
            closeAssessmentModal();
          }
          targetInput.dispatchEvent(new Event("change")); // Trigger plan update
        } catch (error) {
          console.error("Error during finalisation:", error);
          closeAssessmentModal();
        }
      }

      function openImagePopup(url) {
        window.open(
          url,
          "image-popup",
          "height=600,width=800,resizable=yes,scrollbars=yes"
        );
      }

      function openAssessmentModal(toolKey, targetInputId) {
        const template = assessmentTemplates[toolKey];
        if (!template) return;

        modalTitle.textContent = template.title;
        modalBody.innerHTML = template.html();

        let actionButtonsHtml = `
                <div id="dass-results" class="text-sm font-semibold"></div>
                <div class="flex space-x-4 ml-auto">
                    <button id="print-assessment-btn" class="bg-gray-500 text-white font-bold py-2 px-5 rounded-lg hover:bg-gray-600">Print Form</button>
                    <button id="modal-action-btn" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-blue-700">
                        ${toolKey === "MMSE" ? "Next" : "Finalise & Close"}
                    </button>
                </div>
            `;
        modalFooter.innerHTML = actionButtonsHtml;

        assessmentModal.classList.remove("hidden");

        const updateScore = () => {
          const currentScore = calculateCurrentScore(template);
          modalScoreDisplay.textContent = `Score: ${currentScore}`;
        };

        modalBody.addEventListener("change", updateScore);
        updateScore();

        if (toolKey === "MoCA") {
          setupTrailMaking();
        }

        const modalActionBtn = document.getElementById("modal-action-btn");

        const finaliseListener = () => handleFinalise(template, targetInputId);

        if (toolKey === "MMSE") {
          const handleMmseNext = () => {
            document.getElementById("mmse-main-form").classList.add("hidden");
            document
              .getElementById("mmse-close-eyes-page")
              .classList.remove("hidden");
            modalActionBtn.textContent = "Finalise & Close";
            modalActionBtn.removeEventListener("click", handleMmseNext);
            modalActionBtn.addEventListener("click", finaliseListener);
          };
          modalActionBtn.addEventListener("click", handleMmseNext);
        } else {
          modalActionBtn.addEventListener("click", finaliseListener);
        }

        document
          .getElementById("print-assessment-btn")
          .addEventListener("click", () => {
            printAssessmentForm(template.title);
          });
      }

      function setupTrailMaking() {
        const svg = document.getElementById("trail-making-svg");
        if (!svg) return;

        const points = [
          { x: 20, y: 20, label: "1", id: "1" },
          { x: 100, y: 30, label: "A", id: "A" },
          { x: 150, y: 20, label: "2", id: "2" },
          { x: 40, y: 70, label: "B", id: "B" },
          { x: 180, y: 70, label: "3", id: "3" },
          { x: 120, y: 100, label: "C", id: "C" },
          { x: 20, y: 100, label: "4", id: "4" },
          { x: 70, y: 50, label: "D", id: "D" },
          { x: 160, y: 90, label: "5", id: "5" },
          { x: 80, y: 80, label: "E", id: "E" },
        ];

        let path = [];

        points.forEach((p) => {
          const group = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "g"
          );
          group.classList.add("trail-making-node");
          group.setAttribute("id", `node-${p.id}`);

          const circle = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "circle"
          );
          circle.setAttribute("cx", p.x);
          circle.setAttribute("cy", p.y);
          circle.setAttribute("r", 12);
          circle.setAttribute("stroke", "black");
          circle.setAttribute("fill", "white");

          const text = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "text"
          );
          text.setAttribute("x", p.x);
          text.setAttribute("y", p.y + 4);
          text.setAttribute("text-anchor", "middle");
          text.textContent = p.label;

          group.appendChild(circle);
          group.appendChild(text);
          svg.appendChild(group);

          group.addEventListener("click", () => {
            if (!path.find((pt) => pt.id === p.id)) {
              path.push(p);
              group.classList.add("clicked");
              drawLines();
            }
          });
        });

        const lineGroup = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "g"
        );
        lineGroup.setAttribute("id", "trail-lines");
        svg.prepend(lineGroup);

        function drawLines() {
          lineGroup.innerHTML = "";
          for (let i = 0; i < path.length - 1; i++) {
            const line = document.createElementNS(
              "http://www.w3.org/2000/svg",
              "line"
            );
            line.setAttribute("x1", path[i].x);
            line.setAttribute("y1", path[i].y);
            line.setAttribute("x2", path[i + 1].x);
            line.setAttribute("y2", path[i + 1].y);
            line.setAttribute("stroke", "#2563eb");
            line.setAttribute("stroke-width", "2");
            lineGroup.appendChild(line);
          }
        }

        document
          .getElementById("reset-trails-btn")
          .addEventListener("click", () => {
            path = [];
            lineGroup.innerHTML = "";
            svg
              .querySelectorAll(".trail-making-node")
              .forEach((n) => n.classList.remove("clicked"));
          });
      }

      function printAssessmentForm(title) {
        const printWindow = window.open("", "", "height=800,width=800");
        printWindow.document.write(
          "<html><head><title>Print Assessment</title>"
        );
        // Basic print styling
        printWindow.document.write(`
                <style>
                    body { font-family: sans-serif; line-height: 1.5; }
                    h2 { font-size: 1.5rem; margin-bottom: 1rem; }
                    .task-group, .assessment-question { 
                        border: 1px solid #ccc; 
                        border-radius: 8px; 
                        padding: 15px; 
                        margin-bottom: 15px; 
                        page-break-inside: avoid;
                    }
                    h4 { font-size: 1.1rem; margin-top: 0; }
                    svg, img { max-width: 200px; }
                    input[type=checkbox], input[type=radio] { margin-right: 5px; }
                    input[type=number] { 
                        border: 1px solid #ccc; 
                        border-radius: 4px; 
                        padding: 4px; 
                        width: 60px;
                    }
                    label { display: block; margin-bottom: 5px; }
                    .assessment-options label { display: inline-block; margin-right: 15px; }
                </style>
            `);
        printWindow.document.write("</head><body>");
        printWindow.document.write(`<h2>${title}</h2>`);
        printWindow.document.write(modalBody.innerHTML);
        printWindow.document.write("</body></html>");
        printWindow.document.close();
        printWindow.focus();
        setTimeout(() => {
          printWindow.print();
          printWindow.close();
        }, 250);
      }

      function closeAssessmentModal() {
        assessmentModal.classList.add("hidden");
        modalBody.innerHTML = "";
        modalFooter.innerHTML = "";
      }

      modalCloseBtn.addEventListener("click", closeAssessmentModal);
      assessmentModal.addEventListener("click", (e) => {
        if (e.target === assessmentModal) {
          closeAssessmentModal();
        }
      });

      // --- LOCAL STORAGE FUNCTIONS ---
      function saveFormToLocalStorage() {
        const formData = {};
        const formElements = formContainer.querySelectorAll(
          "input, textarea, select"
        );
        formElements.forEach((el) => {
          if (el.id) {
            if (el.type === "checkbox" || el.type === "radio") {
              formData[el.id] = el.checked;
            } else {
              formData[el.id] = el.value;
            }
          } else if (el.name && el.type === "radio" && el.checked) {
            formData[el.name] = el.value;
          }
        });
        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(formData));
      }

      function populateFormFromData(formData) {
        const formElements = formContainer.querySelectorAll(
          "input, textarea, select"
        );
        formElements.forEach((el) => {
          if (el.id && formData[el.id] !== undefined) {
            if (el.type === "checkbox" || el.type === "radio") {
              el.checked = formData[el.id];
            } else {
              el.value = formData[el.id];
            }
          } else if (
            el.name &&
            el.type === "radio" &&
            formData[el.name] !== undefined
          ) {
            if (el.value === formData[el.name]) {
              el.checked = true;
            }
          }
        });

        // Manually trigger UI updates after loading data
        document
          .querySelectorAll(
            'input[type="checkbox"], input[type="radio"], select'
          )
          .forEach((el) => {
            el.dispatchEvent(new Event("change", { bubbles: true }));
          });

        calculateAndDisplayAge();
        calculateBmi();
        updateManagementPlan();
      }

      function checkAndPromptForRestore() {
        const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
        if (savedData) {
          const restoreModal = document.getElementById("restore-session-modal");
          restoreModal.classList.remove("hidden");

          document.getElementById("restore-session-btn").onclick = () => {
            initializeForm();
            const formData = JSON.parse(savedData);
            populateFormFromData(formData);
            restoreModal.classList.add("hidden");
          };

          document.getElementById("start-fresh-btn").onclick = () => {
            localStorage.removeItem(LOCAL_STORAGE_KEY);
            initializeForm();
            restoreModal.classList.add("hidden");
          };
        } else {
          // If no data, just load a blank form
          initializeForm();
        }
      }

      // --- Initial Load ---
      document.addEventListener("DOMContentLoaded", checkAndPromptForRestore);
    </script>
  </body>
</html>
