<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Health Assessment for People with an Intellectual Disability</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-61RLS51ZH5"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      // هر دو property را مقداردهی میکنیم
      gtag("config", "G-61RLS51ZH5");
      gtag("config", "G-XMPYXRQRH0");
    </script>

    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f3f4f6; /* bg-gray-100 */
      }
      .chevron-icon {
        transition: transform 0.3s ease-in-out;
      }
      .chevron-icon.rotated {
        transform: rotate(180deg);
      }
      .form-section-content.collapsed {
        max-height: 0;
        padding-top: 0;
        padding-bottom: 0;
        opacity: 0;
        overflow: hidden;
        transition: max-height 0.5s ease-in-out, opacity 0.3s ease-in-out,
          padding 0.5s ease-in-out;
      }
      .form-section-content {
        transition: max-height 0.5s ease-in-out, opacity 0.3s ease-in-out;
        max-height: 8000px; /* A large value to allow for content */
        opacity: 1;
      }
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }
      .modal-content {
        background-color: white;
        padding: 2rem;
        border-radius: 0.75rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        width: 90%;
        max-width: 800px;
        max-height: 90vh;
        overflow-y: auto;
        position: relative;
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #e2e8f0;
      }
      .modal-close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #6b7280;
      }
      .details-container {
        padding-left: 1.85rem;
        margin-top: 0.5rem;
        margin-bottom: 0.75rem;
      }
      .subsection-title {
        font-weight: 600;
        margin-top: 1.25rem;
        margin-bottom: 0.75rem;
        color: #334155;
        font-size: 1.1rem;
        border-bottom: 1px solid #e2e8f0;
        padding-bottom: 0.5rem;
      }
      .score-display {
        font-size: 1.25rem;
        font-weight: 700;
        color: #166534;
        background-color: #f0fdf4;
        padding: 0.5rem 1rem;
        border-radius: 9999px;
      }
      .assessment-question {
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #e5e7eb;
      }
      .assessment-question:last-child {
        border-bottom: none;
      }
      .age-display-container {
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        height: 100%;
      }
      .age-display {
        padding: 0.75rem;
        background-color: #f1f5f9;
        border-radius: 0.375rem;
        text-align: center;
        font-weight: 500;
        min-height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .input-field {
        display: block;
        width: 100%;
        padding: 0.5rem 0.75rem;
        background-color: #f8fafc;
        border: 1px solid #cbd5e1;
        border-radius: 0.375rem;
        box-shadow: inset 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      }
      .task-group {
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1rem;
        background-color: #fdfdff;
      }
      .task-group h4 {
        font-weight: 600;
        margin-bottom: 0.75rem;
        color: #334155;
        border-bottom: 1px solid #e2e8f0;
        padding-bottom: 0.5rem;
      }
      .trail-making-node {
        cursor: pointer;
        transition: all 0.2s;
      }
      .trail-making-node:hover circle {
        fill: #dbeafe;
      }
      .trail-making-node.clicked circle {
        fill: #93c5fd;
        stroke: #2563eb;
      }
      .checkbox-label,
      .radio-label {
        display: flex;
        align-items: center;
        margin-bottom: 0.75rem;
        font-size: 0.95rem;
      }
      .checkbox-label input,
      .radio-label input {
        margin-right: 0.75rem;
        height: 1.1rem;
        width: 1.1rem;
        flex-shrink: 0;
      }
      .interpretation-box {
        font-size: 0.8rem;
        padding: 0.5rem;
        margin-top: 0.25rem;
        border-radius: 0.25rem;
        background-color: #fefce8; /* yellow-50 */
        color: #a16207; /* yellow-700 */
        border: 1px solid #fde047; /* yellow-400 */
      }
      .nested-details {
        padding-left: 1.85rem;
        border-left: 2px solid #f1f5f9;
        margin-left: 0.5rem;
        margin-top: 0.5rem;
      }
      .info-message {
        font-size: 0.875rem;
        color: #1d4ed8;
        background-color: #eff6ff;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        margin-top: 0.5rem;
      }
      .bmi-display {
        padding: 0.75rem;
        background-color: #f1f5f9;
        border-radius: 0.375rem;
        text-align: center;
        font-weight: 500;
        min-height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .bmi-interpretation {
        font-size: 0.8rem;
        text-align: center;
        margin-top: 0.25rem;
        min-height: 1.2rem;
        font-weight: 500;
      }
      .question-block {
        margin-bottom: 1rem;
      }
    </style>
  </head>
  <body class="text-gray-800">
    <nav
      class="bg-white border-b border-indigo-100 sticky top-0 z-50 shadow-sm"
    >
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-20">
          <!-- logo + title -->
          <a href="/" class="flex items-center space-x-3">
            <img
              src="/images/gp-companion-logo.png"
              alt="GP Companion Logo"
              width="80"
              height="80"
              class="w-20 h-20"
            />
            <span class="font-bold text-xl text-indigo-800">GP Companion</span>
          </a>

          <!-- desktop links -->
          <div id="desktopMenu" class="hidden md:flex items-center space-x-4">
            <a
              href="/"
              class="text-indigo-700 hover:text-indigo-900 transition-colors px-3 py-2 text-sm font-medium"
              >Home</a
            >
            <a
              href="/gpccmp"
              class="text-indigo-700 hover:text-indigo-900 transition-colors px-3 py-2 text-sm font-medium"
              >GPCCMP</a
            >
            <a
              href="/HealthAssessments"
              class="text-indigo-700 hover:text-indigo-900 transition-colors px-3 py-2 text-sm font-medium"
              >Assessments</a
            >
            <a
              href="/about"
              class="text-indigo-600 hover:text-indigo-800 transition-colors px-3 py-2 text-sm"
              >About</a
            >
            <a
              href="/developer"
              class="text-indigo-600 hover:text-indigo-800 transition-colors px-3 py-2 text-sm"
              >Developer</a
            >
            <a
              href="/privacy"
              class="text-indigo-600 hover:text-indigo-800 transition-colors px-3 py-2 text-sm"
              >Privacy</a
            >
            <a
              href="/contact"
              class="text-indigo-600 hover:text-indigo-800 transition-colors px-3 py-2 text-sm"
              >Contact</a
            >
          </div>

          <!-- mobile button -->
          <div class="md:hidden">
            <button
              id="mobileMenuButton"
              aria-expanded="false"
              aria-controls="mobileMenu"
              class="inline-flex items-center justify-center p-2 rounded-md text-indigo-700 hover:text-indigo-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
            >
              <span class="sr-only">Open menu</span>
              <!-- bars icon -->
              <svg
                id="menuOpenIcon"
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 6h16M4 12h16M4 18h16"
                />
              </svg>
              <!-- close icon (hidden by default) -->
              <svg
                id="menuCloseIcon"
                class="h-6 w-6 hidden"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>
        </div>
      </div>

      <!-- mobile menu (hidden by default) -->
      <div id="mobileMenu" class="md:hidden hidden border-t border-indigo-100">
        <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
          <a
            href="/"
            class="block px-3 py-2 rounded-md text-base font-medium text-indigo-700 hover:text-indigo-900"
            >Home</a
          >
          <a
            href="/gpccmp"
            class="block px-3 py-2 rounded-md text-base font-medium text-indigo-700 hover:text-indigo-900"
            >GPCCMP</a
          >
          <a
            href="/HealthAssessments"
            class="block px-3 py-2 rounded-md text-base font-medium text-indigo-700 hover:text-indigo-900"
            >Assessments</a
          >
          <a
            href="/about"
            class="block px-3 py-2 rounded-md text-base text-indigo-600 hover:text-indigo-800"
            >About</a
          >
          <a
            href="/developer"
            class="block px-3 py-2 rounded-md text-base text-indigo-600 hover:text-indigo-800"
            >Developer</a
          >
          <a
            href="/privacy"
            class="block px-3 py-2 rounded-md text-base text-indigo-600 hover:text-indigo-800"
            >Privacy</a
          >
          <a
            href="/contact"
            class="block px-3 py-2 rounded-md text-base text-indigo-600 hover:text-indigo-800"
            >Contact</a
          >
        </div>
      </div>
    </nav>
    <div class="container mx-auto p-4 sm:p-6 lg:p-8 mt-12">
      <header class="text-center mb-10">
        <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">
          Health Assessment for People with an Intellectual Disability
        </h1>
        <p class="text-md text-gray-600 mt-2">GP Health Assessment Tool</p>
        <p class="text-sm text-gray-700 mt-4 font-semibold">
          Developed by Dr Bobby Tork MD, FRACGP-RG
        </p>
        <p class="text-xs text-gray-500 mt-1">&copy; 2025 Dr Bobby Tork</p>
      </header>

      <div class="max-w-4xl mx-auto">
        <!-- Dynamic Form Content -->
        <div id="form-container"></div>

        <!-- Action Buttons -->
        <div id="action-buttons" class="mt-8 flex justify-end space-x-4 hidden">
          <button
            id="clear-form-btn"
            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-gray-600 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500"
          >
            Clear Form
          </button>
          <button
            id="save-txt-btn"
            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
          >
            Save as .txt
          </button>
          <button
            id="save-rtf-btn"
            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
          >
            Save as .rtf
          </button>
        </div>

        <!-- Report Output -->
        <div id="report-container" class="mt-10 hidden">
          <div
            class="mb-10 border border-gray-200 rounded-xl shadow-lg overflow-hidden"
          >
            <div class="p-6 bg-white">
              <h2 class="text-2xl font-bold text-gray-800 mb-4">
                Generated Assessment Report
              </h2>
              <pre
                id="report-output"
                class="p-4 bg-gray-50 rounded-lg whitespace-pre-wrap font-mono text-sm"
              ></pre>
              <div class="mt-6 flex justify-end space-x-4">
                <button
                  id="copy-report-btn"
                  class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700"
                >
                  Copy to Clipboard
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modals -->
    <div id="easter-egg-modal" class="modal-overlay hidden">
      <div class="modal-content text-center">
        <p class="font-semibold">Developed by Dr Bobby Tork MD, FRACGP-RG</p>
        <p class="text-sm">&copy; 2025 Dr Bobby Tork</p>
        <button
          id="close-easter-egg"
          class="mt-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700"
        >
          Close
        </button>
      </div>
    </div>
    <div id="clear-confirm-modal" class="modal-overlay hidden">
      <div class="modal-content">
        <h3 class="text-lg font-bold mb-2">Are you sure?</h3>
        <p class="text-gray-600 mb-4">
          All entered data will be lost. This action cannot be undone.
        </p>
        <div class="flex justify-center space-x-4">
          <button
            id="cancel-clear-btn"
            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-gray-700 bg-gray-200 hover:bg-gray-300"
          >
            Cancel
          </button>
          <button
            id="confirm-clear-btn"
            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700"
          >
            Clear Form
          </button>
        </div>
      </div>
    </div>
    <div id="assessment-modal" class="modal-overlay hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modal-title" class="text-2xl font-bold">Assessment</h2>
          <div id="modal-score-display" class="score-display">Score: 0</div>
          <button id="modal-close-btn" class="modal-close-btn">&times;</button>
        </div>
        <div id="modal-body"></div>
        <div
          id="modal-footer"
          class="mt-6 flex justify-between items-center"
        ></div>
      </div>
    </div>
    <!-- Restore Session Modal -->
    <div id="restore-session-modal" class="modal-overlay hidden">
      <div class="modal-content">
        <h3 class="text-lg font-bold mb-2">Restore Previous Session?</h3>
        <p class="text-gray-600 mb-4">
          We found saved data from a previous session. Would you like to restore
          it?
        </p>
        <div class="flex justify-center space-x-4">
          <button
            id="start-fresh-btn"
            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-gray-700 bg-gray-200 hover:bg-gray-300"
          >
            Start Fresh
          </button>
          <button
            id="restore-session-btn"
            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700"
          >
            Restore Session
          </button>
        </div>
      </div>
    </div>
    <footer
      class="bg-indigo-950 text-indigo-100 border-t border-indigo-800 mt-auto"
    >
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
          <div class="col-span-1 md:col-span-2">
            <div class="flex items-center space-x-3 mb-4">
              <div
                class="w-9 h-9 bg-indigo-600 rounded-lg flex items-center justify-center shadow-sm"
              >
                <span class="text-white font-bold text-lg">GP</span>
              </div>
              <span class="font-bold text-xl text-white">GP Companion</span>
            </div>
            <p class="text-indigo-200 text-sm max-w-md">
              Comprehensive medical tools and health assessments designed for
              healthcare professionals. Streamline your workflow with our
              secure, privacy-focused platform.
            </p>
          </div>

          <div>
            <h3 class="font-semibold text-white mb-4">Quick Links</h3>
            <ul class="space-y-2">
              <li>
                <a
                  href="/about"
                  class="text-indigo-200 hover:text-white transition-colors text-sm block"
                >
                  About Website
                </a>
              </li>
              <li>
                <a
                  href="/developer"
                  class="text-indigo-200 hover:text-white transition-colors text-sm block"
                >
                  Developer
                </a>
              </li>
              <li>
                <a
                  href="/privacy"
                  class="text-indigo-200 hover:text-white transition-colors text-sm block"
                >
                  Privacy Policy
                </a>
              </li>
              <li>
                <a
                  href="/contact"
                  class="text-indigo-200 hover:text-white transition-colors text-sm block"
                >
                  Contact Developer
                </a>
              </li>
            </ul>
          </div>

          <div>
            <h3 class="font-semibold text-white mb-4">Tools</h3>
            <ul class="space-y-2">
              <li>
                <a
                  href="/gpccmp"
                  class="text-indigo-200 hover:text-white transition-colors text-sm block"
                >
                  GPCCMP Tool
                </a>
              </li>
              <li>
                <a
                  href="/HealthAssessments"
                  class="text-indigo-200 hover:text-white transition-colors text-sm block"
                >
                  Health Assessments
                </a>
              </li>
              <li>
                <a
                  href="/HealthAssessments"
                  class="text-indigo-200 hover:text-white transition-colors text-sm block"
                >
                  75+ Health Assessment
                </a>
              </li>
              <li>
                <a
                  href="/HealthAssessments"
                  class="text-indigo-200 hover:text-white transition-colors text-sm block"
                >
                  ATSI Health Assessment
                </a>
              </li>
            </ul>
          </div>
        </div>

        <div class="border-t border-indigo-800 mt-8 pt-8 text-center">
          <p class="text-indigo-300 text-sm">
            © 2024 GP Companion. All rights reserved. Designed for healthcare
            professionals.
          </p>
        </div>
      </div>
    </footer>

    <script>
      // --- Globals ---
      const localStorageKey = "healthAssessmentFormData";
      let userTypedPlan = "";
      let lastCompletedAssessment = { text: "", title: "" };

      // --- DOM Element References ---
      const formContainer = document.getElementById("form-container");
      const saveTxtBtn = document.getElementById("save-txt-btn");
      const saveRtfBtn = document.getElementById("save-rtf-btn");
      const clearFormBtn = document.getElementById("clear-form-btn");
      const actionButtons = document.getElementById("action-buttons");
      const reportContainer = document.getElementById("report-container");
      const reportOutput = document.getElementById("report-output");
      const copyReportBtn = document.getElementById("copy-report-btn");
      const assessmentModal = document.getElementById("assessment-modal");
      const modalTitle = document.getElementById("modal-title");
      const modalBody = document.getElementById("modal-body");
      const modalFooter = document.getElementById("modal-footer");
      const modalCloseBtn = document.getElementById("modal-close-btn");
      const modalScoreDisplay = document.getElementById("modal-score-display");

      // --- Reusable HTML Templates ---
      const getChevronIcon = () =>
        `<svg class="chevron-icon w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>`;
      const getCheckboxWithDetails = (id, label, placeholder = "Details...") =>
        `<label class="checkbox-label"><input type="checkbox" id="${id}-checkbox"> ${label}</label><div id="${id}-details-container" class="details-container hidden"><textarea id="${id}-details" class="input-field" placeholder="${placeholder}"></textarea></div>`;

      const getMbsSelectionHtml = () => `
            <div class="mb-10 border border-gray-200 rounded-xl shadow-lg overflow-hidden">
                <div class="text-xl font-bold text-white bg-indigo-700 px-6 py-3 flex justify-between items-center cursor-pointer"><h2 class="form-section-title">MBS Item Number</h2>${getChevronIcon()}</div>
                <div class="p-6 bg-white form-section-content">
                    <label class="block text-lg font-medium text-gray-700 mb-3">Select the appropriate MBS item number based on consultation time:</label>
                    <div class="space-y-3">
                        <label class="flex items-center"><input type="radio" name="mbs-item" value="701" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded mr-3"> <b>Item 701</b> - Brief health assessment lasting no more than 30 minutes</label>
                        <label class="flex items-center"><input type="radio" name="mbs-item" value="703" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded mr-3"> <b>Item 703</b> - Standard health assessment lasting at least 30 minutes and less than 45 minutes</label>
                        <label class="flex items-center"><input type="radio" name="mbs-item" value="705" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded mr-3"> <b>Item 705</b> - Long health assessment lasting at least 45 minutes and less than 60 minutes</label>
                        <label class="flex items-center"><input type="radio" name="mbs-item" value="707" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded mr-3"> <b>Item 707</b> - Prolonged health assessment lasting more than 60 minutes</label>
                    </div>
                    <div class="mt-4 p-3 bg-indigo-50 rounded-lg text-sm text-indigo-800">This health assessment is available annually to an eligible patient.</div>
                </div>
            </div>
        `;

      const getPatientDetailsHtml = () => {
        const today = new Date().toISOString().slice(0, 10);
        return `
            <div class="mb-10 border border-gray-200 rounded-xl shadow-lg overflow-hidden">
                <div class="text-xl font-bold text-white bg-indigo-700 px-6 py-3 flex justify-between items-center cursor-pointer"><h2 class="form-section-title">Patient Details</h2>${getChevronIcon()}</div>
                <div class="p-6 bg-white form-section-content">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 items-start">
                        <div><label for="patient-name" class="block text-sm font-medium text-gray-700 mb-1">Name: <span class="text-gray-400 font-normal">(optional)</span></label><input type="text" id="patient-name" class="input-field"></div>
                        <div><label for="assessment-date" class="block text-sm font-medium text-gray-700 mb-1">Assessment Date:</label><input type="date" id="assessment-date" class="input-field" value="${today}"></div>
                        <div><label for="patient-dob" class="block text-sm font-medium text-gray-700 mb-1">DOB:</label><input type="date" id="patient-dob" class="input-field"></div>
                        <div class="age-display-container">
                            <div id="patient-age-display" class="age-display">Age will be calculated</div>
                        </div>
                        <div><label for="patient-medicare" class="block text-sm font-medium text-gray-700 mb-1">Medicare No: <span class="text-gray-400 font-normal">(optional)</span></label><input type="text" id="patient-medicare" class="input-field"></div>
                        <div>
                            <label for="patient-gender" class="block text-sm font-medium text-gray-700 mb-1">Gender:</label>
                            <select id="patient-gender" class="input-field">
                                <option value="">Select Gender</option><option value="male">Male</option><option value="female">Female</option>
                            </select>
                        </div>
                        <div class="sm:col-span-2">
                            <label class="flex items-center"><input type="checkbox" id="atsi-origin" class="h-4 w-4 text-indigo-600 mr-2"> Aboriginal and/or Torres Strait Islander origin</label>
                        </div>
                    </div>
                </div>
            </div>`;
      };

      const getPsychologicalSocialHtml = () => `
            <div class="mb-10 border border-gray-200 rounded-xl shadow-lg overflow-hidden">
                <div class="text-xl font-bold text-white bg-indigo-700 px-6 py-3 flex justify-between items-center cursor-pointer"><h2 class="form-section-title">Psychological & Social Function</h2>${getChevronIcon()}</div>
                <div class="p-6 bg-white form-section-content">
                    <h3 class="subsection-title">Psychological Function</h3>
                    <div class="mb-4">
                        <label class="flex items-center"><input type="checkbox" id="cognition-assessed-checkbox" class="h-4 w-4 text-indigo-600 mr-2"> Cognition assessed</label>
                        <div id="cognition-assessed-details-container" class="details-container hidden">
                            <div class="grid grid-cols-2 gap-4 items-start">
                                <select id="cognition-tool" class="input-field">
                                    <option value="">Select Tool...</option>
                                    <option value="MMSE">MMSE</option>
                                    <option value="MoCA">MoCA</option>
                                </select>
                                <div>
                                    <input type="text" id="cognition-score" class="input-field" placeholder="Score">
                                    <a href="#" id="cognition-link" class="text-blue-600 hover:underline text-sm mt-1 block text-right hidden">Complete Assessment</a>
                                    <div id="cognition-interpretation" class="interpretation-box hidden mt-2"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="flex items-center"><input type="checkbox" id="mood-assessed-checkbox" class="h-4 w-4 text-indigo-600 mr-2"> Mood assessed</label>
                        <div id="mood-assessed-details-container" class="details-container hidden">
                            <div class="grid grid-cols-2 gap-4 items-start">
                                <select id="mood-tool" class="input-field">
                                    <option value="">Select Tool...</option>
                                    <option value="K10">K10</option>
                                    <option value="GDS">GDS</option>
                                    <option value="DASS21">DASS-21</option>
                                </select>
                                <div>
                                    <input type="text" id="mood-score" class="input-field" placeholder="Score">
                                    <a href="#" id="mood-link" class="text-blue-600 hover:underline text-sm mt-1 block text-right hidden">Complete Assessment</a>
                                    <div id="mood-interpretation" class="interpretation-box hidden mt-2"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <h3 class="subsection-title">Social & Personal</h3>
                    <div class="mb-4">
                        <label class="checkbox-label"><input type="checkbox" id="sexual-health-review-checkbox"> Sexual development and health reviewed.</label>
                        <div id="sexual-health-review-details-container" class="details-container hidden">
                            <p class="font-medium mb-2">Were any issues identified?</p>
                            <div class="flex flex-wrap gap-x-4"><label class="radio-label"><input type="radio" name="sexual-health-issues" value="yes"> Yes</label><label class="radio-label"><input type="radio" name="sexual-health-issues" value="no"> No</label></div>
                            <div id="sexual-health-issues-details" class="nested-details hidden"><textarea id="sexual-health-issues-details-text" class="input-field" placeholder="Details of sexual health issues..."></textarea></div>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="checkbox-label"><input type="checkbox" id="safety-wellbeing-checkbox"> Safety & Wellbeing Assessed.</label>
                        <div id="safety-wellbeing-details-container" class="details-container hidden">
                            <p class="font-medium mb-2">Were any issues identified?</p>
                            <div class="flex flex-wrap gap-x-4"><label class="radio-label"><input type="radio" name="safety-issues" value="yes"> Yes</label><label class="radio-label"><input type="radio" name="safety-issues" value="no"> No</label></div>
                            <div id="safety-issues-details" class="nested-details hidden"><textarea id="safety-issues-details-text" class="input-field" placeholder="Details of safety/wellbeing issues..."></textarea></div>
                        </div>
                    </div>
                     <div class="question-block">
                        <span class="font-medium">Does the patient often feel lonely or isolated?</span>
                         <div class="flex space-x-4 mt-1">
                             <label class="flex items-center"><input type="radio" name="social-isolation" value="yes" class="mr-2"> Yes</label>
                             <label class="flex items-center"><input type="radio" name="social-isolation" value="no" class="mr-2"> No</label>
                         </div>
                         <div id="social-isolation-details-container" class="details-container hidden">
                             <textarea id="social-isolation-details" class="input-field" placeholder="Details..."></textarea>
                         </div>
                    </div>
                </div>
            </div>`;

      const getSnapHtml = () => `
            <div class="mb-10 border border-gray-200 rounded-xl shadow-lg overflow-hidden">
                <div class="text-xl font-bold text-white bg-indigo-700 px-6 py-3 flex justify-between items-center cursor-pointer"><h2 class="form-section-title">SNAP & Other Risks</h2>${getChevronIcon()}</div>
                <div class="p-6 bg-white form-section-content">
                    <div class="space-y-4">
                        <!-- Smoking -->
                        <div class="snap-item">
                            <div class="flex items-center">
                                <input type="checkbox" id="assess-smoking-checkbox" class="h-4 w-4 text-indigo-600 mr-3">
                                <label for="assess-smoking-checkbox" class="font-semibold text-gray-800">S - Smoking Status</label>
                            </div>
                            <div id="assess-smoking-details-container" class="details-container hidden">
                                <select id="smoking-status" class="input-field">
                                    <option value="">Select status...</option>
                                    <option value="current">Current Smoker</option>
                                    <option value="ex">Ex-smoker</option>
                                    <option value="non">Non-smoker</option>
                                </select>
                            </div>
                        </div>
                        <!-- Nutrition -->
                        <div class="snap-item">
                            <div class="flex items-center">
                                <input type="checkbox" id="assess-nutrition-checkbox" class="h-4 w-4 text-indigo-600 mr-3">
                                <label for="assess-nutrition-checkbox" class="font-semibold text-gray-800">N - Nutrition</label>
                            </div>
                            <div id="assess-nutrition-details-container" class="details-container hidden">
                                <select id="nutrition-status" class="input-field">
                                    <option value="">Select diet type...</option>
                                    <option value="adequate">Adequate</option>
                                    <option value="inadequate">Inadequate</option>
                                </select>
                                <textarea id="nutrition-details" class="input-field mt-2" placeholder="Details of nutrition assessment..."></textarea>
                            </div>
                        </div>
                        <!-- Alcohol -->
                        <div class="snap-item">
                            <div class="flex items-center">
                                <input type="checkbox" id="assess-alcohol-checkbox" class="h-4 w-4 text-indigo-600 mr-3">
                                <label for="assess-alcohol-checkbox" class="font-semibold text-gray-800">A - Alcohol</label>
                            </div>
                            <div id="assess-alcohol-details-container" class="details-container hidden">
                                <div class="flex items-center space-x-2">
                                    <input type="number" id="alcohol-drinks" class="input-field w-1/2" placeholder="Std drinks">
                                    <select id="alcohol-period" class="input-field w-1/2">
                                        <option value="week">per week</option>
                                        <option value="day">per day</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <!-- Physical Activity -->
                        <div class="snap-item">
                            <div class="flex items-center">
                                <input type="checkbox" id="assess-activity-checkbox" class="h-4 w-4 text-indigo-600 mr-3">
                                <label for="assess-activity-checkbox" class="font-semibold text-gray-800">P - Physical Activity</label>
                            </div>
                            <div id="assess-activity-details-container" class="details-container hidden">
                                <div class="flex items-center space-x-2">
                                    <input type="number" id="activity-minutes" class="input-field" placeholder="Minutes of exercise">
                                    <span class="text-gray-600">per week</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <div class="question-block">
                             <span class="font-medium">Does the patient use any recreational drugs?</span>
                             <div class="flex space-x-4 mt-1">
                                 <label class="flex items-center"><input type="radio" name="drug-use" value="yes" class="mr-2"> Yes</label>
                                 <label class="flex items-center"><input type="radio" name="drug-use" value="no" class="mr-2"> No</label>
                             </div>
                             <div id="drug-use-details-container" class="details-container hidden">
                                 <textarea id="drug-use-details" class="input-field" placeholder="Details of drug use..."></textarea>
                             </div>
                        </div>
                    </div>
                </div>
            </div>`;

      const getPlanAndRecsHtml = () => {
        const screeningHtml = `
                  <h4 class="font-semibold text-gray-700 mt-4 mb-2">Screening</h4>
                  <div id="screening-container" class="pl-2">
                      <label class="checkbox-label hidden" id="rec-breast-screening-label"><input type="checkbox" id="rec-breast-screening" value="Breast screening recommended."> Breast screening</label>
                      <label class="checkbox-label hidden" id="rec-cst-label"><input type="checkbox" id="rec-cst" value="Cervical Screening Test (CST) recommended."> Cervical Screening Test (CST)</label>
                      <label class="checkbox-label hidden" id="rec-testicular-exam-label"><input type="checkbox" id="rec-testicular-exam" value="Testicular Examination recommended."> Testicular Examination</label>
                      <label class="checkbox-label hidden" id="rec-prostate-assessment-label"><input type="checkbox" id="rec-prostate-assessment" value="Prostate Assessment recommended."> Prostate Assessment</label>
                      <label class="checkbox-label hidden" id="rec-bowel-screening-label"><input type="checkbox" id="rec-bowel-screening" value="Bowel Screening recommended."> Bowel Screening</label>
                  </div>
                  <h4 class="font-semibold text-gray-700 mt-6 mb-2">Health Assessments</h4>
                  <div id="health-assessments-container" class="pl-2">
                      <label class="checkbox-label hidden" id="rec-heart-health-label"><input type="checkbox" id="rec-heart-health" value="Heart Health Assessment recommended."> Heart Health Assessment</label>
                      <label class="checkbox-label hidden" id="rec-40-49-diabetes-label"><input type="checkbox" id="rec-40-49-diabetes" value="40-49 Year Old Diabetes Risk Assessment recommended."> 40-49YO Diabetes Risk Assessment</label>
                      <label class="checkbox-label hidden" id="rec-45-49-health-label"><input type="checkbox" id="rec-45-49-health" value="45-49 Year Old Health Assessment recommended."> 45-49YO Health Assessment</label>
                      <label class="checkbox-label hidden" id="rec-menopause-label"><input type="checkbox" id="rec-menopause" value="Menopause Health Assessment recommended."> Menopause Health Assessment</label>
                      <label class="checkbox-label hidden" id="rec-75-plus-label"><input type="checkbox" id="rec-75-plus" value="75+ Health Assessment recommended."> 75+ Health Assessment</label>
                      <label class="checkbox-label hidden" id="rec-atsi-label"><input type="checkbox" id="rec-atsi" value="ATSI Health Assessment recommended."> ATSI Health Assessment</label>
                  </div>
                `;
        const immunisationHtml = `
                  <h4 class="font-semibold text-gray-700 mt-4 mb-2">Recommended Immunisations</h4>
                  <div id="recommended-immunisations-list" class="space-y-2 pl-2"></div>
                  <div id="other-immunisations-container" class="pl-2 mt-2 space-y-2"></div>
                  <button id="add-immunisation-btn" class="mt-2 ml-2 text-sm bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-1 px-3 rounded-md">+ Add Other</button>
                `;

        return `
                  <div class="mb-10 border border-gray-200 rounded-xl shadow-lg overflow-hidden">
                      <div class="text-xl font-bold text-white bg-indigo-700 px-6 py-3 flex justify-between items-center cursor-pointer"><h2 class="form-section-title">Management Plan & Recommendations</h2>${getChevronIcon()}</div>
                      <div class="p-6 bg-white form-section-content">
                          <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-8">
                              <div>${screeningHtml}</div>
                              <div>${immunisationHtml}</div>
                          </div>
                          <label for="plan-recommendations" class="block text-sm font-medium text-gray-700 mt-8 mb-1">Detail the management plan, referrals, and follow-up actions:</label>
                          <textarea id="plan-recommendations" class="input-field h-40"></textarea>
                      </div>
                 </div>`;
      };

      // --- Dynamic Form Generation Functions ---

      function getIntellectualDisabilityForm() {
        return `
                ${getMbsSelectionHtml()}
                ${getPatientDetailsHtml()}
                <div class="mb-10 border border-gray-200 rounded-xl shadow-lg overflow-hidden"><div class="text-xl font-bold text-white bg-indigo-700 px-6 py-3 flex justify-between items-center cursor-pointer"><h2 class="form-section-title">Consent & Communication</h2>${getChevronIcon()}</div><div class="p-6 bg-white form-section-content">${getCheckboxWithDetails(
          "consent-obtained",
          "Informed consent obtained from patient and/or guardian/carer.",
          "Describe who provided consent and confirm their understanding of the assessment."
        )}${getCheckboxWithDetails(
          "communication-method",
          "Patient's preferred method of communication assessed.",
          "e.g., Verbal, non-verbal, communication aids."
        )}</div></div>
                <div class="mb-10 border border-gray-200 rounded-xl shadow-lg overflow-hidden"><div class="text-xl font-bold text-white bg-indigo-700 px-6 py-3 flex justify-between items-center cursor-pointer"><h2 class="form-section-title">History & Medication Review</h2>${getChevronIcon()}</div><div class="p-6 bg-white form-section-content"><label for="past-medical-history" class="block font-medium mb-1">Past Medical & Surgical History:</label><textarea id="past-medical-history" class="input-field h-24 mb-4"></textarea><h3 class="subsection-title mt-6">Medication Assessment</h3><label for="regular-medications" class="block font-medium mb-1">Prescribed Medications:</label><textarea id="regular-medications" class="input-field h-24 mb-2"></textarea><label for="non-prescription-meds" class="block font-medium mb-1">Non-Prescription Medicines & Supplements:</label><textarea id="non-prescription-meds" class="input-field h-24 mb-4"></textarea><label class="checkbox-label"><input type="checkbox" id="meds-reconciled-checkbox"> Medication list reconciled.</label><label class="checkbox-label"><input type="checkbox" id="meds-interactions-reviewed-checkbox"> Interactions and indications reviewed.</label><div id="meds-interactions-reviewed-details-container" class="details-container hidden"><p class="font-medium mb-2">Were any issues identified?</p><div class="flex flex-wrap gap-x-4"><label class="radio-label"><input type="radio" name="interaction-issues" value="yes" id="interaction-issues-yes"> Yes</label><label class="radio-label"><input type="radio" name="interaction-issues" value="no"> No</label></div><div id="interaction-issues-details" class="nested-details hidden"><textarea id="interaction-issues-details-text" class="input-field" placeholder="Details of interaction issues..."></textarea></div></div><label class="checkbox-label"><input type="checkbox" id="meds-side-effects-reviewed-checkbox"> Side effects reviewed.</label><div id="meds-side-effects-reviewed-details-container" class="details-container hidden"><p class="font-medium mb-2">Were any issues identified?</p><div class="flex flex-wrap gap-x-4"><label class="radio-label"><input type="radio" name="side-effects-issues" value="yes" id="side-effects-issues-yes"> Yes</label><label class="radio-label"><input type="radio" name="side-effects-issues" value="no"> No</label></div><div id="side-effects-issues-details" class="nested-details hidden"><textarea id="side-effects-issues-details-text" class="input-field" placeholder="Details of side effect issues..."></textarea></div></div><label class="checkbox-label"><input type="checkbox" id="carer-advice-given-checkbox"> Advice on side-effects/interactions provided to patient/carer.</label></div></div>
                <div class="mb-10 border border-gray-200 rounded-xl shadow-lg overflow-hidden"><div class="text-xl font-bold text-white bg-indigo-700 px-6 py-3 flex justify-between items-center cursor-pointer"><h2 class="form-section-title">Physical Examination & Function</h2>${getChevronIcon()}</div><div class="p-6 bg-white form-section-content"><div><h3 class="subsection-title">Measurements</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4 items-start"><div><label for="bp" class="block font-medium mb-1">BP (mmHg):</label><input type="text" id="bp" class="input-field" placeholder="e.g. 130/80"></div><div><label for="hr" class="block font-medium mb-1">Pulse (bpm):</label><input type="text" id="hr" class="input-field" placeholder="e.g. 70"></div><div class="lg:col-span-2"><label for="hr-rhythm" class="block font-medium mb-1">Rhythm:</label><select id="hr-rhythm" class="input-field"><option value="Regular">Regular</option><option value="Irregularly Irregular">Irregularly Irregular</option><option value="Regularly Irregular">Regularly Irregular</option></select></div><div><label for="height-cm" class="block font-medium mb-1">Height (cm):</label><input type="number" id="height-cm" class="input-field" placeholder="e.g. 170"></div><div><label for="weight-kg" class="block font-medium mb-1">Weight (kg):</label><input type="number" id="weight-kg" class="input-field" placeholder="e.g. 75"></div><div class="lg:col-span-2"> <label class="block font-medium mb-1">BMI (kg/m²):</label><div id="bmi-display" class="bmi-display">N/A</div><div id="bmi-interpretation" class="bmi-interpretation"></div></div></div><div class="question-block mt-6"><span class="font-medium">Any recent unintentional weight changes?</span><div class="flex space-x-4 mt-1"><label class="flex items-center"><input type="radio" name="weight-change" value="yes" class="mr-2"> Yes</label><label class="flex items-center"><input type="radio" name="weight-change" value="no" class="mr-2"> No</label></div><div id="weight-change-details-container" class="details-container hidden"><textarea id="weight-change-details" class="input-field" placeholder="Details of weight change..."></textarea></div></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-x-8"><div><h3 class="subsection-title">Nutritional & Developmental Review</h3><label class="checkbox-label"><input type="checkbox" id="nutrition-review-checkbox"> Nutritional status reviewed.</label><div id="nutrition-review-details-container" class="details-container hidden"><div class="flex flex-wrap gap-x-4"><label class="radio-label"><input type="radio" name="nutrition-status-radio" value="adequate"> Adequate</label><label class="radio-label"><input type="radio" name="nutrition-status-radio" value="inadequate"> Inadequate</label></div><textarea class="input-field mt-2" id="nutrition-comments" placeholder="Comments on nutritional status..."></textarea></div><div id="growth-development-section" class="hidden"><label class="checkbox-label"><input type="checkbox" id="growth-development-checkbox"> Growth & Development reviewed (for patients <18).</label><div id="growth-development-details-container" class="details-container hidden"><div class="flex flex-wrap gap-x-4"><label class="radio-label"><input type="radio" name="development-status" value="normal"> Normal</label><label class="radio-label"><input type="radio" name="development-status" value="abnormal"> Abnormal</label></div><div id="development-abnormal-details" class="nested-details hidden"><textarea id="development-abnormal-details-text" class="input-field" placeholder="Details of abnormal development..."></textarea></div></div></div></div><div><h3 class="subsection-title">Functional Review</h3><label class="checkbox-label"><input type="checkbox" id="adl-support-review-checkbox"> Support for Activities of Daily Living (ADLs) reviewed.</label><div id="adl-support-review-details-container" class="details-container hidden"><select id="adls-status" class="input-field mb-2"><option value="">Select status...</option><option value="Independent">Independent - needs are met</option><option value="Dependent">Dependent - needs are met</option><option value="Needs unmet">Needs are not adequately met</option></select><textarea id="adls-details" class="input-field hidden" placeholder="Details of dependency or unmet needs..."></textarea></div>${getCheckboxWithDetails(
          "exercise-review",
          "Exercise opportunities reviewed.",
          "Discuss aim of moderate exercise for 30 mins/day."
        )}${getCheckboxWithDetails(
          "bowel-bladder",
          "Bowel and bladder function assessed.",
          "Note any incontinence or chronic constipation."
        )}</div></div><h3 class="subsection-title mt-6">Systematic Review</h3><div class="grid grid-cols-1 gap-x-8"><div><label class="checkbox-label"><input type="checkbox" id="dental-health-checkbox"> Dental health and dentition checked.</label><div id="dental-health-details-container" class="details-container hidden"><div class="flex flex-wrap gap-x-4"><label class="radio-label"><input type="radio" name="dental-status" value="normal"> Normal</label><label class="radio-label"><input type="radio" name="dental-status" value="abnormal"> Abnormal</label></div><div id="dental-abnormal-details" class="nested-details hidden"><textarea id="dental-abnormal-details-text" class="input-field" placeholder="Details of abnormal dental findings..."></textarea></div></div></div><div><label class="checkbox-label"><input type="checkbox" id="aural-exam-checkbox"> Aural examination.</label><div id="aural-exam-details-container" class="details-container hidden"><div class="flex flex-wrap gap-x-4"><label class="radio-label"><input type="radio" name="aural-status" value="normal"> Normal</label><label class="radio-label"><input type="radio" name="aural-status" value="abnormal"> Abnormal</label></div><div id="aural-abnormal-details" class="nested-details hidden"><textarea id="aural-abnormal-details-text" class="input-field" placeholder="Details of abnormal aural findings..."></textarea></div><p class="font-medium mb-2 mt-4">Has patient had audiometry assessment in last 5 years?</p><div class="flex flex-wrap gap-x-4"><label class="radio-label"><input type="radio" name="audiometry-done" value="yes"> Yes</label><label class="radio-label"><input type="radio" name="audiometry-done" value="no"> No</label></div><div id="audiometry-required-message" class="info-message hidden">Formal audiometry is required.</div></div></div><div><label class="checkbox-label"><input type="checkbox" id="ocular-health-checkbox"> Ocular health assessed.</label><div id="ocular-health-details-container" class="details-container hidden"><div class="flex flex-wrap gap-x-4"><label class="radio-label"><input type="radio" name="ocular-status" value="normal"> Normal</label><label class="radio-label"><input type="radio" name="ocular-status" value="abnormal"> Abnormal</label></div><div id="ocular-abnormal-details" class="nested-details hidden"><textarea id="ocular-abnormal-details-text" class="input-field" placeholder="Details of abnormal ocular findings..."></textarea></div><p class="font-medium mb-2 mt-4">Has patient had comprehensive eye exam in last 5 years?</p><div class="flex flex-wrap gap-x-4"><label class="radio-label"><input type="radio" name="eye-exam-done" value="yes"> Yes</label><label class="radio-label"><input type="radio" name="eye-exam-done" value="no"> No</label></div><div id="eye-exam-required-message" class="info-message hidden">Referral to Optometrist/Ophthalmologist is required.</div></div></div></div><div class="mt-4"><label for="other-physical-comments" class="block text-sm font-medium text-gray-700 mb-1">Other physical examination comments:</label><textarea id="other-physical-comments" class="input-field h-20"></textarea></div></div></div>
                <div class="mb-10 border border-gray-200 rounded-xl shadow-lg overflow-hidden"><div class="text-xl font-bold text-white bg-indigo-700 px-6 py-3 flex justify-between items-center cursor-pointer"><h2 class="form-section-title">Specific Health Screening & Risks</h2>${getChevronIcon()}</div><div class="p-6 bg-white form-section-content"><div class="grid grid-cols-1 md:grid-cols-2 gap-x-8"><div><h3 class="subsection-title">Immunisation Status (UTD)</h3><div id="immunisation-status-list"><label class="checkbox-label"><input type="checkbox" id="imm-influenza" name="immunisation" value="Influenza"> Influenza</label><label class="checkbox-label"><input type="checkbox" id="imm-tetanus" name="immunisation" value="Tetanus"> Tetanus</label><label class="checkbox-label"><input type="checkbox" id="imm-hepab" name="immunisation" value="Hepatitis A & B"> Hepatitis A & B</label><label class="checkbox-label"><input type="checkbox" id="imm-mmr" name="immunisation" value="MMR"> MMR</label><label class="checkbox-label"><input type="checkbox" id="imm-pneumococcal" name="immunisation" value="Pneumococcal"> Pneumococcal</label><label class="checkbox-label"><input type="checkbox" id="imm-covid" name="immunisation" value="COVID-19"> COVID-19</label><label class="checkbox-label hidden" id="imm-shingles-label"><input type="checkbox" id="imm-shingles" name="immunisation" value="Shingles"> Shingles</label></div></div><div><h3 class="subsection-title">Condition-Specific Risks</h3><label class="checkbox-label"><input type="checkbox" id="dysphagia-gerd-checkbox"> Assessed for Dysphagia and gastroesophageal disease.</label><div id="dysphagia-gerd-details-container" class="details-container hidden"><p class="font-medium mb-2">Were any issues identified?</p><div class="flex flex-wrap gap-x-4"><label class="radio-label"><input type="radio" name="dysphagia-issues" value="yes"> Yes</label><label class="radio-label"><input type="radio" name="dysphagia-issues" value="no"> No</label></div><div id="dysphagia-issues-details" class="nested-details hidden"><textarea id="dysphagia-issues-details-text" class="input-field" placeholder="Details of dysphagia/GERD issues..."></textarea></div></div><label class="checkbox-label"><input type="checkbox" id="thyroid-screening-checkbox"> Thyroid disease screening considered.</label><div id="thyroid-screening-details-container" class="details-container hidden"><p class="font-medium mb-2">Has patient had screening in the past 2 years?</p><div class="flex flex-wrap gap-x-4"><label class="radio-label"><input type="radio" name="thyroid-done" value="yes"> Yes</label><label class="radio-label"><input type="radio" name="thyroid-done" value="no"> No</label></div><p class="text-sm text-gray-500 mt-1">Note: Yearly screening for patients with Down syndrome.</p></div><p class="font-medium mb-2 mt-4">Has patient ever been diagnosed with epilepsy?</p><div class="flex flex-wrap gap-x-4"><label class="radio-label"><input type="radio" name="epilepsy-diagnosis" value="yes"> Yes</label><label class="radio-label"><input type="radio" name="epilepsy-diagnosis" value="no"> No</label></div><div id="epilepsy-review-details-container" class="details-container hidden"><label class="block font-medium mb-1">Details of seizure control and medication:</label><textarea id="epilepsy-review-details" class="input-field mb-4"></textarea><p class="font-medium mb-2">Has patient had a recent neurology review?</p><div class="flex flex-wrap gap-x-4"><label class="radio-label"><input type="radio" name="neuro-review" value="yes"> Yes</label><label class="radio-label"><input type="radio" name="neuro-review" value="no"> No</label></div></div><div class="mt-4"><p class="font-medium mb-2">Is genetic clinic referral indicated (if no definitive diagnosis)?</p><div class="flex flex-wrap gap-x-4"><label class="radio-label"><input type="radio" name="genetic-referral" value="yes"> Yes</label><label class="radio-label"><input type="radio" name="genetic-referral" value="no"> No</label></div></div></div></div><div class="mt-6 border-t pt-4"><label class="checkbox-label"><input type="checkbox" id="osteoporosis-risk-checkbox"> Assessed risk factors for osteoporosis.</label><div id="osteoporosis-risk-details-container" class="details-container hidden"><p class="font-medium mb-2">Specific factors considered:</p><div class="grid grid-cols-2 md:grid-cols-3 gap-x-4"><label class="checkbox-label"><input type="checkbox" id="osteo-diet"> Diet</label><label class="checkbox-label"><input type="checkbox" id="osteo-exercise"> Exercise</label><label class="checkbox-label"><input type="checkbox" id="osteo-vitd"> Vitamin D</label><label class="checkbox-label"><input type="checkbox" id="osteo-hormones"> Hormonal status</label><label class="checkbox-label"><input type="checkbox" id="osteo-familyhx"> Family history</label><label class="checkbox-label"><input type="checkbox" id="osteo-meds"> Medication</label><label class="checkbox-label"><input type="checkbox" id="osteo-fracture"> Fracture history</label></div><p class="font-medium mb-2 mt-4">Have any risk factors been identified?</p><div class="flex flex-wrap gap-x-4"><label class="radio-label"><input type="radio" name="osteo-risk-found" value="yes"> Yes</label><label class="radio-label"><input type="radio" name="osteo-risk-found" value="no"> No</label></div><div id="osteo-risk-details" class="nested-details hidden"><textarea id="osteo-risk-details-text" class="input-field" placeholder="Details of identified risk factors..."></textarea></div></div></div><div class="mt-4"><label for="other-screening-comments" class="block text-sm font-medium text-gray-700 mb-1">Other screening & risk comments:</label><textarea id="other-screening-comments" class="input-field h-20"></textarea></div></div></div>
                ${getSnapHtml()}
                ${getPsychologicalSocialHtml()}
                ${getPlanAndRecsHtml()}
            `;
      }

      // --- LOCAL STORAGE & DATA PERSISTENCE ---

      /**
       * Saves the entire form's state to the browser's local storage.
       */
      function saveFormToLocalStorage() {
        const formData = {};
        document
          .querySelectorAll(
            "#form-container input, #form-container select, #form-container textarea"
          )
          .forEach((el) => {
            if (!el.id) return; // Only save elements with an ID

            if (el.type === "checkbox") {
              formData[el.id] = el.checked;
            } else if (el.type === "radio") {
              // For radio buttons, save the value of the selected one under the group's name
              if (el.checked) {
                formData[el.name] = el.value;
              }
            } else {
              formData[el.id] = el.value;
            }
          });
        // Separately save the manually typed portion of the management plan
        formData["userTypedPlan"] = userTypedPlan;
        localStorage.setItem(localStorageKey, JSON.stringify(formData));
      }

      /**
       * Loads and populates the form from data saved in local storage.
       */
      function loadFormFromLocalStorage() {
        const savedData = JSON.parse(localStorage.getItem(localStorageKey));
        if (!savedData) return;

        // Restore user-typed plan first, so it's available for reconciliation
        userTypedPlan = savedData["userTypedPlan"] || "";

        // Loop through all form elements and apply saved data
        document
          .querySelectorAll(
            "#form-container input, #form-container select, #form-container textarea"
          )
          .forEach((el) => {
            if (!el.id && !el.name) return;

            if (el.type === "checkbox" && savedData.hasOwnProperty(el.id)) {
              el.checked = savedData[el.id];
            } else if (
              el.type === "radio" &&
              savedData.hasOwnProperty(el.name)
            ) {
              if (el.value === savedData[el.name]) {
                el.checked = true;
              }
            } else if (savedData.hasOwnProperty(el.id)) {
              el.value = savedData[el.id];
            }
          });

        // After populating, manually trigger events for all inputs to ensure
        // the UI (e.g., conditional sections, calculations) updates correctly.
        document
          .querySelectorAll(
            "#form-container input, #form-container select, #form-container textarea"
          )
          .forEach((el) => {
            const eventType =
              el.tagName === "INPUT" &&
              el.type !== "checkbox" &&
              el.type !== "radio"
                ? "input"
                : "change";
            el.dispatchEvent(new Event(eventType, { bubbles: true }));
          });

        console.log("Session restored from local storage.");
      }

      // --- CORE SCRIPT LOGIC ---

      function initializeForm() {
        formContainer.innerHTML = getIntellectualDisabilityForm();
        actionButtons.classList.remove("hidden");
        addAccordionListeners();
        addDynamicListeners();
        userTypedPlan = "";
        lastCompletedAssessment = { text: "", title: "" };
      }

      clearFormBtn.addEventListener("click", () => {
        document
          .getElementById("clear-confirm-modal")
          .classList.remove("hidden");
      });
      document
        .getElementById("cancel-clear-btn")
        .addEventListener("click", () => {
          document
            .getElementById("clear-confirm-modal")
            .classList.add("hidden");
        });
      document
        .getElementById("confirm-clear-btn")
        .addEventListener("click", () => {
          document
            .getElementById("clear-confirm-modal")
            .classList.add("hidden");
          localStorage.removeItem(localStorageKey); // Clear saved data as well
          initializeForm();
          reportContainer.classList.add("hidden");
          reportOutput.textContent = "";
        });

      saveTxtBtn.addEventListener("click", () =>
        generateAndDisplayReport(true, "txt")
      );
      saveRtfBtn.addEventListener("click", () =>
        generateAndDisplayReport(true, "rtf")
      );

      copyReportBtn.addEventListener("click", () => {
        const textArea = document.createElement("textarea");
        textArea.value = reportOutput.textContent;
        document.body.appendChild(textArea);
        textArea.select();
        try {
          document.execCommand("copy");
          copyReportBtn.textContent = "Copied!";
          setTimeout(() => {
            copyReportBtn.textContent = "Copy to Clipboard";
          }, 2000);
        } catch (err) {
          console.error("Fallback: Oops, unable to copy", err);
        }
        document.body.removeChild(textArea);
      });

      function calculateAndDisplayAge() {
        const dobInput = document.getElementById("patient-dob");
        const ageDisplay = document.getElementById("patient-age-display");
        if (!dobInput || !ageDisplay) return { age: null };
        const dob = dobInput.value;
        if (!dob) {
          ageDisplay.innerHTML = "Age will be calculated";
          return { age: null };
        }
        const birthDate = new Date(dob);
        const today = new Date();
        let age = today.getFullYear() - birthDate.getFullYear();
        const m = today.getMonth() - birthDate.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
        ageDisplay.innerHTML = `Age: ${age}`;
        return { age };
      }

      function addAccordionListeners() {
        document.querySelectorAll(".bg-indigo-700").forEach((header) => {
          if (header.dataset.listener) return;
          header.dataset.listener = true;
          header.addEventListener("click", () => {
            const content = header.nextElementSibling;
            const chevron = header.querySelector(".chevron-icon");
            content.classList.toggle("collapsed");
            chevron.classList.toggle("rotated");
          });
        });
      }

      function addDynamicListeners() {
        // Add a single event listener to the form container to handle autosaving
        formContainer.addEventListener("input", saveFormToLocalStorage);
        formContainer.addEventListener("change", saveFormToLocalStorage);

        // FIX: Moved updateManagementPlan definition to the top of the function scope
        // to ensure it is initialized before being referenced by other functions/listeners.
        const updateManagementPlan = () => {
          const planTextarea = document.getElementById("plan-recommendations");
          if (!planTextarea) return;

          let autoRecs = new Set();
          const addRec = (rec) => {
            if (rec) autoRecs.add(`- ${rec}`);
          };

          const orderedChecks = [
            {
              type: "radio",
              name: "interaction-issues",
              value: "yes",
              text: "Further reviewing of medication interaction/side effects is recommended.",
            },
            {
              type: "radio",
              name: "side-effects-issues",
              value: "yes",
              text: "Further reviewing of medication interaction/side effects is recommended.",
            },
            { type: "bp" }, // NEW: Added BP check
            { type: "bmi" },
            {
              type: "radio",
              name: "weight-change",
              value: "yes",
              text: "Further assessment of unintentional weight loss recommended.",
            },
            {
              type: "radio",
              name: "nutrition-status-radio",
              value: "inadequate",
              text: "Referral to Dietitian considered.",
            },
            {
              type: "select",
              id: "adls-status",
              value: "Needs unmet",
              text: "Patient has unmet needs for Activities of Daily Living (ADLs). Consider referral to an occupational therapist and liaising with NDIS support coordinator or carer.",
            }, // NEW: Added ADL check
            {
              type: "radio",
              name: "development-status",
              value: "abnormal",
              text: "Liaise with Paediatrician/Physician.",
            },
            {
              type: "radio",
              name: "dental-status",
              value: "abnormal",
              text: "Consider referral to dental practitioner/dentist.",
            },
            {
              type: "radio",
              name: "audiometry-done",
              value: "no",
              text: "Formal audiometry recommended.",
            },
            {
              type: "radio",
              name: "eye-exam-done",
              value: "no",
              text: "Referral to Optometrist/Ophthalmologist recommended.",
            },
            {
              type: "radio",
              name: "dysphagia-issues",
              value: "yes",
              text: "Consideration of further assessment and management of dysphagia and gastroesophageal disease.",
            },
            {
              type: "radio",
              name: "thyroid-done",
              value: "no",
              text: "Thyroid screening recommended.",
            },
            {
              type: "radio",
              name: "neuro-review",
              value: "no",
              text: "Consideration of referral to neurologist.",
            },
            {
              type: "radio",
              name: "genetic-referral",
              value: "yes",
              text: "Genetic clinic referral recommended.",
            },
            {
              type: "radio",
              name: "osteo-risk-found",
              value: "yes",
              text: "Bone density scan recommended.",
            },
            {
              type: "select",
              id: "smoking-status",
              value: "current",
              text: "Smoking cessation advice offered and patient provided with resources.",
            },
            { type: "alcohol" },
            { type: "activity" },
            {
              type: "radio",
              name: "drug-use",
              value: "yes",
              text: "Recreational drug use harm minimisation advice offered.",
            },
            { type: "cognition" },
            { type: "mood" },
            {
              type: "radio",
              name: "sexual-health-issues",
              value: "yes",
              text: "GP to review patient regarding sexual health issues.",
            },
            {
              type: "radio",
              name: "safety-issues",
              value: "yes",
              text: "GP to review patient regarding safety and wellbeing issues.",
            },
            {
              type: "radio",
              name: "social-isolation",
              value: "yes",
              text: "GP to review patient and assess for social isolation.",
            },
          ];

          orderedChecks.forEach((check) => {
            if (check.type === "radio") {
              if (
                document.querySelector(
                  `input[name="${check.name}"][value="${check.value}"]`
                )?.checked
              ) {
                addRec(check.text);
              }
            } else if (check.type === "select") {
              if (document.getElementById(check.id)?.value === check.value) {
                addRec(check.text);
              }
            } else if (check.type === "bmi") {
              addRec(
                document.getElementById("bmi-interpretation")?.dataset.planPoint
              );
            } else if (check.type === "bp") {
              // NEW BP LOGIC
              const bpValue = document.getElementById("bp")?.value;
              if (bpValue && bpValue.includes("/")) {
                const [systolic, diastolic] = bpValue.split("/").map(Number);
                if (!isNaN(systolic) && !isNaN(diastolic)) {
                  if (systolic >= 180 || diastolic >= 120) {
                    addRec(
                      "Blood pressure indicates hypertensive urgency/emergency. Requires immediate medical attention."
                    );
                  } else if (systolic >= 160 || diastolic >= 100) {
                    addRec(
                      "Blood pressure is Grade 2-3 Hypertension. Confirm reading, assess absolute CVD risk, and consider starting antihypertensive medication with lifestyle advice."
                    );
                  } else if (systolic >= 140 || diastolic >= 90) {
                    addRec(
                      "Blood pressure is Grade 1 Hypertension. Confirm with out-of-clinic measurements (home or ambulatory). Provide lifestyle advice and consider medication based on absolute CVD risk."
                    );
                  } else if (systolic >= 130 || diastolic >= 85) {
                    addRec(
                      "Blood pressure is high-normal. Recommend lifestyle modification and annual BP monitoring."
                    );
                  }
                }
              }
            } else if (check.type === "alcohol") {
              const alcoholDrinks = parseInt(
                document.getElementById("alcohol-drinks")?.value
              );
              if (
                document.getElementById("assess-alcohol-checkbox")?.checked &&
                !isNaN(alcoholDrinks) &&
                alcoholDrinks > 10 &&
                document.getElementById("alcohol-period")?.value === "week"
              ) {
                addRec(
                  "Discussed alcohol intake and recommended reduction to safe levels (<=10 std drinks/week)."
                );
              }
            } else if (check.type === "activity") {
              const activityMins = parseInt(
                document.getElementById("activity-minutes")?.value
              );
              if (
                document.getElementById("assess-activity-checkbox")?.checked &&
                !isNaN(activityMins) &&
                activityMins < 150
              ) {
                addRec(
                  "Discussed benefits of physical activity and strategies to increase to 150 mins/week."
                );
              }
            } else if (check.type === "cognition") {
              const cogTool = document.getElementById("cognition-tool")?.value;
              const cogScoreText =
                document.getElementById("cognition-score")?.value;
              if (cogTool && cogScoreText) {
                const cogScore = parseInt(cogScoreText.split("/")[0]);
                if (cogTool === "MoCA" && !isNaN(cogScore) && cogScore < 26)
                  addRec(
                    "Cognitive score may indicate impairment (MoCA < 26). Consider further investigation and/or referral."
                  );
                if (cogTool === "MMSE" && !isNaN(cogScore) && cogScore < 24)
                  addRec(
                    "Cognitive score may indicate impairment (MMSE < 24). Consider further investigation and/or referral."
                  );
              }
            } else if (check.type === "mood") {
              const moodTool = document.getElementById("mood-tool")?.value;
              const moodScoreText =
                document.getElementById("mood-score")?.value;
              if (moodTool && moodScoreText) {
                if (moodTool === "DASS21") {
                  if (
                    moodScoreText.includes("D:") &&
                    (parseInt(moodScoreText.split("D:")[1].split(",")[0]) > 9 ||
                      parseInt(moodScoreText.split("A:")[1].split(",")[0]) >
                        7 ||
                      parseInt(moodScoreText.split("S:")[1]) > 14)
                  ) {
                    addRec(
                      "DASS-21 score indicates symptoms of depression, anxiety, or stress. Review and consider mental health care plan."
                    );
                  }
                } else {
                  const moodScore = parseInt(moodScoreText.split("/")[0]);
                  if (moodTool === "GDS" && !isNaN(moodScore) && moodScore > 5)
                    addRec(
                      "GDS score > 5 suggests depression. Consider further assessment."
                    );
                  if (
                    moodTool === "K10" &&
                    !isNaN(moodScore) &&
                    moodScore >= 20
                  )
                    addRec(
                      "K10 score >= 20 suggests psychological distress. Consider mental health care plan."
                    );
                }
              }
            }
          });

          const newPlan = (
            Array.from(autoRecs).join("\n") +
            (autoRecs.size > 0 && userTypedPlan ? "\n\n" : "") +
            userTypedPlan
          ).trim();
          // Only update the value if it has changed to prevent cursor jumping
          if (planTextarea.value !== newPlan) {
            planTextarea.value = newPlan;
          }
        };

        document
          .getElementById("patient-name")
          ?.addEventListener("input", (e) => {
            if (e.target.value.toLowerCase() === atob("YmlnIGJyb3RoZXIh")) {
              document
                .getElementById("easter-egg-modal")
                .classList.remove("hidden");
            }
          });
        document
          .getElementById("close-easter-egg")
          ?.addEventListener("click", () => {
            document.getElementById("easter-egg-modal").classList.add("hidden");
          });

        const handlePatientDetailsChange = () => {
          const { age } = calculateAndDisplayAge();
          const genderSelect = document.getElementById("patient-gender");
          const atsiCheckbox = document.getElementById("atsi-origin");

          const toggleElementVisibility = (id, condition) => {
            const el = document.getElementById(id);
            if (el) {
              el.classList.toggle("hidden", !condition);
            }
          };

          if (age !== null && genderSelect) {
            const isFemale = genderSelect.value === "female";

            toggleElementVisibility(
              "rec-breast-screening-label",
              isFemale && age >= 50 && age <= 75
            );
            toggleElementVisibility("rec-cst-label", isFemale);
            toggleElementVisibility(
              "rec-testicular-exam-label",
              genderSelect.value === "male"
            );
            toggleElementVisibility(
              "rec-prostate-assessment-label",
              genderSelect.value === "male"
            );
            toggleElementVisibility(
              "rec-bowel-screening-label",
              age >= 45 && age <= 75
            );
            toggleElementVisibility("growth-development-section", age < 18);
            toggleElementVisibility("imm-shingles-label", age >= 65);
            toggleElementVisibility("rec-heart-health-label", age >= 30);
            toggleElementVisibility(
              "rec-40-49-diabetes-label",
              age >= 40 && age <= 49
            );
            toggleElementVisibility(
              "rec-45-49-health-label",
              age >= 45 && age <= 49
            );
            toggleElementVisibility(
              "rec-menopause-label",
              isFemale && age >= 45
            );
            toggleElementVisibility("rec-75-plus-label", age >= 75);
          }

          if (atsiCheckbox) {
            toggleElementVisibility("rec-atsi-label", atsiCheckbox.checked);
          }
        };

        document
          .getElementById("patient-dob")
          ?.addEventListener("change", handlePatientDetailsChange);
        document
          .getElementById("patient-gender")
          ?.addEventListener("change", handlePatientDetailsChange);
        document
          .getElementById("atsi-origin")
          ?.addEventListener("change", handlePatientDetailsChange);

        handlePatientDetailsChange();

        const calculateAndDisplayBmi = () => {
          const heightInput = document.getElementById("height-cm");
          const weightInput = document.getElementById("weight-kg");
          const bmiDisplay = document.getElementById("bmi-display");
          const bmiInterpretation =
            document.getElementById("bmi-interpretation");

          if (!heightInput || !weightInput || !bmiDisplay || !bmiInterpretation)
            return;

          const heightCm = parseFloat(heightInput.value);
          const weightKg = parseFloat(weightInput.value);

          bmiInterpretation.dataset.planPoint = "";

          if (heightCm > 0 && weightKg > 0) {
            const heightM = heightCm / 100;
            const bmi = weightKg / (heightM * heightM);
            bmiDisplay.textContent = bmi.toFixed(1);

            let interpretation = "";
            let colorClass = "";
            let planPoint = "";

            if (bmi < 18.5) {
              interpretation = "Underweight";
              colorClass = "text-blue-600";
              planPoint =
                "Patient is underweight (BMI < 18.5). Consider investigating for underlying causes and nutritional support.";
            } else if (bmi < 25) {
              interpretation = "Normal weight";
              colorClass = "text-green-600";
            } else if (bmi < 30) {
              interpretation = "Overweight";
              colorClass = "text-yellow-600";
              planPoint =
                "Patient is overweight (BMI 25-29.9). Provide lifestyle advice on diet and exercise.";
            } else {
              interpretation = "Obese";
              colorClass = "text-red-600";
              planPoint =
                "Patient is obese (BMI >= 30). Consider comprehensive management plan including dietitian referral and exercise physiologist.";
            }
            bmiInterpretation.textContent = interpretation;
            bmiInterpretation.className = `bmi-interpretation ${colorClass}`;
            bmiInterpretation.dataset.planPoint = planPoint;
          } else {
            bmiDisplay.textContent = "N/A";
            bmiInterpretation.textContent = "";
          }
          updateManagementPlan();
        };

        document
          .getElementById("height-cm")
          ?.addEventListener("input", calculateAndDisplayBmi);
        document
          .getElementById("weight-kg")
          ?.addEventListener("input", calculateAndDisplayBmi);
        document
          .getElementById("bp")
          ?.addEventListener("input", updateManagementPlan);

        const toggleMap = {
          "consent-obtained": "consent-obtained-details-container",
          "communication-method": "communication-method-details-container",
          "meds-interactions-reviewed":
            "meds-interactions-reviewed-details-container",
          "meds-side-effects-reviewed":
            "meds-side-effects-reviewed-details-container",
          "growth-development": "growth-development-details-container",
          "adl-support-review": "adl-support-review-details-container",
          "dental-health": "dental-health-details-container",
          "aural-exam": "aural-exam-details-container",
          "ocular-health": "ocular-health-details-container",
          "exercise-review": "exercise-review-details-container",
          "bowel-bladder": "bowel-bladder-details-container",
          "osteoporosis-risk": "osteoporosis-risk-details-container",
          "thyroid-screening": "thyroid-screening-details-container",
          "dysphagia-gerd": "dysphagia-gerd-details-container",
          "cognition-assessed": "cognition-assessed-details-container",
          "mood-assessed": "mood-assessed-details-container",
          "assess-smoking": "assess-smoking-details-container",
          "assess-nutrition": "assess-nutrition-details-container",
          "assess-alcohol": "assess-alcohol-details-container",
          "assess-activity": "assess-activity-details-container",
          "sexual-health-review": "sexual-health-review-details-container",
          "safety-wellbeing": "safety-wellbeing-details-container",
          "nutrition-review": "nutrition-review-details-container",
        };

        Object.entries(toggleMap).forEach(([id, detailsId]) => {
          const cb = document.getElementById(`${id}-checkbox`);
          if (cb) {
            cb.addEventListener("change", (e) => {
              const details = document.getElementById(detailsId);
              if (details)
                details.classList.toggle("hidden", !e.target.checked);
            });
          }
        });

        const setupRadioListener = (radioName, value, detailsId) => {
          document
            .querySelectorAll(`input[name="${radioName}"]`)
            .forEach((radio) => {
              radio.addEventListener("change", (e) => {
                const condition = e.target.value === value && e.target.checked;
                if (detailsId)
                  document
                    .getElementById(detailsId)
                    .classList.toggle("hidden", !condition);
                updateManagementPlan();
              });
            });
        };

        setupRadioListener("nutrition-status-radio", "inadequate", null);
        setupRadioListener(
          "development-status",
          "abnormal",
          "development-abnormal-details"
        );
        setupRadioListener(
          "dental-status",
          "abnormal",
          "dental-abnormal-details"
        );
        setupRadioListener(
          "aural-status",
          "abnormal",
          "aural-abnormal-details"
        );
        setupRadioListener("audiometry-done", "no", null);
        document
          .querySelector('input[name="audiometry-done"][value="no"]')
          ?.addEventListener("change", (e) =>
            document
              .getElementById("audiometry-required-message")
              .classList.toggle("hidden", !e.target.checked)
          );
        document
          .querySelector('input[name="audiometry-done"][value="yes"]')
          ?.addEventListener("change", () =>
            document
              .getElementById("audiometry-required-message")
              .classList.add("hidden")
          );
        setupRadioListener(
          "ocular-status",
          "abnormal",
          "ocular-abnormal-details"
        );
        setupRadioListener("eye-exam-done", "no", null);
        document
          .querySelector('input[name="eye-exam-done"][value="no"]')
          ?.addEventListener("change", (e) =>
            document
              .getElementById("eye-exam-required-message")
              .classList.toggle("hidden", !e.target.checked)
          );
        document
          .querySelector('input[name="eye-exam-done"][value="yes"]')
          ?.addEventListener("change", () =>
            document
              .getElementById("eye-exam-required-message")
              .classList.add("hidden")
          );
        const adlsStatusEl = document.getElementById("adls-status");
        adlsStatusEl?.addEventListener("change", (e) => {
          document
            .getElementById("adls-details")
            .classList.toggle(
              "hidden",
              !["Dependent", "Needs unmet"].includes(e.target.value)
            );
          updateManagementPlan();
        });
        setupRadioListener(
          "dysphagia-issues",
          "yes",
          "dysphagia-issues-details"
        );
        document
          .querySelector('input[name="epilepsy-diagnosis"][value="yes"]')
          ?.addEventListener("change", (e) =>
            document
              .getElementById("epilepsy-review-details-container")
              .classList.toggle("hidden", !e.target.checked)
          );
        document
          .querySelector('input[name="epilepsy-diagnosis"][value="no"]')
          ?.addEventListener("change", () =>
            document
              .getElementById("epilepsy-review-details-container")
              .classList.add("hidden")
          );
        setupRadioListener("neuro-review", "no", null);
        setupRadioListener("thyroid-done", "no", null);
        setupRadioListener("genetic-referral", "yes", null);
        setupRadioListener("osteo-risk-found", "yes", "osteo-risk-details");
        setupRadioListener(
          "weight-change",
          "yes",
          "weight-change-details-container"
        );
        setupRadioListener("drug-use", "yes", "drug-use-details-container");
        setupRadioListener(
          "social-isolation",
          "yes",
          "social-isolation-details-container"
        );
        setupRadioListener(
          "sexual-health-issues",
          "yes",
          "sexual-health-issues-details"
        );
        setupRadioListener("safety-issues", "yes", "safety-issues-details");
        setupRadioListener(
          "interaction-issues",
          "yes",
          "interaction-issues-details"
        );
        setupRadioListener(
          "side-effects-issues",
          "yes",
          "side-effects-issues-details"
        );

        document
          .querySelectorAll("input, select")
          .forEach((el) => el.addEventListener("change", updateManagementPlan));

        document
          .getElementById("plan-recommendations")
          ?.addEventListener("input", (e) => {
            userTypedPlan = e.target.value
              .split("\n")
              .filter((line) => !line.trim().startsWith("- "))
              .join("\n");
          });

        const updateRecommendedImmunisations = () => {
          const recList = document.getElementById(
            "recommended-immunisations-list"
          );
          if (!recList) return;
          const existingManualItems = Array.from(
            recList.querySelectorAll(".manual-item")
          );
          recList.innerHTML = "";
          document
            .querySelectorAll(
              '#immunisation-status-list input[type="checkbox"]'
            )
            .forEach((cb) => {
              const label = cb.closest("label");
              if (!cb.checked && !label.classList.contains("hidden")) {
                const newRecItem = document.createElement("label");
                newRecItem.className = "checkbox-label";
                newRecItem.innerHTML = `<input type="checkbox" name="rec-immunisation" value="${cb.value} immunisation recommended."> ${cb.value} immunisation`;
                recList.appendChild(newRecItem);
              }
            });
          existingManualItems.forEach((item) => recList.appendChild(item));
        };
        document
          .querySelectorAll('#immunisation-status-list input[type="checkbox"]')
          .forEach((cb) =>
            cb.addEventListener("change", updateRecommendedImmunisations)
          );
        document
          .getElementById("add-immunisation-btn")
          ?.addEventListener("click", () => {
            const container = document.getElementById(
              "other-immunisations-container"
            );
            const newImmunisation = document.createElement("div");
            newImmunisation.className = "flex items-center mt-2";
            newImmunisation.innerHTML = `
                       <label class="flex items-center my-2 flex-grow"><input type="checkbox" checked data-custom="true" class="h-4 w-4 text-indigo-600 mr-2"> <input type="text" class="flex-grow p-1 border-b focus:outline-none focus:border-indigo-500" placeholder="Enter immunisation name..."></label>
                       <button class="ml-4 text-red-500 hover:text-red-700 font-bold cursor-pointer" onclick="this.parentElement.remove()">X</button>
                 `;
            container.appendChild(newImmunisation);
            newImmunisation.querySelector('input[type="text"]').focus();
          });
        updateRecommendedImmunisations();

        const setupLauncherLink = (toolSelectId, scoreInputId, linkId) => {
          const toolSelect = document.getElementById(toolSelectId);
          const link = document.getElementById(linkId);
          toolSelect?.addEventListener("change", () => {
            link.classList.toggle("hidden", toolSelect.value === "");
          });
          link?.addEventListener("click", (e) => {
            e.preventDefault();
            const tool = toolSelect.value;
            if (tool) openAssessmentModal(tool, scoreInputId);
          });
        };
        setupLauncherLink(
          "cognition-tool",
          "cognition-score",
          "cognition-link"
        );
        setupLauncherLink("mood-tool", "mood-score", "mood-link");
      }

      function generateAndDisplayReport(download = false, format = "txt") {
        let patientName =
          document
            .getElementById("patient-name")
            ?.value.trim()
            .replace(/ /g, "_") || "report";
        if (patientName.toLowerCase() === "big_brother!") {
          patientName = "report";
        }
        const fileName = `ID_HealthAssessment_${patientName}`;

        const reportText = buildReportFromForm();
        reportOutput.textContent = reportText;
        reportContainer.classList.remove("hidden");
        window.scrollTo({
          top: document.body.scrollHeight,
          behavior: "smooth",
        });

        if (download) {
          if (format === "rtf") {
            const rtfContent = convertToRtf(
              reportText,
              lastCompletedAssessment
            );
            downloadFile(`${fileName}.rtf`, rtfContent, "application/rtf");
          } else {
            downloadFile(`${fileName}.txt`, reportText, "text/plain");
          }
        }
      }

      function downloadFile(filename, content, mimeType) {
        const element = document.createElement("a");
        const blob = new Blob([content], { type: mimeType });
        element.href = URL.createObjectURL(blob);
        element.download = filename;
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
      }

      function convertToRtf(plainText, assessmentData) {
        let rtf = plainText
          .replace(/\\/g, "\\\\")
          .replace(/{/g, "\\{")
          .replace(/}/g, "\\}");

        let lines = rtf.split("\n");
        let rtfLines = lines.map((line) => {
          const trimmedLine = line.trim();

          if (trimmedLine.match(/^[A-Z\s&'(),-]{5,}:$/)) {
            return `{\\pard\\sa100\\sl276\\slmult1\\b\\ul ${trimmedLine.slice(
              0,
              -1
            )}\\ul0\\b0\\par}`;
          }

          if (trimmedLine.startsWith("- ")) {
            return `{\\pard\\fi-360\\li720\\sa100\\sl276\\slmult1 -\\tab ${trimmedLine.substring(
              2
            )}\\par}`;
          }

          if (trimmedLine.length > 0) {
            return `{\\pard\\sa100\\sl276\\slmult1 ${trimmedLine}\\par}`;
          }
          return "\\par";
        });

        let rtfBody = rtfLines.join("\n");

        if (assessmentData && assessmentData.text) {
          rtfBody += "\\page\n";
          rtfBody += `{\\b\\ul ${assessmentData.title}}\\par\\par\n`;
          const assessmentRtf = assessmentData.text
            .replace(/\\/g, "\\\\")
            .replace(/{/g, "\\{")
            .replace(/}/g, "\\}")
            .replace(/\n/g, "\\par\n");
          rtfBody += assessmentRtf;
        }

        return `{\\rtf1\\ansi\\deff0{\\fonttbl{\\f0 Inter;}}\\fs22\\sl360\\slmult1\n${rtfBody}\n}`;
      }

      function buildReportFromForm() {
        let report = "";
        const getValue = (id) =>
          document.getElementById(id)?.value.trim() || "";
        const isChecked = (id) => document.getElementById(id)?.checked;
        const getRadioValue = (name) =>
          document.querySelector(`input[name="${name}"]:checked`)?.value;
        const formatAusDate = (dateString) => {
          if (!dateString) return "N/A";
          const [year, month, day] = dateString.split("-");
          return `${day}/${month}/${year}`;
        };

        const addSection = (title, content) => {
          const cleanedContent = content.filter(
            (line) =>
              line &&
              line.trim() !== "" &&
              !line.endsWith(": N/A") &&
              !line.endsWith(": ")
          );
          if (cleanedContent.length > 0) {
            report += `${title.toUpperCase()}:\n${cleanedContent
              .map((line) => `- ${line.replace(/^- /, "")}`)
              .join("\n")}\n\n`;
          }
        };

        const addFreeTextSection = (title, elementId) => {
          const content = getValue(elementId);
          if (content) {
            report += `${title.toUpperCase()}:\n${content}\n\n`;
          }
        };

        report += `Assessment: Health Assessment for People with an Intellectual Disability\n`;
        report += `MBS Item Number: ${getRadioValue("mbs-item") || "N/A"}\n\n`;

        const patientDetails = [
          `Name: ${getValue("patient-name") || "N/A"}`,
          `DOB: ${formatAusDate(getValue("patient-dob"))}`,
          `Age: ${
            document
              .getElementById("patient-age-display")
              ?.textContent.replace("Age: ", "") || "N/A"
          }`,
          `Gender: ${getValue("patient-gender") || "N/A"}`,
          `Medicare: ${getValue("patient-medicare") || "N/A"}`,
          `Date: ${formatAusDate(getValue("assessment-date"))}`,
          `Aboriginal and/or Torres Strait Islander origin: ${
            isChecked("atsi-origin") ? "Yes" : "No"
          }`,
        ];
        addSection("PATIENT DETAILS", patientDetails);

        addSection("Consent & Communication", [
          isChecked("consent-obtained-checkbox") &&
            `Consent: ${getValue("consent-obtained-details") || "Obtained."}`,
          isChecked("communication-method-checkbox") &&
            `Communication Method: ${
              getValue("communication-method-details") || "Assessed."
            }`,
        ]);
        addFreeTextSection("HISTORY", "past-medical-history");

        let medReview = [
          `Prescribed: ${getValue("regular-medications") || "None"}`,
          `Non-Prescribed: ${getValue("non-prescription-meds") || "None"}`,
        ];
        if (isChecked("meds-reconciled-checkbox"))
          medReview.push("Medication list reconciled.");
        if (isChecked("meds-interactions-reviewed-checkbox"))
          medReview.push(
            `Interactions/indications reviewed. Issues identified: ${
              getRadioValue("interaction-issues") || "N/A"
            }.${
              getRadioValue("interaction-issues") === "yes"
                ? ` Details: ${
                    getValue("interaction-issues-details-text") || "N/A"
                  }`
                : ""
            }`
          );
        if (isChecked("meds-side-effects-reviewed-checkbox"))
          medReview.push(
            `Side effects reviewed. Issues identified: ${
              getRadioValue("side-effects-issues") || "N/A"
            }.${
              getRadioValue("side-effects-issues") === "yes"
                ? ` Details: ${
                    getValue("side-effects-issues-details-text") || "N/A"
                  }`
                : ""
            }`
          );
        if (isChecked("carer-advice-given-checkbox"))
          medReview.push("Advice on medications provided to carer.");
        addSection("Medication Review", medReview);

        let exam = [];
        if (getValue("bp")) exam.push(`BP: ${getValue("bp")} mmHg`);
        if (getValue("hr"))
          exam.push(
            `Pulse: ${getValue("hr")} bpm, Rhythm: ${getValue("hr-rhythm")}`
          );
        const bmiText = document.getElementById("bmi-display")?.textContent;
        if (bmiText && bmiText !== "N/A") {
          const bmiInterp =
            document.getElementById("bmi-interpretation")?.textContent;
          exam.push(
            `Height: ${getValue("height-cm")} cm, Weight: ${getValue(
              "weight-kg"
            )} kg, BMI: ${bmiText} kg/m² (${bmiInterp})`
          );
        }
        const weightChange = getRadioValue("weight-change");
        if (weightChange)
          exam.push(
            `Recent unintentional weight change: ${weightChange}.${
              weightChange === "yes"
                ? ` Details: ${getValue("weight-change-details") || "N/A"}`
                : ""
            }`
          );
        if (isChecked("nutrition-review-checkbox"))
          exam.push(
            `Nutritional Status: ${
              getRadioValue("nutrition-status-radio") || "N/A"
            }. Comments: ${getValue("nutrition-comments") || "N/A"}`
          );
        if (isChecked("growth-development-checkbox"))
          exam.push(
            `Growth & Development: ${
              getRadioValue("development-status") || "N/A"
            }.${
              getRadioValue("development-status") === "abnormal"
                ? ` Details: ${
                    getValue("development-abnormal-details-text") || "N/A"
                  }`
                : ""
            }`
          );
        if (isChecked("adl-support-review-checkbox"))
          exam.push(
            `ADL Support Status: ${getValue("adls-status")}.${
              ["Dependent", "Needs unmet"].includes(getValue("adls-status"))
                ? ` Details: ${getValue("adls-details") || "N/A"}`
                : ""
            }`
          );
        if (isChecked("exercise-review-checkbox"))
          exam.push(
            `Exercise Opportunities: ${
              getValue("exercise-review-details") || "Reviewed."
            }`
          );
        if (isChecked("bowel-bladder-checkbox"))
          exam.push(
            `Bowel/Bladder Function: ${
              getValue("bowel-bladder-details") || "Assessed."
            }`
          );
        addSection("Physical & Functional Examination", exam);
        addFreeTextSection(
          "Other Physical Examination Comments",
          "other-physical-comments"
        );

        let sysReview = [];
        if (isChecked("dental-health-checkbox"))
          sysReview.push(
            `Dental Health: ${getRadioValue("dental-status") || "N/A"}.${
              getRadioValue("dental-status") === "abnormal"
                ? " Details: " +
                  (getValue("dental-abnormal-details-text") || "N/A")
                : ""
            }`
          );
        if (isChecked("aural-exam-checkbox"))
          sysReview.push(
            `Aural Exam: ${getRadioValue("aural-status") || "N/A"}.${
              getRadioValue("aural-status") === "abnormal"
                ? " Details: " +
                  (getValue("aural-abnormal-details-text") || "N/A")
                : ""
            }. Audiometry in last 5 years: ${
              getRadioValue("audiometry-done") || "N/A"
            }.`
          );
        if (isChecked("ocular-health-checkbox"))
          sysReview.push(
            `Ocular Exam: ${getRadioValue("ocular-status") || "N/A"}.${
              getRadioValue("ocular-status") === "abnormal"
                ? " Details: " +
                  (getValue("ocular-abnormal-details-text") || "N/A")
                : ""
            }. Eye exam in last 5 years: ${
              getRadioValue("eye-exam-done") || "N/A"
            }.`
          );
        addSection("Systematic Review", sysReview);

        let screening = [
          `Immunisations UTD for: ${
            Array.from(
              document.querySelectorAll('input[name="immunisation"]:checked')
            )
              .map((cb) => cb.value)
              .join(", ") || "None"
          }`,
        ];
        if (isChecked("dysphagia-gerd-checkbox"))
          screening.push(
            `Dysphagia/GERD: Issues identified - ${
              getRadioValue("dysphagia-issues") || "N/A"
            }.${
              getRadioValue("dysphagia-issues") === "yes"
                ? " Details: " +
                  (getValue("dysphagia-issues-details-text") || "N/A")
                : ""
            }`
          );
        if (isChecked("thyroid-screening-checkbox"))
          screening.push(
            `Thyroid Screening: Done in last 2 years - ${
              getRadioValue("thyroid-done") || "N/A"
            }.`
          );
        screening.push(
          `Epilepsy diagnosis: ${
            getRadioValue("epilepsy-diagnosis") || "N/A"
          }.${
            getRadioValue("epilepsy-diagnosis") === "yes"
              ? ` Seizure control: ${
                  getValue("epilepsy-review-details") || "N/A"
                }. Recent neuro review: ${
                  getRadioValue("neuro-review") || "N/A"
                }.`
              : ""
          }`
        );
        if (getRadioValue("genetic-referral") === "yes")
          screening.push("Genetic clinic referral indicated.");
        if (isChecked("osteoporosis-risk-checkbox")) {
          let factors = Array.from(
            document.querySelectorAll(
              "#osteoporosis-risk-details-container input[type=checkbox]:checked"
            )
          )
            .map((el) => el.id.replace("osteo-", ""))
            .join(", ");
          screening.push(
            `Osteoporosis Risk Factors considered (${
              factors || "None"
            }). Risk Identified: ${
              getRadioValue("osteo-risk-found") || "N/A"
            }.${
              getRadioValue("osteo-risk-found") === "yes"
                ? " Details: " + (getValue("osteo-risk-details-text") || "N/A")
                : ""
            }`
          );
        }
        addSection("Specific Health Screening & Risks", screening);
        addFreeTextSection(
          "Other Screening & Risk Comments",
          "other-screening-comments"
        );

        let snap = [];
        if (isChecked("assess-smoking-checkbox"))
          snap.push(`Smoking: ${getValue("smoking-status")}`);
        if (isChecked("assess-nutrition-checkbox"))
          snap.push(
            `Nutrition: ${getValue("nutrition-status")}. Details: ${
              getValue("nutrition-details") || "Not specified"
            }`
          );
        if (isChecked("assess-alcohol-checkbox"))
          snap.push(
            `Alcohol: ${getValue("alcohol-drinks")} std drinks / ${getValue(
              "alcohol-period"
            )}`
          );
        if (isChecked("assess-activity-checkbox"))
          snap.push(
            `Physical Activity: ${getValue("activity-minutes")} mins/week`
          );
        const drugUse = getRadioValue("drug-use");
        if (drugUse)
          snap.push(
            `Recreational drug use: ${drugUse}.${
              drugUse === "yes"
                ? ` Details: ${getValue("drug-use-details") || "N/A"}`
                : ""
            }`
          );
        addSection("SNAP & Other Risks", snap);

        let psychSocial = [];
        if (
          isChecked("cognition-assessed-checkbox") &&
          getValue("cognition-tool")
        ) {
          psychSocial.push(
            `Cognition Screen (${getValue("cognition-tool")}): ${
              getValue("cognition-score") || "N/A"
            }`
          );
        }
        if (isChecked("mood-assessed-checkbox") && getValue("mood-tool")) {
          psychSocial.push(
            `Mood Screen (${getValue("mood-tool")}): ${
              getValue("mood-score") || "N/A"
            }`
          );
        }
        if (isChecked("sexual-health-review-checkbox"))
          psychSocial.push(
            `Sexual Health: Issues identified - ${
              getRadioValue("sexual-health-issues") || "N/A"
            }.${
              getRadioValue("sexual-health-issues") === "yes"
                ? ` Details: ${
                    getValue("sexual-health-issues-details-text") || "N/A"
                  }`
                : ""
            }`
          );
        if (isChecked("safety-wellbeing-checkbox"))
          psychSocial.push(
            `Safety & Wellbeing: Issues identified - ${
              getRadioValue("safety-issues") || "N/A"
            }.${
              getRadioValue("safety-issues") === "yes"
                ? ` Details: ${getValue("safety-issues-details-text") || "N/A"}`
                : ""
            }`
          );
        let socialIsoText = `Feels lonely/isolated: ${
          getRadioValue("social-isolation") || "N/A"
        }`;
        if (getRadioValue("social-isolation") === "yes")
          socialIsoText += `. Details: ${
            getValue("social-isolation-details") || "N/A"
          }`;
        psychSocial.push(socialIsoText);
        addSection("Psychological & Social Function", psychSocial);

        addFreeTextSection(
          "MANAGEMENT PLAN & RECOMMENDATIONS",
          "plan-recommendations"
        );

        return report.trim();
      }

      // --- ASSESSMENT MODAL LOGIC (INTEGRATED) ---

      const assessmentTemplates = {
        MMSE: {
          title: "Standardised Mini-Mental State Examination (SMMSE)",
          type: "custom-score",
          maxScore: 30,
          getInterpretation: (score) => {
            if (score >= 24)
              return "Score does not suggest significant cognitive impairment.";
            if (score >= 18) return "Score suggests mild cognitive impairment.";
            if (score >= 10)
              return "Score suggests moderate cognitive impairment.";
            return "Score suggests severe cognitive impairment.";
          },
          html: () => `
                    <div id="assessment-form-content">
                        <div id="mmse-main-form">
                            <div class="task-group">
                                <h4>Orientation to Time (5 points)</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-2">
                                    <label class="checkbox-label"><input type="checkbox" data-score="1"> What year is this?</label>
                                    <label class="checkbox-label"><input type="checkbox" data-score="1"> What season is this?</label>
                                    <label class="checkbox-label"><input type="checkbox" data-score="1"> What month is this?</label>
                                    <label class="checkbox-label"><input type="checkbox" data-score="1"> What is today's date?</label>
                                    <label class="checkbox-label"><input type="checkbox" data-score="1"> What day of the week is this?</label>
                                </div>
                            </div>
                            <div class="task-group">
                                <h4>Orientation to Place (5 points)</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-2">
                                    <label class="checkbox-label"><input type="checkbox" data-score="1"> What country are we in?</label>
                                    <label class="checkbox-label"><input type="checkbox" data-score="1"> What state are we in?</label>
                                    <label class="checkbox-label"><input type="checkbox" data-score="1"> What city/town are we in?</label>
                                    <label class="checkbox-label"><input type="checkbox" data-score="1"> What is the name of this building?</label>
                                    <label class="checkbox-label"><input type="checkbox" data-score="1"> What floor of the building are we on?</label>
                                </div>
                            </div>
                            <div class="task-group">
                                <h4>Registration (3 points)</h4>
                                <p class="text-sm text-gray-600 mb-2">"I am going to name three objects. When I am finished, I want you to repeat them. Remember what they are because I am going to ask you to name them again in a few minutes." (Ball, Car, Man)</p>
                                <input type="number" min="0" max="3" class="input-field" data-score-input placeholder="Score for first attempt (0-3)">
                            </div>
                            <div class="task-group">
                                <h4>Attention & Calculation (5 points)</h4>
                                <p class="text-sm text-gray-600 mb-2">"Spell the word WORLD backwards." (D-L-R-O-W)</p>
                                <input type="number" min="0" max="5" class="input-field" data-score-input placeholder="Enter score (0-5)">
                            </div>
                            <div class="task-group">
                                <h4>Recall (3 points)</h4>
                                <p class="text-sm text-gray-600 mb-2">"Now what were the three objects I asked you to remember?"</p>
                                <input type="number" min="0" max="3" class="input-field" data-score-input placeholder="Enter score (0-3)">
                            </div>
                            <div class="task-group">
                                <h4>Language & Praxis (9 points)</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-2">
                                    <label class="checkbox-label"><input type="checkbox" data-score="1"> Naming a watch (1 pt)</label>
                                    <label class="checkbox-label"><input type="checkbox" data-score="1"> Naming a pencil (1 pt)</label>
                                    <label class="checkbox-label"><input type="checkbox" data-score="1"> Repeating "No ifs, ands, or buts" (1 pt)</label>
                                    <label class="checkbox-label"><input type="checkbox" data-score="1"> Reading and obeying "Close your eyes" (1 pt)</label>
                                    <label class="checkbox-label"><input type="checkbox" data-score="1"> Writing a sentence (1 pt)</label>
                                    <label class="checkbox-label"><input type="checkbox" data-score="1"> Takes paper in correct (non-dominant) hand (1 pt)</label>
                                    <label class="checkbox-label"><input type="checkbox" data-score="1"> Folds paper in half (1 pt)</label>
                                    <label class="checkbox-label"><input type="checkbox" data-score="1"> Puts paper on the floor (1 pt)</label>
                                </div>
                                <div class="mt-4">
                                    <p class="mb-2">Copying intersecting pentagons (1 pt):</p>
                                    <svg width="300" height="150" viewBox="0 0 150 70" class="border rounded-md p-2 bg-white">
                                        <polygon points="50,10 80,30 65,60 35,60 20,30" stroke="black" fill="none" stroke-width="2"/>
                                        <polygon points="100,10 130,30 115,60 85,60 70,30" stroke="black" fill="none" stroke-width="2"/>
                                    </svg>
                                    <label class="checkbox-label mt-2"><input type="checkbox" data-score="1" id="mmse-copy"> Award 1 point if correct</label>
                                </div>
                            </div>
                        </div>
                        <div id="mmse-close-eyes-page" class="hidden text-center py-20">
                            <p class="text-6xl font-bold">Close your eyes</p>
                        </div>
                    </div>
                `,
        },
        MoCA: {
          title: "Montreal Cognitive Assessment (MoCA)",
          type: "custom-score",
          maxScore: 30,
          getInterpretation: (score) => {
            if (score >= 26) return "Score is within the normal range.";
            return "Score < 26 suggests mild cognitive impairment.";
          },
          html: () => `
                    <div id="assessment-form-content" class="space-y-4">
                        <div class="task-group">
                            <h4>Visuospatial / Executive</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <p class="font-medium">Alternating Trail Making (1 pt)</p>
                                    <svg id="trail-making-svg" width="375" height="225" viewBox="0 0 200 120" class="bg-white border rounded-md p-2 mt-2">
                                        <!-- Lines will be drawn here -->
                                    </svg>
                                    <div class="flex space-x-2 mt-2">
                                        <button type="button" id="reset-trails-btn" class="text-xs bg-gray-200 px-2 py-1 rounded">Reset</button>
                                        <label class="checkbox-label text-sm mb-0"><input type="checkbox" data-score="1" id="moca-trails"> Correct</label>
                                    </div>
                                </div>
                                <div class="flex flex-col justify-between">
                                    <div>
                                        <p class="font-medium">Copy Cube (1 pt)</p>
                                        <svg width="180" height="180" viewBox="0 0 80 80" class="bg-white border rounded-md p-2 mt-2">
                                            <rect x="20" y="20" width="40" height="40" stroke="black" fill="none" stroke-width="2"/>
                                            <rect x="35" y="5" width="40" height="40" stroke="black" fill="none" stroke-width="2"/>
                                            <line x1="20" y1="20" x2="35" y2="5" stroke="black" stroke-width="2"/>
                                            <line x1="60" y1="20" x2="75" y2="5" stroke="black" stroke-width="2"/>
                                            <line x1="20" y1="60" x2="35" y2="45" stroke="black" stroke-width="2"/>
                                            <line x1="60" y1="60" x2="75" y2="45" stroke="black" stroke-width="2"/>
                                        </svg>
                                    </div>
                                    <label class="checkbox-label"><input type="checkbox" data-score="1" id="moca-cube"> Correct</label>
                                </div>
                            </div>
                            <div class="mt-4">
                                <p class="font-medium">Draw Clock (ten past eleven) (3 pts)</p>
                                <div class="flex items-center justify-between mt-2">
                                    <svg width="225" height="225" viewBox="0 0 100 100" class="bg-white border rounded-md"><circle cx="50" cy="50" r="45" stroke="black" fill="none" stroke-width="2"/></svg>
                                    <div class="space-y-1">
                                        <label class="checkbox-label"><input type="checkbox" data-score="1" id="moca-clock-contour"> Contour (1 pt)</label>
                                        <label class="checkbox-label"><input type="checkbox" data-score="1" id="moca-clock-numbers"> Numbers (1 pt)</label>
                                        <label class="checkbox-label"><input type="checkbox" data-score="1" id="moca-clock-hands"> Hands (1 pt)</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="task-group">
                            <h4>Naming (3 points)</h4>
                             <div class="grid grid-cols-3 gap-4 items-center text-center">
                                 <div class="flex flex-col items-center">
                                     <a href="https://upload.wikimedia.org/wikipedia/commons/7/73/Lion_waiting_in_Namibia.jpg" target="_blank" onclick="event.preventDefault(); openImagePopup(this.href);" class="text-blue-600 hover:underline mb-2">View Lion</a>
                                     <label class="checkbox-label justify-center"><input type="checkbox" data-score="1" id="moca-name-lion"> Correct</label>
                                 </div>
                                 <div class="flex flex-col items-center">
                                      <a href="https://upload.wikimedia.org/wikipedia/commons/thumb/6/63/Diceros_bicornis_minor_-_Etosha_2014.jpg/1280px-Diceros_bicornis_minor_-_Etosha_2014.jpg" target="_blank" onclick="event.preventDefault(); openImagePopup(this.href);" class="text-blue-600 hover:underline mb-2">View Rhinoceros</a>
                                     <label class="checkbox-label justify-center"><input type="checkbox" data-score="1" id="moca-name-rhino"> Correct</label>
                                 </div>
                                 <div class="flex flex-col items-center">
                                      <a href="https://upload.wikimedia.org/wikipedia/commons/thumb/4/43/07._Camel_Profile%2C_Pushkar%2C_India.jpg/1280px-07._Camel_Profile%2C_Pushkar%2C_India.jpg" target="_blank" onclick="event.preventDefault(); openImagePopup(this.href);" class="text-blue-600 hover:underline mb-2">View Camel</a>
                                     <label class="checkbox-label justify-center"><input type="checkbox" data-score="1" id="moca-name-camel"> Correct</label>
                                 </div>
                             </div>
                        </div>
                        <div class="task-group">
                             <h4>Memory</h4>
                             <p class="text-sm text-gray-600">Read list of 5 words, patient recalls. Perform 2 trials. No points on this part.</p>
                             <p class="font-medium mt-1">FACE, VELVET, CHURCH, DAISY, RED</p>
                        </div>
                        <div class="task-group">
                             <h4>Attention (6 points)</h4>
                             <label class="checkbox-label"><input type="checkbox" data-score="1" id="moca-digit-fwd"> Forward Digit Span correct (1 pt)</label>
                             <label class="checkbox-label"><input type="checkbox" data-score="1" id="moca-digit-bwd"> Backward Digit Span correct (1 pt)</label>
                             <label class="checkbox-label"><input type="checkbox" data-score="1" id="moca-vigilance"> Vigilance (Tapping on 'A') correct (1 pt)</label>
                             <div>
                                 <p class="mt-2 mb-1 font-medium">Serial 7s (93, 86, 79, 72, 65):</p>
                                 <input type="number" min="0" max="3" class="input-field" data-score-input id="moca-serial7" placeholder="Enter score (0-3 pts)">
                             </div>
                        </div>
                        <div class="task-group">
                            <h4>Language (2 points)</h4>
                            <div>
                                <p class="mb-1">Repeat: "I only know that John is the one to help today."</p>
                                <label class="checkbox-label"><input type="checkbox" data-score="1" id="moca-lang-rep1"> Correct (1 pt)</label>
                            </div>
                             <div>
                                <p class="mt-2 mb-1">Repeat: "The cat always hid under the couch when dogs were in the room."</p>
                                <label class="checkbox-label"><input type="checkbox" data-score="1" id="moca-lang-rep2"> Correct (1 pt)</label>
                            </div>
                        </div>
                         <div class="task-group">
                            <h4>Fluency (1 point)</h4>
                            <div>
                                <p class="mt-2 mb-1">Name max words starting with 'F' in 60s. (Score 1 pt if >=11 words)</p>
                                <label class="checkbox-label"><input type="checkbox" data-score="1" id="moca-lang-fluency"> >= 11 words (1 pt)</label>
                            </div>
                        </div>
                        <div class="task-group">
                            <h4>Abstraction (2 points)</h4>
                            <label class="checkbox-label"><input type="checkbox" data-score="1" id="moca-abs-train"> Train-Bicycle (e.g., means of transport) (1 pt)</label>
                            <label class="checkbox-label"><input type="checkbox" data-score="1" id="moca-abs-watch"> Watch-Ruler (e.g., measuring instruments) (1 pt)</label>
                        </div>
                        <div class="task-group">
                             <h4>Delayed Recall (5 points)</h4>
                             <p class="text-sm text-gray-600 mb-2">FACE, VELVET, CHURCH, DAISY, RED. 1 point per word recalled without cues.</p>
                             <input type="number" min="0" max="5" class="input-field" data-score-input id="moca-recall" placeholder="Enter score (0-5)">
                        </div>
                        <div class="task-group">
                            <h4>Orientation (6 points)</h4>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                <label class="checkbox-label"><input type="checkbox" data-score="1"> Date</label>
                                <label class="checkbox-label"><input type="checkbox" data-score="1"> Month</label>
                                <label class="checkbox-label"><input type="checkbox" data-score="1"> Year</label>
                                <label class="checkbox-label"><input type="checkbox" data-score="1"> Day</label>
                                <label class="checkbox-label"><input type="checkbox" data-score="1"> Place</label>
                                <label class="checkbox-label"><input type="checkbox" data-score="1"> City</label>
                            </div>
                        </div>
                        <div class="task-group">
                            <h4>Education adjustment</h4>
                            <label class="checkbox-label"><input type="checkbox" data-score="1" id="moca-education"> Add 1 point if education is 12 years or less</label>
                        </div>
                    </div>
                `,
        },
        K10: {
          title: "Kessler Psychological Distress Scale (K10)",
          type: "radio-sum",
          maxScore: 50,
          getInterpretation: (score) => {
            if (score <= 19)
              return "Score suggests the patient is likely to be well.";
            if (score <= 24) return "Score suggests a mild mental disorder.";
            if (score <= 29)
              return "Score suggests a moderate mental disorder.";
            return "Score suggests a severe mental disorder.";
          },
          html: () => `
                    <p class="text-gray-600 mb-4">Over the last 4 weeks, about how often did the patient feel...</p>
                    <div id="assessment-form-content" class="grid grid-cols-1 md:grid-cols-2 gap-x-8">
                        ${[
                          "Tired out for no good reason?",
                          "Nervous?",
                          "So nervous that nothing could calm them down?",
                          "Hopeless?",
                          "Restless or fidgety?",
                          "So restless they could not sit still?",
                          "Depressed?",
                          "That everything was an effort?",
                          "So sad that nothing could cheer them up?",
                          "Worthless?",
                        ]
                          .map(
                            (q, i) => `
                        <div class="assessment-question">
                            <p class="font-medium mb-2">${i + 1}. ${q}</p>
                            <div class="assessment-options text-sm space-y-2">
                                <label class="radio-label mb-0"><input type="radio" name="k10-q${i}" value="1"> None of the time</label>
                                <label class="radio-label mb-0"><input type="radio" name="k10-q${i}" value="2"> A little of the time</label>
                                <label class="radio-label mb-0"><input type="radio" name="k10-q${i}" value="3"> Some of the time</label>
                                <label class="radio-label mb-0"><input type="radio" name="k10-q${i}" value="4"> Most of the time</label>
                                <label class="radio-label mb-0"><input type="radio" name="k10-q${i}" value="5"> All of the time</label>
                            </div>
                        </div>`
                          )
                          .join("")}
                    </div>
                `,
        },
        GDS: {
          title: "Geriatric Depression Scale (GDS-15)",
          type: "gds-score",
          maxScore: 15,
          getInterpretation: (score) => {
            if (score <= 5) return "Score is within the normal range.";
            return "Score > 5 is suggestive of depression and warrants a follow-up comprehensive assessment.";
          },
          html: () => `
                    <p class="text-gray-600 mb-4">Choose the best answer for how you have felt over the past week.</p>
                    <div id="assessment-form-content" class="grid grid-cols-1 md:grid-cols-2 gap-x-8">
                        ${[
                          {
                            q: "Are you basically satisfied with your life?",
                            depressive: "no",
                          },
                          {
                            q: "Have you dropped many of your activities and interests?",
                            depressive: "yes",
                          },
                          {
                            q: "Do you feel that your life is empty?",
                            depressive: "yes",
                          },
                          { q: "Do you often get bored?", depressive: "yes" },
                          {
                            q: "Are you in good spirits most of the time?",
                            depressive: "no",
                          },
                          {
                            q: "Are you afraid that something bad is going to happen to you?",
                            depressive: "yes",
                          },
                          {
                            q: "Do you feel happy most of the time?",
                            depressive: "no",
                          },
                          {
                            q: "Do you often feel helpless?",
                            depressive: "yes",
                          },
                          {
                            q: "Do you prefer to stay at home, rather than going out and doing new things?",
                            depressive: "yes",
                          },
                          {
                            q: "Do you feel you have more problems with memory than most?",
                            depressive: "yes",
                          },
                          {
                            q: "Do you think it is wonderful to be alive now?",
                            depressive: "no",
                          },
                          {
                            q: "Do you feel pretty worthless the way you are now?",
                            depressive: "yes",
                          },
                          {
                            q: "Do you feel full of energy?",
                            depressive: "no",
                          },
                          {
                            q: "Do you feel that your situation is hopeless?",
                            depressive: "yes",
                          },
                          {
                            q: "Do you think that most people are better off than you are?",
                            depressive: "yes",
                          },
                        ]
                          .map(
                            (item, i) => `
                        <div class="assessment-question">
                            <p class="font-medium mb-2">${i + 1}. ${item.q}</p>
                            <div class="assessment-options text-sm" data-depressive-answer="${
                              item.depressive
                            }">
                                <label class="radio-label mb-0"><input type="radio" name="gds-q${i}" value="yes"> Yes</label>
                                <label class="radio-label mb-0"><input type="radio" name="gds-q${i}" value="no"> No</label>
                            </div>
                        </div>`
                          )
                          .join("")}
                    </div>
                `,
        },
        DASS21: {
          title: "Depression Anxiety Stress Scales (DASS-21)",
          type: "dass-score",
          maxScore: 42, // Per scale
          getInterpretation: (scores) => {
            const { d, a, s } = scores;
            let interp = [];
            // Depression
            if (d <= 9) interp.push("Depression: Normal");
            else if (d <= 13) interp.push("Depression: Mild");
            else if (d <= 20) interp.push("Depression: Moderate");
            else if (d <= 27) interp.push("Depression: Severe");
            else interp.push("Depression: Extremely Severe");
            // Anxiety
            if (a <= 7) interp.push("Anxiety: Normal");
            else if (a <= 9) interp.push("Anxiety: Mild");
            else if (a <= 14) interp.push("Anxiety: Moderate");
            else if (a <= 19) interp.push("Anxiety: Severe");
            else interp.push("Anxiety: Extremely Severe");
            // Stress
            if (s <= 14) interp.push("Stress: Normal");
            else if (s <= 18) interp.push("Stress: Mild");
            else if (s <= 25) interp.push("Stress: Moderate");
            else if (s <= 33) interp.push("Stress: Severe");
            else interp.push("Stress: Extremely Severe");
            return interp.join("; ");
          },
          html: () => `
                     <p class="text-gray-600 mb-4">Please read each statement and indicate how much the statement applied to you <b>over the past week</b>.</p>
                     <div id="assessment-form-content" class="grid grid-cols-1 md:grid-cols-2 gap-x-8">
                         ${[
                           {
                             q: "I found it hard to wind down",
                             scale: "stress",
                           },
                           {
                             q: "I was aware of dryness of my mouth",
                             scale: "anxiety",
                           },
                           {
                             q: "I couldn’t seem to experience any positive feeling at all",
                             scale: "depression",
                           },
                           {
                             q: "I experienced breathing difficulty",
                             scale: "anxiety",
                           },
                           {
                             q: "I found it difficult to work up the initiative to do things",
                             scale: "depression",
                           },
                           {
                             q: "I tended to over-react to situations",
                             scale: "stress",
                           },
                           {
                             q: "I experienced trembling (e.g. in the hands)",
                             scale: "anxiety",
                           },
                           {
                             q: "I felt that I was using a lot of nervous energy",
                             scale: "stress",
                           },
                           {
                             q: "I was worried about situations in which I might panic",
                             scale: "anxiety",
                           },
                           {
                             q: "I felt that I had nothing to look forward to",
                             scale: "depression",
                           },
                           {
                             q: "I found myself getting agitated",
                             scale: "stress",
                           },
                           {
                             q: "I found it difficult to relax",
                             scale: "stress",
                           },
                           {
                             q: "I felt down-hearted and blue",
                             scale: "depression",
                           },
                           {
                             q: "I was intolerant of anything that kept me from getting on",
                             scale: "stress",
                           },
                           {
                             q: "I felt I was close to panic",
                             scale: "anxiety",
                           },
                           {
                             q: "I was unable to become enthusiastic about anything",
                             scale: "depression",
                           },
                           {
                             q: "I felt I was not worth much as a person",
                             scale: "depression",
                           },
                           {
                             q: "I felt that I was rather touchy",
                             scale: "stress",
                           },
                           {
                             q: "I was aware of the action of my heart in the absence of physical exertion",
                             scale: "anxiety",
                           },
                           {
                             q: "I felt scared without any good reason",
                             scale: "anxiety",
                           },
                           {
                             q: "I felt that life was meaningless",
                             scale: "depression",
                           },
                         ]
                           .map(
                             (item, i) => `
                         <div class="assessment-question" data-scale="${
                           item.scale
                         }">
                             <p class="font-medium mb-2">${i + 1}. ${item.q}</p>
                             <div class="assessment-options text-sm space-y-2">
                                 <label class="radio-label mb-0"><input type="radio" name="dass-q${i}" value="0"> Did not apply to me at all</label>
                                 <label class="radio-label mb-0"><input type="radio" name="dass-q${i}" value="1"> Applied to me to some degree</label>
                                 <label class="radio-label mb-0"><input type="radio" name="dass-q${i}" value="2"> Applied to me to a considerable degree</label>
                                 <label class="radio-label mb-0"><input type="radio" name="dass-q${i}" value="3"> Applied to me very much</label>
                             </div>
                         </div>`
                           )
                           .join("")}
                     </div>
                `,
        },
      };

      function calculateCurrentScore(template) {
        let score = 0;
        if (!modalBody) return 0;

        if (template.type === "custom-score") {
          modalBody
            .querySelectorAll("[data-score]:checked")
            .forEach((checkbox) => {
              score += parseInt(checkbox.dataset.score) || 0;
            });
          modalBody.querySelectorAll("[data-score-input]").forEach((input) => {
            score += parseInt(input.value) || 0;
          });
        } else if (
          template.type === "radio-sum" ||
          template.type === "dass-score"
        ) {
          modalBody
            .querySelectorAll('input[type="radio"]:checked')
            .forEach((radio) => {
              score += parseInt(radio.value) || 0;
            });
        } else if (template.type === "gds-score") {
          modalBody
            .querySelectorAll(".assessment-options")
            .forEach((optionSet) => {
              const depressiveAnswer = optionSet.dataset.depressiveAnswer;
              const selectedRadio = optionSet.querySelector(
                'input[type="radio"]:checked'
              );
              if (selectedRadio && selectedRadio.value === depressiveAnswer) {
                score++;
              }
            });
        }
        return score;
      }

      function generateAssessmentTextReport(template) {
        let report = "";
        const modal = document.getElementById("assessment-modal");
        if (!modal) return "";

        const formContainer = template.title.includes("MMSE")
          ? modal.querySelector("#mmse-main-form")
          : modal.querySelector("#assessment-form-content");

        formContainer
          .querySelectorAll(".task-group, .assessment-question")
          .forEach((group) => {
            const titleEl = group.querySelector("h4, p.font-medium");
            if (titleEl) {
              const titleText = titleEl.textContent.trim();
              if (titleText) {
                report += `${titleText}\n`;
                report += "-".repeat(titleText.length) + "\n";
              }
            }

            const instructionEl = group.querySelector("p.text-sm");
            if (instructionEl) {
              report += `  Instruction: ${instructionEl.textContent.trim()}\n`;
            }

            group
              .querySelectorAll('input[type="checkbox"], input[type="radio"]')
              .forEach((input) => {
                const label = input.closest("label");
                if (label) {
                  const symbol = input.checked ? "[X]" : "[ ]";
                  report += `  ${symbol} ${label.textContent.trim()}\n`;
                }
              });

            group
              .querySelectorAll('input[type="number"], input[type="text"]')
              .forEach((input) => {
                if (input.value) {
                  report += `  - Response: ${input.value}\n`;
                }
              });
            report += "\n";
          });
        return report;
      }

      function handleFinalise(template, targetInputId) {
        try {
          let finalScore = calculateCurrentScore(template);
          const targetInput = document.getElementById(targetInputId);
          const interpretationBox = targetInput.parentElement.querySelector(
            ".interpretation-box"
          );

          if (!targetInput) {
            console.error("Target input not found:", targetInputId);
            return;
          }

          lastCompletedAssessment.text = generateAssessmentTextReport(template);
          lastCompletedAssessment.title = template.title;

          targetInput.removeAttribute("data-dass-d");
          targetInput.removeAttribute("data-dass-a");
          targetInput.removeAttribute("data-dass-s");

          if (template.type === "dass-score") {
            let depressionScore = 0,
              anxietyScore = 0,
              stressScore = 0;
            modalBody.querySelectorAll(".assessment-question").forEach((q) => {
              const scale = q.dataset.scale;
              const checkedRadio = q.querySelector(
                'input[type="radio"]:checked'
              );
              if (checkedRadio) {
                const value = parseInt(checkedRadio.value) || 0;
                if (scale === "depression") depressionScore += value;
                else if (scale === "anxiety") anxietyScore += value;
                else if (scale === "stress") stressScore += value;
              }
            });

            const finalDepression = depressionScore * 2;
            const finalAnxiety = anxietyScore * 2;
            const finalStress = stressScore * 2;

            const dassResultsEl = document.getElementById("dass-results");
            if (dassResultsEl) {
              dassResultsEl.innerHTML = `
                            <span class="mr-4">Depression: <b>${finalDepression}</b></span>
                            <span class="mr-4">Anxiety: <b>${finalAnxiety}</b></span>
                            <span>Stress: <b>${finalStress}</b></span>
                        `;
            }

            targetInput.setAttribute("data-dass-d", finalDepression);
            targetInput.setAttribute("data-dass-a", finalAnxiety);
            targetInput.setAttribute("data-dass-s", finalStress);

            targetInput.value = `D:${finalDepression}, A:${finalAnxiety}, S:${finalStress}`;
            if (interpretationBox && template.getInterpretation) {
              interpretationBox.textContent = template.getInterpretation({
                d: finalDepression,
                a: finalAnxiety,
                s: finalStress,
              });
              interpretationBox.classList.remove("hidden");
            }
            setTimeout(closeAssessmentModal, 4000);
          } else {
            targetInput.value = `${finalScore} / ${template.maxScore}`;
            if (interpretationBox && template.getInterpretation) {
              interpretationBox.textContent =
                template.getInterpretation(finalScore);
              interpretationBox.classList.remove("hidden");
            }
            closeAssessmentModal();
          }
          targetInput.dispatchEvent(new Event("change", { bubbles: true })); // Trigger plan update
        } catch (error) {
          console.error("Error during finalisation:", error);
          closeAssessmentModal();
        }
      }

      function openImagePopup(url) {
        window.open(
          url,
          "image-popup",
          "height=600,width=800,resizable=yes,scrollbars=yes"
        );
      }

      function openAssessmentModal(toolKey, targetInputId) {
        const template = assessmentTemplates[toolKey];
        if (!template) return;

        modalTitle.textContent = template.title;
        modalBody.innerHTML = template.html();

        let actionButtonsHtml = `
                <div id="dass-results" class="text-sm font-semibold"></div>
                <div class="flex space-x-4 ml-auto">
                    <button id="print-assessment-btn" class="bg-gray-500 text-white font-bold py-2 px-5 rounded-lg hover:bg-gray-600">Print Form</button>
                    <button id="modal-action-btn" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-blue-700">
                        ${toolKey === "MMSE" ? "Next" : "Finalise & Close"}
                    </button>
                </div>
            `;
        modalFooter.innerHTML = actionButtonsHtml;

        assessmentModal.classList.remove("hidden");

        const updateScore = () => {
          const currentScore = calculateCurrentScore(template);
          modalScoreDisplay.textContent = `Score: ${currentScore}`;
        };

        modalBody.addEventListener("change", updateScore);
        updateScore();

        if (toolKey === "MoCA") {
          setupTrailMaking();
        }

        const modalActionBtn = document.getElementById("modal-action-btn");

        const finaliseListener = () => handleFinalise(template, targetInputId);

        if (toolKey === "MMSE") {
          const handleMmseNext = () => {
            document.getElementById("mmse-main-form").classList.add("hidden");
            document
              .getElementById("mmse-close-eyes-page")
              .classList.remove("hidden");
            modalActionBtn.textContent = "Finalise & Close";
            modalActionBtn.removeEventListener("click", handleMmseNext);
            modalActionBtn.addEventListener("click", finaliseListener);
          };
          modalActionBtn.addEventListener("click", handleMmseNext);
        } else {
          modalActionBtn.addEventListener("click", finaliseListener);
        }

        document
          .getElementById("print-assessment-btn")
          .addEventListener("click", () => {
            printAssessmentForm(template.title);
          });
      }

      function setupTrailMaking() {
        const svg = document.getElementById("trail-making-svg");
        if (!svg) return;

        const points = [
          { x: 20, y: 20, label: "1", id: "1" },
          { x: 100, y: 30, label: "A", id: "A" },
          { x: 150, y: 20, label: "2", id: "2" },
          { x: 40, y: 70, label: "B", id: "B" },
          { x: 180, y: 70, label: "3", id: "3" },
          { x: 120, y: 100, label: "C", id: "C" },
          { x: 20, y: 100, label: "4", id: "4" },
          { x: 70, y: 50, label: "D", id: "D" },
          { x: 160, y: 90, label: "5", id: "5" },
          { x: 80, y: 80, label: "E", id: "E" },
        ];

        let path = [];

        points.forEach((p) => {
          const group = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "g"
          );
          group.classList.add("trail-making-node");
          group.setAttribute("id", `node-${p.id}`);

          const circle = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "circle"
          );
          circle.setAttribute("cx", p.x);
          circle.setAttribute("cy", p.y);
          circle.setAttribute("r", 12);
          circle.setAttribute("stroke", "black");
          circle.setAttribute("fill", "white");

          const text = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "text"
          );
          text.setAttribute("x", p.x);
          text.setAttribute("y", p.y + 4);
          text.setAttribute("text-anchor", "middle");
          text.textContent = p.label;

          group.appendChild(circle);
          group.appendChild(text);
          svg.appendChild(group);

          group.addEventListener("click", () => {
            if (!path.find((pt) => pt.id === p.id)) {
              path.push(p);
              group.classList.add("clicked");
              drawLines();
            }
          });
        });

        const lineGroup = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "g"
        );
        lineGroup.setAttribute("id", "trail-lines");
        svg.prepend(lineGroup);

        function drawLines() {
          lineGroup.innerHTML = "";
          for (let i = 0; i < path.length - 1; i++) {
            const line = document.createElementNS(
              "http://www.w3.org/2000/svg",
              "line"
            );
            line.setAttribute("x1", path[i].x);
            line.setAttribute("y1", path[i].y);
            line.setAttribute("x2", path[i + 1].x);
            line.setAttribute("y2", path[i + 1].y);
            line.setAttribute("stroke", "#2563eb");
            line.setAttribute("stroke-width", "2");
            lineGroup.appendChild(line);
          }
        }

        document
          .getElementById("reset-trails-btn")
          .addEventListener("click", () => {
            path = [];
            lineGroup.innerHTML = "";
            svg
              .querySelectorAll(".trail-making-node")
              .forEach((n) => n.classList.remove("clicked"));
          });
      }

      function printAssessmentForm(title) {
        const printWindow = window.open("", "", "height=800,width=800");
        printWindow.document.write(
          "<html><head><title>Print Assessment</title>"
        );
        // Basic print styling
        printWindow.document.write(`
                <style>
                    body { font-family: sans-serif; line-height: 1.5; }
                    h2 { font-size: 1.5rem; margin-bottom: 1rem; }
                    .task-group, .assessment-question { 
                        border: 1px solid #ccc; 
                        border-radius: 8px; 
                        padding: 15px; 
                        margin-bottom: 15px; 
                        page-break-inside: avoid;
                    }
                    h4 { font-size: 1.1rem; margin-top: 0; }
                    svg, img { max-width: 200px; }
                    input[type=checkbox], input[type=radio] { margin-right: 5px; }
                    input[type=number] { 
                        border: 1px solid #ccc; 
                        border-radius: 4px; 
                        padding: 4px; 
                        width: 60px;
                    }
                    label { display: block; margin-bottom: 5px; }
                    .assessment-options label { display: inline-block; margin-right: 15px; }
                </style>
            `);
        printWindow.document.write("</head><body>");
        printWindow.document.write(`<h2>${title}</h2>`);
        printWindow.document.write(modalBody.innerHTML);
        printWindow.document.write("</body></html>");
        printWindow.document.close();
        printWindow.focus();
        setTimeout(() => {
          printWindow.print();
          printWindow.close();
        }, 250);
      }

      function closeAssessmentModal() {
        assessmentModal.classList.add("hidden");
        modalBody.innerHTML = "";
        modalFooter.innerHTML = "";
      }

      modalCloseBtn.addEventListener("click", closeAssessmentModal);
      assessmentModal.addEventListener("click", (e) => {
        if (e.target === assessmentModal) {
          closeAssessmentModal();
        }
      });

      // --- Initial Load ---
      document.addEventListener("DOMContentLoaded", () => {
        // Check if there is saved data in local storage
        if (localStorage.getItem(localStorageKey)) {
          // If data exists, show the restore modal
          document
            .getElementById("restore-session-modal")
            .classList.remove("hidden");
        } else {
          // Otherwise, initialize a blank form
          initializeForm();
        }

        // Add event listener for the "Restore Session" button
        document
          .getElementById("restore-session-btn")
          .addEventListener("click", () => {
            initializeForm(); // Build the form structure first
            loadFormFromLocalStorage(); // Then populate it with saved data
            document
              .getElementById("restore-session-modal")
              .classList.add("hidden");
          });

        // Add event listener for the "Start Fresh" button
        document
          .getElementById("start-fresh-btn")
          .addEventListener("click", () => {
            localStorage.removeItem(localStorageKey); // Clear the saved data
            initializeForm(); // Initialize a blank form
            document
              .getElementById("restore-session-modal")
              .classList.add("hidden");
          });
      });
    </script>
  </body>
</html>
