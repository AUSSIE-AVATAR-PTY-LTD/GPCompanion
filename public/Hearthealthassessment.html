<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heart Health Check</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* bg-gray-100 */
        }
        .chevron-icon {
            transition: transform 0.3s ease-in-out;
        }
        .chevron-icon.rotated {
            transform: rotate(180deg);
        }
        .form-section-content.collapsed {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            opacity: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, opacity 0.3s ease-in-out, padding 0.5s ease-in-out;
        }
         .form-section-content {
            transition: max-height 0.5s ease-in-out, opacity 0.3s ease-in-out;
            max-height: 8000px; /* A large value to allow for content */
            opacity: 1;
        }
        /* Styles for the custom modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 400px;
        }
        .info-icon {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            margin-left: 0.5rem;
            cursor: help;
            color: #64748b;
        }
        .risk-display {
            text-align: center;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            font-size: 1.1rem;
            font-weight: 600;
        }
        .risk-low { background-color: #dcfce7; color: #166534; }
        .risk-intermediate { background-color: #fef9c3; color: #854d0e; }
        .risk-high { background-color: #fee2e2; color: #991b1b; }
        .goals-box {
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1rem;
            background-color: #f8fafc;
            margin-top: 1rem;
        }
        .goals-box h4 {
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }
        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
        }
        .snap-item {
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        .snap-item-header {
            display: flex;
            align-items: center;
        }
        .snap-item-details {
            padding-top: 0.75rem;
            margin-top: 0.75rem;
            border-top: 1px solid #e2e8f0;
        }
    </style>
</head>
<body class="text-gray-800">
    
<nav
      class="w-full bg-white border-b border-gray-200 fixed top-0 left-0 z-50"
    >
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
          <a href="/" class="flex items-center space-x-3">
            <img
              src="/images/gp-companion-logo.png"
              alt="GP Companion Logo"
              width="40"
              height="40"
              class="w-10 h-10"
            />
            <span class="font-bold text-xl text-gray-900">GP Companion</span>
          </a>

          <div class="hidden md:flex items-center space-x-8">
            <a
              href="/about"
              class="text-gray-500 hover:text-indigo-600 transition-colors"
              >About Website</a
            >
            <a
              href="/developer"
              class="text-gray-500 hover:text-indigo-600 transition-colors"
              >Developer</a
            >
            <a
              href="/privacy"
              class="text-gray-500 hover:text-indigo-600 transition-colors"
              >Privacy Policy</a
            >
            <a
              href="/contact"
              class="text-gray-500 hover:text-indigo-600 transition-colors"
              >Contact Developer</a
            >
            <a
              href="/gpccmp"
              class="inline-flex items-center px-3 py-2 bg-indigo-600 text-white rounded-md text-sm shadow-sm hover:bg-indigo-700"
              >Start GPCCMP</a
            >
          </div>

          <div class="md:hidden">
            <button
              type="button"
              class="inline-flex items-center p-2 rounded-md text-gray-600 hover:bg-gray-100"
            >
              <span class="sr-only">Open menu</span>
              <svg
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                aria-hidden="true"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 6h16M4 12h16M4 18h16"
                />
              </svg>
            </button>
          </div>
        </div>
      </div>
    </nav>

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 mt-12">
        <header class="text-center mb-10">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Heart Health Check</h1>
            <p class="text-md text-gray-600 mt-2">GP Health Assessment Tool (MBS Items 699/177)</p>
            <p class="text-sm text-gray-700 mt-4 font-semibold">Developed by Dr Bobby Tork MD, FRACGP-RG</p>
            <p class="text-xs text-gray-500 mt-1">&copy; 2025 Dr Bobby Tork</p>
        </header>

        <div class="max-w-4xl mx-auto">
            <div id="form-container"></div>

            <div id="action-buttons" class="mt-8 flex justify-end space-x-4">
                <button id="clear-form-btn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-gray-600 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">Clear Form</button>
                <button id="patient-goals-btn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">Patient Goals Summary</button>
                <button id="save-txt-btn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">Save as .txt</button>
                <button id="save-rtf-btn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Save as .rtf</button>
            </div>

            <div id="report-container" class="mt-10 hidden">
                <div class="mb-10 border border-gray-200 rounded-xl shadow-lg overflow-hidden">
                    <div class="p-6 bg-white">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Generated Assessment Report</h2>
                        <pre id="report-output" class="p-4 bg-gray-50 rounded-lg whitespace-pre-wrap font-mono text-sm"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="easter-egg-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <p class="font-semibold">Developed by Dr Bobby Tork MD, FRACGP-RG</p>
            <p class="text-sm">&copy; 2025 Dr Bobby Tork</p>
            <button id="close-easter-egg" class="mt-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700">Close</button>
        </div>
    </div>
    <div id="clear-confirm-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-2">Are you sure?</h3>
            <p class="text-gray-600 mb-4">All entered data will be lost. This action cannot be undone.</p>
            <div class="flex justify-center space-x-4">
                 <button id="cancel-clear-btn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-gray-700 bg-gray-200 hover:bg-gray-300">Cancel</button>
                 <button id="confirm-clear-btn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700">Clear Form</button>
            </div>
        </div>
    </div>
    <!-- New Restore Session Modal -->
    <div id="restore-session-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-2">Previous Session Found</h3>
            <p class="text-gray-600 mb-4">Would you like to restore your previous data or start a new session?</p>
            <div class="flex justify-center space-x-4">
                 <button id="start-fresh-btn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-gray-700 bg-gray-200 hover:bg-gray-300">Start Fresh</button>
                 <button id="restore-session-btn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700">Restore Session</button>
            </div>
        </div>
    </div>

    <footer
      class="bg-indigo-950 text-indigo-100 border-t border-indigo-800 mt-auto"
    >
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
          <div class="col-span-1 md:col-span-2">
            <div class="flex items-center space-x-3 mb-4">
              <div
                class="w-9 h-9 bg-indigo-600 rounded-lg flex items-center justify-center shadow-sm"
              >
                <span class="text-white font-bold text-lg">GP</span>
              </div>
              <span class="font-bold text-xl text-white">
                GP Companion
              </span>
            </div>

            <p class="text-indigo-200 text-sm max-w-md">
              Comprehensive medical tools and health assessments designed for
              healthcare professionals. Streamline your workflow with our
              secure, privacy-focused platform.
            </p>
          </div>

          <div>
            <h3 class="font-semibold text-white mb-4">Quick Links</h3>
            <ul class="space-y-2">
              <li>
                <a
                  href="/about"
                  class="text-indigo-200 hover:text-white transition-colors text-sm"
                >
                  About Website
                </a>
              </li>
              <li>
                <a
                  href="/developer"
                  class="text-indigo-200 hover:text-white transition-colors text-sm"
                >
                  Developer
                </a>
              </li>
              <li>
                <a
                  href="/privacy"
                  class="text-indigo-200 hover:text-white transition-colors text-sm"
                >
                  Privacy Policy
                </a>
              </li>
              <li>
                <a
                  href="/contact"
                  class="text-indigo-200 hover:text-white transition-colors text-sm"
                >
                  Contact Developer
                </a>
              </li>
            </ul>
          </div>

          <div>
            <h3 class="font-semibold text-white mb-4">Tools</h3>
            <ul class="space-y-2">
              <li>
                <span class="text-indigo-200 text-sm">GPCCMP Tool</span>
              </li>
              <li>
                <span class="text-indigo-200 text-sm">
                  Health Assessments
                </span>
              </li>
              <li>
                <span class="text-indigo-200 text-sm">
                  75+ Health Assessment
                </span>
              </li>
              <li>
                <span class="text-indigo-200 text-sm">
                  ATSI Health Assessment
                </span>
              </li>
            </ul>
          </div>
        </div>

        <div class="border-t border-indigo-800 mt-8 pt-8 text-center">
          <p class="text-indigo-300 text-sm">
            © 2024 GP Companion. All rights reserved. Designed for healthcare
            professionals.
          </p>
        </div>
      </div>
    </footer>


    <script>
        // --- DOM Element References & State Variables ---
        const formContainer = document.getElementById('form-container');
        const clearFormBtn = document.getElementById('clear-form-btn');
        const saveTxtBtn = document.getElementById('save-txt-btn');
        const saveRtfBtn = document.getElementById('save-rtf-btn');
        const actionButtons = document.getElementById('action-buttons');
        const reportContainer = document.getElementById('report-container');
        const reportOutput = document.getElementById('report-output');
        const LOCAL_STORAGE_KEY = 'heartHealthFormData';
        let bmiChartInstance, cholesterolChartInstance;
        let lastGeneratedPlan = new Set();
        let lastGeneratedLifestyleGoals = new Set();
        let lastGeneratedMedicalGoals = new Set();

        // --- Helper Functions ---
        const getChevronIcon = () => `<svg class="chevron-icon w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>`;
        const getInfoIcon = (title) => `<svg class="info-icon" title="${title}" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>`;
        
        function formatAusDate(dateString) {
            if (!dateString) return 'N/A';
            const [year, month, day] = dateString.split('-');
            return `${day}/${month}/${year}`;
        }

        // --- Dynamic Form Generation ---
        function getHeartHealthFormHtml() {
            const today = new Date().toISOString().slice(0, 10);
            return `
                ${getMbsSectionHtml()}
                ${getPatientDetailsHtml(today)}
                ${getMedicalHistoryHtml()}
                ${getSnapSectionHtml()}
                ${getExamAndInvestigationsHtml()}
                ${getVisualSummaryHtml()}
                ${getAbsoluteCVDRiskHtml()}
                ${getPlanAndRecommendationsHtml()}
                ${getReviewHtml()}
            `;
        }

        function getMbsSectionHtml() {
            return `
            <div class="mb-10 border border-gray-200 rounded-xl shadow-lg overflow-hidden">
                <div class="text-xl font-bold text-white bg-indigo-700 px-6 py-3 flex justify-between items-center cursor-pointer"><h2 class="form-section-title text-white">MBS Item Number</h2>${getChevronIcon()}</div>
                <div class="p-6 bg-white form-section-content">
                    <label class="block text-lg font-medium text-gray-700 mb-3">Select the appropriate MBS item number (assessment must be at least 20 minutes):</label>
                    <div class="space-y-3">
                        <label class="flex items-center"><input type="radio" name="mbs-item" value="699" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded mr-3"> <b>Item 699</b> - Performed by a medical practitioner.</label>
                        <label class="flex items-center"><input type="radio" name="mbs-item" value="177" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded mr-3"> <b>Item 177</b> - Performed on behalf of a medical practitioner by a practice nurse or Aboriginal and Torres Strait Islander health practitioner.</label>
                    </div>
                    <div id="assessment-frequency-note" class="mt-4 p-3 bg-indigo-50 rounded-lg text-sm text-indigo-800">This health assessment is available annually to an eligible patient.</div>
                </div>
            </div>`;
        }
        
        function getPatientDetailsHtml(today) {
            return `
            <div class="mb-10 border border-gray-200 rounded-xl shadow-lg overflow-hidden">
                <div class="text-xl font-bold text-white bg-indigo-700 px-6 py-3 flex justify-between items-center cursor-pointer"><h2 class="form-section-title text-white">Patient Details</h2>${getChevronIcon()}</div>
                <div class="p-6 bg-white form-section-content">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 items-start">
                        <div><label for="patient-name" class="block text-sm font-medium text-gray-700 mb-1">Name: <span class="text-gray-400 font-normal">(optional)</span></label><input type="text" id="patient-name" class="block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm"></div>
                        <div><label for="assessment-date" class="block text-sm font-medium text-gray-700 mb-1">Assessment Date:</label><input type="date" id="assessment-date" class="block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm" value="${today}"></div>
                        <div><label for="patient-dob" class="block text-sm font-medium text-gray-700 mb-1">DOB: <span class="text-red-500 font-bold">*</span></label><input type="date" id="patient-dob" class="block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm"></div>
                        <div class="self-end"><div id="patient-age-display" class="p-3 bg-gray-100 rounded-md text-center font-medium h-full flex items-center justify-center">Age will be calculated</div></div>
                        <div><label for="patient-medicare" class="block text-sm font-medium text-gray-700 mb-1">Medicare No: <span class="text-gray-400 font-normal">(optional)</span></label><input type="text" id="patient-medicare" class="block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm"></div>
                        <div>
                            <label for="patient-gender" class="block text-sm font-medium text-gray-700 mb-1">Sex at birth: <span class="text-red-500 font-bold">*</span></label>
                            <select id="patient-gender" class="block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm">
                                <option value="">Select</option><option value="male">Male</option><option value="female">Female</option>
                            </select>
                        </div>
                        <div class="sm:col-span-2">
                            <label for="patient-ethnicity" class="block text-sm font-medium text-gray-700 mb-1">Ethnicity:</label>
                            <select id="patient-ethnicity" class="block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm">
                                <option value="other">Other/Not Stated</option><option value="atsi">Aboriginal or Torres Strait Islander</option><option value="east-asian">East Asian (e.g., Chinese, Japanese)</option><option value="south-asian">South Asian (e.g., Indian, Pakistani)</option><option value="maori-pacific">Māori or Pacific Islander</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function getMedicalHistoryHtml() {
            return `
            <div class="mb-10 border border-gray-200 rounded-xl shadow-lg overflow-hidden">
                <div class="text-xl font-bold text-white bg-indigo-700 px-6 py-3 flex justify-between items-center cursor-pointer"><h2 class="form-section-title text-white">Medical History</h2>${getChevronIcon()}</div>
                <div class="p-6 bg-white form-section-content">
                    <h3 class="text-lg font-semibold text-gray-800 mt-4 mb-2 border-b pb-2">Conditions conferring high CVD risk</h3>
                    <label class="flex items-center my-2"><input type="checkbox" id="hist-ckd" class="h-4 w-4 text-indigo-600 mr-2"> Moderate-severe chronic kidney disease ${getInfoIcon('Sustained eGFR <45 mL/min/1.73m² or persistent significant albuminuria.')}</label>
                    <label class="flex items-center my-2"><input type="checkbox" id="hist-fh" class="h-4 w-4 text-indigo-600 mr-2"> Diagnosed Familial Hypercholesterolaemia (FH)</label>
                    <h3 class="text-lg font-semibold text-gray-800 mt-4 mb-2 border-b pb-2">Other History</h3>
                    <label class="flex items-center my-2"><input type="checkbox" id="hist-afib" class="h-4 w-4 text-indigo-600 mr-2"> History of Atrial Fibrillation</label>
                    <label class="flex items-center my-2"><input type="checkbox" id="hist-htn" class="h-4 w-4 text-indigo-600 mr-2"> History of Hypertension</label>
                    <label class="flex items-center my-2"><input type="checkbox" id="hist-diabetes" class="h-4 w-4 text-indigo-600 mr-2"> History of Diabetes <span class="text-red-500 font-bold">*</span></label>
                    <div id="diabetes-details" class="pl-6 hidden"><select id="diabetes-type" class="block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm"><option value="">Select type</option><option value="type1">Type 1</option><option value="type2">Type 2</option><option value="gestational">Gestational</option></select></div>
                    <label class="flex items-center my-2"><input type="checkbox" id="hist-smi" class="h-4 w-4 text-indigo-600 mr-2"> History of Severe Mental Illness</label>
                    <label for="family-history-cvd" class="block font-medium mb-1 mt-4">Family History of premature CVD:</label>
                    <select id="family-history-cvd" class="block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm mb-4"><option value="no">No</option><option value="yes">Yes</option></select>
                    <label for="personal-history" class="block font-medium mb-1">Other relevant medical history:</label>
                    <textarea id="personal-history" class="block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm h-20" placeholder="e.g., Other conditions..."></textarea>
                </div>
            </div>`;
        }

        function getSnapSectionHtml() {
            return `
            <div class="mb-10 border border-gray-200 rounded-xl shadow-lg overflow-hidden">
                <div class="text-xl font-bold text-white bg-indigo-700 px-6 py-3 flex justify-between items-center cursor-pointer"><h2 class="form-section-title">SNAP Assessment</h2>${getChevronIcon()}</div>
                <div class="p-6 bg-white form-section-content">
                    <p class="text-gray-600 mb-4">Assessment of Smoking, Nutrition, Alcohol, and Physical Activity.</p>
                    
                    <div class="space-y-4">
                        <!-- Smoking -->
                        <div class="snap-item">
                            <div class="snap-item-header">
                                <input type="checkbox" id="assess-smoking" class="h-4 w-4 text-indigo-600 mr-3">
                                <label for="assess-smoking" class="font-semibold text-gray-800">S - Smoking Status <span class="text-red-500 font-bold">*</span></label>
                            </div>
                            <div id="smoking-details-container" class="snap-item-details hidden">
                                <div class="flex items-center space-x-4">
                                    <select id="smoking-status" class="block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm">
                                        <option value="">Select status...</option>
                                        <option value="current">Current Smoker</option>
                                        <option value="ex">Ex-smoker</option>
                                        <option value="non">Non-smoker</option>
                                    </select>
                                    <input type="text" id="smoking-pack-years" class="block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm hidden" placeholder="Pack Years...">
                                </div>
                            </div>
                        </div>

                        <!-- Nutrition -->
                        <div class="snap-item">
                            <div class="snap-item-header">
                                <input type="checkbox" id="assess-nutrition" class="h-4 w-4 text-indigo-600 mr-3">
                                <label for="assess-nutrition" class="font-semibold text-gray-800">N - Nutrition</label>
                            </div>
                            <div id="nutrition-details-container" class="snap-item-details hidden">
                                 <div class="flex items-center space-x-4">
                                     <select id="nutrition-status" class="block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm">
                                         <option value="">Select diet type...</option>
                                         <option value="balanced">Balanced</option>
                                         <option value="poor">Poor</option>
                                     </select>
                                     <input type="text" id="nutrition-details" class="block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm hidden" placeholder="Details...">
                                 </div>
                            </div>
                        </div>

                        <!-- Alcohol -->
                        <div class="snap-item">
                            <div class="snap-item-header">
                                <input type="checkbox" id="assess-alcohol" class="h-4 w-4 text-indigo-600 mr-3">
                                <label for="assess-alcohol" class="font-semibold text-gray-800">A - Alcohol</label>
                            </div>
                            <div id="alcohol-details-container" class="snap-item-details hidden">
                                <div class="flex items-center space-x-2">
                                    <input type="number" id="alcohol-drinks" class="block w-1/2 px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm" placeholder="Standard drinks">
                                    <select id="alcohol-period" class="block w-1/2 px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm">
                                        <option value="week">per week</option>
                                        <option value="day">per day</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Physical Activity -->
                        <div class="snap-item">
                            <div class="snap-item-header">
                                <input type="checkbox" id="assess-activity" class="h-4 w-4 text-indigo-600 mr-3">
                                <label for="assess-activity" class="font-semibold text-gray-800">P - Physical Activity</label>
                            </div>
                            <div id="activity-details-container" class="snap-item-details hidden">
                                <div class="flex items-center space-x-2">
                                    <input type="number" id="activity-minutes" class="block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm" placeholder="Minutes of exercise">
                                    <span class="text-gray-600">per week</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            `;
        }

        function getExamAndInvestigationsHtml() {
            return `
            <div class="mb-10 border border-gray-200 rounded-xl shadow-lg overflow-hidden">
                <div class="text-xl font-bold text-white bg-indigo-700 px-6 py-3 flex justify-between items-center cursor-pointer"><h2 class="form-section-title text-white">Examination & Investigations</h2>${getChevronIcon()}</div>
                <div class="p-6 bg-white form-section-content">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800 mt-4 mb-2 border-b pb-2">Physical Examination</h3>
                            
                            <label class="block font-medium mb-2 text-sm">Vitals</label>
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label for="bp-systolic" class="block text-xs font-medium text-gray-600">Systolic BP *</label>
                                    <input type="number" id="bp-systolic" class="block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm">
                                </div>
                                <div>
                                    <label for="bp-diastolic" class="block text-xs font-medium text-gray-600">Diastolic BP</label>
                                    <input type="number" id="bp-diastolic" class="block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm">
                                </div>
                                <div>
                                    <label for="hr" class="block text-xs font-medium text-gray-600">Heart Rate</label>
                                    <input type="number" id="hr" class="block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm">
                                </div>
                                <div>
                                    <label for="rhythm" class="block text-xs font-medium text-gray-600">Rhythm</label>
                                    <select id="rhythm" class="block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm h-10">
                                        <option value="Regular">Regular</option>
                                        <option value="Irregular">Irregular</option>
                                        <option value="Irregularly Irregular">Irregularly Irregular</option>
                                    </select>
                                </div>
                            </div>
                            
                            <label class="block font-medium mb-2 text-sm">Anthropometry</label>
                            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-4">
                                <div>
                                    <label for="height-cm" class="block text-xs font-medium text-gray-600">Height (cm)</label>
                                    <input type="number" id="height-cm" class="block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm">
                                </div>
                                <div>
                                    <label for="weight-kg" class="block text-xs font-medium text-gray-600">Weight (kg)</label>
                                    <input type="number" id="weight-kg" class="block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm">
                                </div>
                                <div>
                                    <label for="bmi" class="block text-xs font-medium text-gray-600">BMI (kg/m²)</label>
                                    <input type="text" id="bmi" class="block w-full px-3 py-2 bg-gray-200 border border-gray-300 rounded-md shadow-sm" readonly>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600">Category</label>
                                    <div id="bmi-category" class="w-full h-10 bg-gray-100 rounded-md flex items-center justify-center text-sm font-semibold"></div>
                                </div>
                            </div>

                            <label class="flex items-center my-2"><input type="checkbox" id="cv-exam-tick" class="h-4 w-4 text-indigo-600 mr-2">Cardiovascular Examination</label>
                            <div id="cv-exam-box" class="pl-6 hidden"><textarea id="cv-exam-findings" class="block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm h-20" placeholder="Enter CVS findings..."></textarea></div>
                            <label for="other-exam-findings" class="block font-medium mb-1 mt-4">Other Examination Findings:</label>
                            <textarea id="other-exam-findings" class="block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm h-20" placeholder="Enter other relevant examination findings..."></textarea>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800 mt-4 mb-2 border-b pb-2">Pathology & Other Tests</h3>
                            <label class="block font-medium mb-2 text-sm">Lipids</label>
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div><input type="number" step="0.1" id="total-cholesterol" class="block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm" placeholder="Total Chol *"></div>
                                <div><input type="number" step="0.1" id="hdl-cholesterol" class="block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm" placeholder="HDL Chol *"></div>
                            </div>
                            <label for="blood-glucose" class="block font-medium mb-1">Blood Glucose (HbA1c %):</label>
                            <input type="text" id="blood-glucose" class="block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm mb-4" placeholder="e.g., 5.7">
                            <label class="flex items-center my-2"><input type="checkbox" id="hist-ecg" class="h-4 w-4 text-indigo-600 mr-2">ECG Performed (Item 11707)</label>
                            <div id="ecg-interpretation-box" class="pl-6 hidden"><textarea id="ecg-interpretation" class="block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm h-20" placeholder="Enter ECG interpretation..."></textarea></div>
                            <label class="flex items-center my-2"><input type="checkbox" id="hist-abi" class="h-4 w-4 text-indigo-600 mr-2">ABI Performed (Item 11610)</label>
                            <div id="abi-details-box" class="pl-6 hidden">
                                <div class="grid grid-cols-2 gap-4">
                                    <div><input type="number" step="0.01" id="abi-left" class="block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm" placeholder="Left ABI"></div>
                                    <div><input type="number" step="0.01" id="abi-right" class="block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm" placeholder="Right ABI"></div>
                                </div>
                            </div>
                            <label for="other-pathology" class="block font-medium mb-1 mt-4">Other Pathology & Relevant Tests:</label>
                            <textarea id="other-pathology" class="block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm h-20" placeholder="Enter other relevant pathology results..."></textarea>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function getVisualSummaryHtml() {
            return `
            <div class="mb-10 border border-gray-200 rounded-xl shadow-lg overflow-hidden">
                <div class="text-xl font-bold text-white bg-indigo-700 px-6 py-3 flex justify-between items-center cursor-pointer"><h2 class="form-section-title text-white">Visual Health Summary</h2>${getChevronIcon()}</div>
                <div class="p-6 bg-white form-section-content">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800 text-center mb-2 border-b pb-2">BMI Category</h3>
                            <div class="chart-container"><canvas id="bmiChart"></canvas></div>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800 text-center mb-2 border-b pb-2">Cholesterol Ratio</h3>
                            <div class="chart-container"><canvas id="cholesterolChart"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function getAbsoluteCVDRiskHtml() {
            return `
            <div class="mb-10 border border-gray-200 rounded-xl shadow-lg overflow-hidden">
                <div class="text-xl font-bold text-white bg-indigo-700 px-6 py-3 flex justify-between items-center cursor-pointer"><h2 class="form-section-title text-white">Absolute CVD Risk Assessment</h2>${getChevronIcon()}</div>
                <div class="p-6 bg-white form-section-content">
                    <p class="mb-2 text-sm">Calculated based on the Australian absolute cardiovascular disease risk calculator algorithm. For clinical decisions, please verify with the official online tool: <a href="https://www.cvdcheck.org.au/" target="_blank" class="text-blue-600 hover:underline">www.cvdcheck.org.au</a></p>
                    <p class="text-xs text-gray-500 mb-4"><span class="text-red-500 font-bold">*</span> Indicates a field required for CVD risk calculation.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-gray-50 p-4 rounded-lg">
                        <div>
                            <label for="cvd-risk-score" class="block font-medium mb-1">Calculated 5-year CVD Risk Score (%):</label>
                            <input type="text" id="cvd-risk-score" class="block w-full px-3 py-2 bg-gray-200 border border-gray-300 rounded-md shadow-sm text-2xl font-bold" readonly>
                        </div>
                        <div>
                            <label for="cvd-risk-category" class="block font-medium mb-1">Calculated Risk Category:</label>
                            <input type="text" id="cvd-risk-category" class="block w-full px-3 py-2 bg-gray-200 border border-gray-300 rounded-md shadow-sm text-2xl font-bold" readonly>
                        </div>
                    </div>
                    <div id="risk-interpretation" class="risk-display hidden"></div>
                    <div id="reclassification-note" class="mt-4 p-3 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 rounded-md hidden"></div>
                </div>
            </div>`;
        }

        function getPlanAndRecommendationsHtml() {
            return `
            <div class="mb-10 border border-gray-200 rounded-xl shadow-lg overflow-hidden">
                <div class="text-xl font-bold text-white bg-indigo-700 px-6 py-3 flex justify-between items-center cursor-pointer"><h2 class="form-section-title text-white">Plan & Recommendations</h2>${getChevronIcon()}</div>
                <div class="p-6 bg-white form-section-content">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8">
                        <div class="goals-box">
                            <h4 for="lifestyle-goals-textarea">Lifestyle Goals</h4>
                            <textarea id="lifestyle-goals-textarea" class="block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm h-32 mt-2" placeholder="Goals will be auto-generated here. You can add or edit them."></textarea>
                        </div>
                        <div class="goals-box">
                            <h4 for="medical-goals-textarea">Medical Goals</h4>
                            <textarea id="medical-goals-textarea" class="block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm h-32 mt-2" placeholder="Goals will be auto-generated here. You can add or edit them."></textarea>
                        </div>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800 mt-6 mb-2 border-b pb-2">Management Plan</h3>
                    <label for="plan-details" class="block font-medium mb-1 text-sm">Review and edit the automatically generated plan below. Add any other specific tasks, referrals, or medication changes.</label>
                    <textarea id="plan-details" class="block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm h-48" placeholder="e.g., Refer to Dietitian for tailored advice on DASH diet..."></textarea>
                </div>
            </div>`;
        }

        function getReviewHtml() {
            return `
            <div class="mb-10 border border-gray-200 rounded-xl shadow-lg overflow-hidden">
                <div class="text-xl font-bold text-white bg-indigo-700 px-6 py-3 flex justify-between items-center cursor-pointer"><h2 class="form-section-title text-white">Review</h2>${getChevronIcon()}</div>
                <div class="p-6 bg-white form-section-content">
                    <div class="flex items-center gap-4">
                        <label for="review-date" class="font-medium text-gray-700 flex-shrink-0">Recommended Review Date:</label>
                        <input type="date" id="review-date" class="block w-auto px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm">
                    </div>
                </div>
            </div>`;
        }
        
        // --- CORE SCRIPT LOGIC ---
        function initializeForm() {
            formContainer.innerHTML = getHeartHealthFormHtml();
            actionButtons.classList.remove('hidden');
            reportContainer.classList.add('hidden');
            reportOutput.textContent = '';
            addAccordionListeners();
            addDynamicListeners();
            renderBmiChart();
            renderCholesterolChart();
            calculateAndSetReviewDate();
        }

        function addAccordionListeners() {
            document.querySelectorAll('.bg-indigo-700').forEach(header => {
                header.addEventListener('click', () => {
                    const content = header.nextElementSibling;
                    const chevron = header.querySelector('.chevron-icon');
                    content.classList.toggle('collapsed');
                    chevron.classList.toggle('rotated');
                });
            });
        }

        function addDynamicListeners() {
            const patientNameInput = document.getElementById('patient-name');

            // --- EASTER EGG ---
            if (patientNameInput) {
                patientNameInput.addEventListener('input', (e) => {
                    // Obfuscated trigger phrase: "big brother!" is "YmlnIGJyb3RoZXIh" in Base64
                    if (e.target.value.toLowerCase() === atob('YmlnIGJyb3RoZXIh')) {
                        document.getElementById('easter-egg-modal').classList.remove('hidden');
                    }
                });
            }
             document.getElementById('close-easter-egg').addEventListener('click', () => {
                 document.getElementById('easter-egg-modal').classList.add('hidden');
             });
            // --- END EASTER EGG ---

            const allInputs = formContainer.querySelectorAll('input, select, textarea');
            allInputs.forEach(el => {
                el.addEventListener('input', handleFormUpdate);
                el.addEventListener('change', handleFormUpdate);
            });

            document.getElementById('assessment-date')?.addEventListener('change', calculateAndSetReviewDate);
            document.getElementById('hist-diabetes')?.addEventListener('change', (e) => {
                document.getElementById('diabetes-details').classList.toggle('hidden', !e.target.checked);
            });
            document.getElementById('hist-ecg')?.addEventListener('change', (e) => {
                document.getElementById('ecg-interpretation-box').classList.toggle('hidden', !e.target.checked);
            });
            document.getElementById('hist-abi')?.addEventListener('change', (e) => {
                document.getElementById('abi-details-box').classList.toggle('hidden', !e.target.checked);
            });
            document.getElementById('cv-exam-tick')?.addEventListener('change', (e) => {
                document.getElementById('cv-exam-box').classList.toggle('hidden', !e.target.checked);
            });

            // SNAP Listeners
            const setupToggle = (checkboxId, detailsId) => {
                const checkbox = document.getElementById(checkboxId);
                const details = document.getElementById(detailsId);
                if (checkbox && details) {
                    checkbox.addEventListener('change', e => {
                        details.classList.toggle('hidden', !e.target.checked);
                        handleFormUpdate();
                    });
                }
            };
            
            const toggleMap = {
                'assess-smoking': 'smoking-details-container', 'assess-nutrition': 'nutrition-details-container',
                'assess-alcohol': 'alcohol-details-container', 'assess-activity': 'activity-details-container',
            };
            Object.entries(toggleMap).forEach(([checkboxId, detailsId]) => setupToggle(checkboxId, detailsId));

            document.getElementById('smoking-status')?.addEventListener('change', e => {
                document.getElementById('smoking-pack-years').classList.toggle('hidden', e.target.value !== 'current');
            });
            document.getElementById('nutrition-status')?.addEventListener('change', e => {
                document.getElementById('nutrition-details').classList.toggle('hidden', e.target.value === '');
            });

            // Add listener for the new Patient Goals button
            document.getElementById('patient-goals-btn')?.addEventListener('click', showPatientGoalsSummary);
        }

        function handleFormUpdate() {
            calculateAndDisplayAge();
            calculateBMI();
            calculateCvdRisk();
            generateManagementPlan();
            renderBmiChart();
            renderCholesterolChart();
            saveFormToLocalStorage(); // Auto-save on every update
        }

        function calculateAndSetReviewDate() {
            const assessmentDateEl = document.getElementById('assessment-date');
            const reviewDateEl = document.getElementById('review-date');
            if (!assessmentDateEl || !reviewDateEl) return;

            const assessmentDate = assessmentDateEl.value ? new Date(assessmentDateEl.value) : new Date();
            const nextYear = new Date(Date.UTC(assessmentDate.getFullYear() + 1, assessmentDate.getMonth(), assessmentDate.getDate()));
            
            const day = nextYear.getUTCDay(); // 0 = Sunday, 6 = Saturday
            if (day === 6) { // Saturday
                nextYear.setUTCDate(nextYear.getUTCDate() + 2);
            } else if (day === 0) { // Sunday
                nextYear.setUTCDate(nextYear.getUTCDate() + 1);
            }
            reviewDateEl.value = nextYear.toISOString().slice(0, 10);
        }

        function calculateAndDisplayAge() {
            const dob = document.getElementById('patient-dob')?.value;
            const ageDisplay = document.getElementById('patient-age-display');
            if (!dob || !ageDisplay) return null;
            const birthDate = new Date(dob);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
            ageDisplay.innerHTML = `Age: ${age}`;
            return age;
        }

        function calculateBMI() {
            const height = parseFloat(document.getElementById('height-cm')?.value);
            const weight = parseFloat(document.getElementById('weight-kg')?.value);
            const bmiInput = document.getElementById('bmi');
            const bmiCategoryDisplay = document.getElementById('bmi-category');
            if (!bmiInput || !bmiCategoryDisplay) return;

            if (height > 0 && weight > 0) {
                const bmi = (weight / ((height / 100) ** 2));
                bmiInput.value = bmi.toFixed(2);

                let category = '';
                let textClass = 'text-gray-800';
                let bgClass = 'bg-gray-200';

                if (bmi < 18.5) {
                    category = 'Underweight';
                    textClass = 'text-blue-800';
                    bgClass = 'bg-blue-100';
                } else if (bmi < 25) {
                    category = 'Healthy';
                    textClass = 'text-green-800';
                    bgClass = 'bg-green-100';
                } else if (bmi < 30) {
                    category = 'Overweight';
                    textClass = 'text-yellow-800';
                    bgClass = 'bg-yellow-100';
                } else {
                    category = 'Obese';
                    textClass = 'text-red-800';
                    bgClass = 'bg-red-100';
                }
                bmiCategoryDisplay.textContent = category;
                bmiCategoryDisplay.className = `w-full h-10 rounded-md flex items-center justify-center text-sm font-semibold ${textClass} ${bgClass}`;

            } else {
                bmiInput.value = '';
                bmiCategoryDisplay.textContent = '';
                bmiCategoryDisplay.className = 'w-full h-10 bg-gray-100 rounded-md flex items-center justify-center text-sm font-semibold';
            }
        }


        function calculateCvdRisk() {
            const riskScoreEl = document.getElementById('cvd-risk-score');
            const riskCategoryEl = document.getElementById('cvd-risk-category');
            const reclassNoteEl = document.getElementById('reclassification-note');
            const riskInterpretationEl = document.getElementById('risk-interpretation');
            
            riskScoreEl.value = ''; riskCategoryEl.value = '';
            reclassNoteEl.classList.add('hidden');
            riskInterpretationEl.classList.add('hidden');

            if (document.getElementById('hist-ckd')?.checked || document.getElementById('hist-fh')?.checked) {
                riskScoreEl.value = 'N/A';
                riskCategoryEl.value = 'High Risk (clinically determined)';
                riskInterpretationEl.textContent = 'This patient is at HIGH RISK of a heart attack or stroke in the next 5 years due to their medical history.';
                riskInterpretationEl.className = 'risk-display risk-high';
                riskInterpretationEl.classList.remove('hidden');
                return;
            }

            const age = calculateAndDisplayAge();
            const gender = document.getElementById('patient-gender')?.value;
            const smokingStatus = document.getElementById('smoking-status')?.value;
            const isSmoker = smokingStatus === 'current';

            const systolicBp = parseInt(document.getElementById('bp-systolic')?.value, 10);
            const totalChol = parseFloat(document.getElementById('total-cholesterol')?.value);
            const hdlChol = parseFloat(document.getElementById('hdl-cholesterol')?.value);
            const hasDiabetes = document.getElementById('hist-diabetes')?.checked;

            if (!age || !gender || !systolicBp || !totalChol || !hdlChol) return;

            let points = 0;
            if (gender === 'male') {
                if (age >= 35 && age <= 39) points -= 2; if (age >= 40 && age <= 44) points += 0; if (age >= 45 && age <= 49) points += 2; if (age >= 50 && age <= 54) points += 3; if (age >= 55 && age <= 59) points += 4; if (age >= 60 && age <= 64) points += 5; if (age >= 65 && age <= 69) points += 6; if (age >= 70 && age <= 74) points += 7;
            } else {
                if (age >= 35 && age <= 39) points -= 3; if (age >= 40 && age <= 44) points += 0; if (age >= 45 && age <= 49) points += 1; if (age >= 50 && age <= 54) points += 2; if (age >= 55 && age <= 59) points += 3; if (age >= 60 && age <= 64) points += 4; if (age >= 65 && age <= 69) points += 5; if (age >= 70 && age <= 74) points += 6;
            }
            if (isSmoker) points += (gender === 'male' ? 2 : 3);
            if (hasDiabetes) points += (gender === 'male' ? 2 : 3);
            if (systolicBp >= 120 && systolicBp < 140) points += (gender === 'male' ? 0 : 1); else if (systolicBp >= 140 && systolicBp < 160) points += (gender === 'male' ? 1 : 2); else if (systolicBp >= 160) points += (gender === 'male' ? 2 : 3);
            const cholRatio = totalChol / hdlChol;
            if (cholRatio >= 4 && cholRatio < 5) points += 1; else if (cholRatio >= 5 && cholRatio < 6) points += 2; else if (cholRatio >= 6) points += 3;

            const riskMap = { '-3': '<2', '-2': '<2', '-1': '<2', '0': '2', '1': '2', '2': '3', '3': '3', '4': '4', '5': '5', '6': '6', '7': '7', '8': '9', '9': '11', '10': '13', '11': '16', '12': '19', '13': '23', '14': '>25' };
            let riskPercentStr = riskMap[Math.max(-3, Math.min(14, points))] || '>25';
            let riskPercent = parseFloat(riskPercentStr.replace(/[><]/g, ''));

            riskScoreEl.value = riskPercentStr + '%';

            let category = 'High Risk (≥10%)';
            if (riskPercent < 5) category = 'Low Risk (<5%)';
            else if (riskPercent >= 5 && riskPercent < 10) category = 'Intermediate Risk (5 to <10%)';
            
            const ethnicity = document.getElementById('patient-ethnicity')?.value;
            const famHistory = document.getElementById('family-history-cvd')?.value === 'yes';
            const hasSMI = document.getElementById('hist-smi')?.checked;
            let reclassified = false;
            let reclassReason = '';

            if (category === 'Intermediate Risk (5 to <10%)' && (ethnicity === 'atsi' || ethnicity === 'south-asian' || ethnicity === 'maori-pacific' || famHistory || hasSMI)) {
                category = 'High Risk (≥10%)';
                reclassified = true;
                reclassReason = 'Risk reclassified to HIGH due to ethnicity, family history, or severe mental illness.';
            }

            riskCategoryEl.value = category;
            
            if (category.includes('Low')) {
                riskInterpretationEl.textContent = 'This means less than 5 in 100 people like you will have a heart attack or stroke in the next 5 years.';
                riskInterpretationEl.className = 'risk-display risk-low';
            } else if (category.includes('Intermediate')) {
                riskInterpretationEl.textContent = 'This means between 5 and 10 in 100 people like you will have a heart attack or stroke in the next 5 years.';
                riskInterpretationEl.className = 'risk-display risk-intermediate';
            } else { // High
                riskInterpretationEl.textContent = 'This means at least 10 in 100 people like you will have a heart attack or stroke in the next 5 years.';
                riskInterpretationEl.className = 'risk-display risk-high';
            }
            riskInterpretationEl.classList.remove('hidden');

            if (reclassified) {
                reclassNoteEl.textContent = reclassReason;
                reclassNoteEl.classList.remove('hidden');
            }
        }
        
        function generateManagementPlan() {
            const lifestyleEl = document.getElementById('lifestyle-goals-textarea');
            const medicalEl = document.getElementById('medical-goals-textarea');
            const finalPlanEl = document.getElementById('plan-details');

            const lifestyleGoals = new Set();
            const medicalGoals = new Set();
            const newGeneratedPlan = new Set();
            
            const addUnique = (set, value) => { if (value) set.add(value); };

            const goals = {
                smoking: {
                    lifestyle: ['- Access Quitline (13 78 48) for tailored coaching and support.', '- Discuss nicotine replacement therapy (NRT) options with GP or pharmacist.'],
                    medical: ['- Set a quit date and create a smoking cessation plan.'],
                    plan: ['- Prescribe NRT or other smoking cessation aids (e.g., varenicline) as appropriate.', '- Schedule follow-up appointment in 1-2 weeks to review progress on quitting.']
                },
                nutrition: {
                    lifestyle: ['- Adopt a portion-controlled, whole-food diet, reducing intake of processed foods and sugary drinks.', '- Follow a heart-healthy diet (e.g., DASH or Mediterranean style).'],
                    medical: ['- Achieve and maintain a healthy body weight (BMI < 25 kg/m²).'],
                    plan: ['- Refer to an Accredited Practising Dietitian for a personalised nutrition plan.']
                },
                bmi: {
                    lifestyle: ['- Aim for 150-300 minutes of moderate-intensity exercise (e.g., brisk walking, cycling) per week.'],
                    medical: ['- Achieve and maintain a healthy body weight (BMI < 25 kg/m²).'],
                    plan: ['- Provide a green prescription for a structured exercise program or local walking group.']
                },
                activity: {
                    lifestyle: ['- Incorporate at least 30 minutes of structured exercise on 5 or more days a week.', '- Reduce sedentary time by taking short 5-minute walking breaks every hour.'],
                    medical: ['- Meet the national physical activity guidelines (150-300 mins/week).'],
                    plan: ['- Refer to an Exercise Physiologist for a tailored and safe exercise prescription.', '- Recommend use of a pedometer or activity tracker to monitor daily steps, aiming for 10,000 steps/day.']
                },
                alcohol: {
                    lifestyle: ['- Have at least two alcohol-free days per week.', '- Alternate alcoholic drinks with water to reduce overall consumption.'],
                    medical: ['- Limit alcohol to ≤10 standard drinks/week and ≤4 on any one day.'],
                    plan: ['- Provide education on standard drink sizes and the link between alcohol and blood pressure.', '- Screen for alcohol dependence and refer to drug and alcohol counselling services if indicated.']
                },
                bp: {
                    lifestyle: ['- Follow the DASH (Dietary Approaches to Stop Hypertension) diet, rich in fruits, vegetables, and low-fat dairy.', '- Reduce sodium intake by avoiding processed foods and added salt.'],
                    medical: ['- Maintain a home blood pressure diary, checking BP twice daily for one week.'],
                    plan: ['- Initiate or titrate blood pressure-lowering medication to achieve target BP < 130/80 mmHg.', '- Arrange for a 24-hour ambulatory blood pressure monitor if office readings are variable.']
                },
                diabetes: {
                    lifestyle: ['- Engage in regular blood glucose monitoring as advised.', '- Prioritise low glycaemic index carbohydrates and regular meals to manage blood sugar levels.'],
                    medical: ['- Achieve target HbA1c < 7% (53 mmol/mol) or as individually advised.'],
                    plan: ['- Refer to a Credentialled Diabetes Educator for self-management support and education.', '- Review current diabetes medications and adjust regimen to optimise glycaemic control and cardiovascular benefit (e.g., consider SGLT2i/GLP-1RA).']
                },
                ckd: { plan: ['- Review medications to ensure appropriate dosing for renal function and avoid nephrotoxic agents.', '- Refer to a Nephrologist for specialist co-management.'] },
                afib: { plan: ['- Ensure appropriate anticoagulation is in place based on CHA₂DS₂-VASc score to prevent stroke.', '- Discuss rate vs. rhythm control strategy and refer to a Cardiologist if not already managed.'] },
                fh: { plan: ['- Initiate high-intensity statin therapy and consider ezetimibe to achieve at least a 50% reduction in LDL-C.', '- Arrange for cascade screening of first-degree relatives.'] },
                smi: { plan: ['- Establish collaborative care with the patient’s mental health team to integrate physical and mental health management.', '- Annually screen for metabolic syndrome and manage components aggressively.'] },
                famHistory: { plan: ['- Emphasise aggressive lifestyle modification and risk factor control from an earlier age.', '- Consider earlier and more frequent screening for lipids and blood pressure.'] },
                intermediateRisk: { plan: ['- Discuss the role of coronary artery calcium (CAC) scoring to further refine risk and guide management decisions.', '- Schedule a 6-monthly review to monitor risk factors and reinforce lifestyle changes.'] },
                highRisk: { plan: ['- Initiate aspirin 100mg daily for secondary prevention if CVD is established, or for primary prevention in select cases after discussing benefits/risks.', '- Set up a GP Management Plan (GPMP) and Team Care Arrangements (TCA) to facilitate multidisciplinary care.'] }
            };

            // --- Check SNAP inputs and add goals ---
            if (document.getElementById('smoking-status')?.value === 'current') {
                goals.smoking.lifestyle.forEach(g => addUnique(lifestyleGoals, g));
                addUnique(medicalGoals, goals.smoking.medical[0]);
                goals.smoking.plan.forEach(p => addUnique(newGeneratedPlan, p));
            }
            if (document.getElementById('nutrition-status')?.value === 'poor') {
                goals.nutrition.lifestyle.forEach(g => addUnique(lifestyleGoals, g));
                addUnique(medicalGoals, goals.nutrition.medical[0]);
                goals.nutrition.plan.forEach(p => addUnique(newGeneratedPlan, p));
            }
            const activityMins = parseInt(document.getElementById('activity-minutes')?.value, 10);
            if (!isNaN(activityMins) && activityMins < 150) {
                goals.activity.lifestyle.forEach(g => addUnique(lifestyleGoals, g));
                addUnique(medicalGoals, goals.activity.medical[0]);
                goals.activity.plan.forEach(p => addUnique(newGeneratedPlan, p));
            }
            const alcoholDrinks = parseInt(document.getElementById('alcohol-drinks')?.value, 10);
            const alcoholPeriod = document.getElementById('alcohol-period')?.value;
            if (!isNaN(alcoholDrinks) && ((alcoholPeriod === 'week' && alcoholDrinks > 10) || (alcoholPeriod === 'day' && alcoholDrinks > 4))) {
                goals.alcohol.lifestyle.forEach(g => addUnique(lifestyleGoals, g));
                addUnique(medicalGoals, goals.alcohol.medical[0]);
                goals.alcohol.plan.forEach(p => addUnique(newGeneratedPlan, p));
            }

            // --- Check other inputs ---
            if (parseFloat(document.getElementById('bmi')?.value) >= 25) {
                goals.bmi.lifestyle.forEach(g => addUnique(lifestyleGoals, g));
                if (!medicalGoals.has(goals.bmi.medical[0])) { 
                    addUnique(medicalGoals, goals.bmi.medical[0]);
                }
                goals.bmi.plan.forEach(p => addUnique(newGeneratedPlan, p));
            }
            if (parseInt(document.getElementById('bp-systolic')?.value, 10) >= 140 || parseInt(document.getElementById('bp-diastolic')?.value, 10) >= 90) {
                goals.bp.lifestyle.forEach(g => addUnique(lifestyleGoals, g));
                addUnique(medicalGoals, goals.bp.medical[0]);
                goals.bp.plan.forEach(p => addUnique(newGeneratedPlan, p));
            }
            if (document.getElementById('hist-diabetes')?.checked) {
                goals.diabetes.lifestyle.forEach(g => addUnique(lifestyleGoals, g));
                addUnique(medicalGoals, goals.diabetes.medical[0]);
                goals.diabetes.plan.forEach(p => addUnique(newGeneratedPlan, p));
            }
            if (document.getElementById('hist-ckd')?.checked) goals.ckd.plan.forEach(p => addUnique(newGeneratedPlan, p));
            if (document.getElementById('hist-afib')?.checked) goals.afib.plan.forEach(p => addUnique(newGeneratedPlan, p));
            if (document.getElementById('hist-fh')?.checked) goals.fh.plan.forEach(p => addUnique(newGeneratedPlan, p));
            if (document.getElementById('hist-smi')?.checked) goals.smi.plan.forEach(p => addUnique(newGeneratedPlan, p));
            if (document.getElementById('family-history-cvd')?.value === 'yes') goals.famHistory.plan.forEach(p => addUnique(newGeneratedPlan, p));
            
            const abiLeft = parseFloat(document.getElementById('abi-left')?.value);
            const abiRight = parseFloat(document.getElementById('abi-right')?.value);
            if ((!isNaN(abiLeft) && abiLeft < 0.9) || (!isNaN(abiRight) && abiRight < 0.9)) {
                addUnique(newGeneratedPlan, '- ABI < 0.9 suggests Peripheral Vascular Disease. Consider referral for vascular ultrasound and/or to a vascular surgeon.');
            }

            const riskCategory = document.getElementById('cvd-risk-category')?.value || '';
            if (riskCategory.includes('Intermediate')) goals.intermediateRisk.plan.forEach(p => addUnique(newGeneratedPlan, p));
            if (riskCategory.includes('High')) goals.highRisk.plan.forEach(p => addUnique(newGeneratedPlan, p));

            // --- Reconcile All Textareas ---

            const reconcileTextarea = (textareaEl, newContentSet, lastContentSet, placeholder) => {
                const linesToAdd = new Set([...newContentSet].filter(line => !lastContentSet.has(line)));
                const linesToRemove = new Set([...lastContentSet].filter(line => !newContentSet.has(line)));

                if (linesToAdd.size > 0 || linesToRemove.size > 0) {
                    const currentLines = textareaEl.value.split('\n');
                    const filteredLines = currentLines.filter(line => !linesToRemove.has(line) && line.trim() !== '' && line !== placeholder);
                    
                    linesToAdd.forEach(line => {
                        if (!filteredLines.includes(line)) {
                            filteredLines.push(line);
                        }
                    });

                    const finalText = filteredLines.join('\n');
                    textareaEl.value = finalText.trim().length > 0 ? finalText : (placeholder || '');
                }
            };
            
            reconcileTextarea(lifestyleEl, lifestyleGoals, lastGeneratedLifestyleGoals, 'No specific lifestyle goals generated.');
            reconcileTextarea(medicalEl, medicalGoals, lastGeneratedMedicalGoals, 'No specific medical goals generated.');
            reconcileTextarea(finalPlanEl, newGeneratedPlan, lastGeneratedPlan, 'No specific management plan generated. Please add notes manually.');

            // Update the record of what was last generated for the next reconciliation cycle.
            lastGeneratedLifestyleGoals = lifestyleGoals;
            lastGeneratedMedicalGoals = medicalGoals;
            lastGeneratedPlan = newGeneratedPlan;
        }

        function buildReportFromForm(format = 'text') {
            let textReport = '';
            let rtfReport = '{\\rtf1\\ansi\\deff0{\\fonttbl{\\f0 Inter;}}\\pard\\sa0\\sl276\\slmult1 ';

            const getValue = id => document.getElementById(id)?.value.trim() || '';
            const getRadioValue = name => document.querySelector(`input[name="${name}"]:checked`)?.value || 'N/A';
            const isChecked = id => document.getElementById(id)?.checked;
            const getCheckboxState = id => isChecked(id) ? 'Yes' : 'No';
            const escapeRtf = (str) => str.replace(/\\/g, '\\\\').replace(/{/g, '\\{').replace(/}/g, '\\}').replace(/\n/g, '\\par\n');

            const addSection = (title, contentLines) => {
                const cleanedContent = contentLines.filter(line => line && line.trim() !== '' && !line.endsWith(': N/A') && !line.endsWith(': '));
                if (cleanedContent.length === 0) return;

                textReport += `${title.toUpperCase()}:\n${cleanedContent.map(line => `  - ${line}`).join('\n')}\n\n`;
                rtfReport += `{\\pard\\sa100\\sl276\\slmult1\\b\\ul ${escapeRtf(title.toUpperCase())}\\ul0\\b0\\par}`;
                cleanedContent.forEach(line => {
                    rtfReport += `{\\pard\\fi360\\sa100\\sl276\\slmult1\\fs22  - ${escapeRtf(line)}\\par}`;
                });
            };
            
            const addFreeTextSection = (title, elementId) => {
                const content = getValue(elementId);
                if (!content || content === 'N/A') return;

                textReport += `${title.toUpperCase()}:\n${content}\n\n`;
                rtfReport += `{\\pard\\sa100\\sl276\\slmult1\\b\\ul ${escapeRtf(title.toUpperCase())}\\ul0\\b0\\par}`;
                const lines = content.split('\n');
                lines.forEach(line => {
                    if (line.startsWith('- ')) {
                        rtfReport += `{\\pard\\fi360\\sa100\\sl276\\slmult1\\fs22  - ${escapeRtf(line.substring(2))}\\par}`;
                    } else if (line.trim() !== '') {
                        rtfReport += `{\\pard\\sa100\\sl276\\slmult1\\fs22 ${escapeRtf(line)}\\par}`;
                    } else {
                        rtfReport += `{\\pard\\sa100\\sl276\\slmult1\\fs22\\par}`;
                    }
                });
            };
            
            // --- Header ---
            const headerTitle = "Assessment: Heart Health Check";
            const mbsItem = `MBS Item Number: ${getRadioValue('mbs-item')}`;
            textReport += `${headerTitle}\n${mbsItem}\n\n`;
            rtfReport += `{\\pard\\qc\\b\\fs32 ${escapeRtf(headerTitle)}\\par}`;
            rtfReport += `{\\pard\\qc\\fs24 ${escapeRtf(mbsItem)}\\par\\par}`;

            // --- Patient Details ---
            let patientDetails = [
                `Name: ${getValue('patient-name') || 'N/A'}`,
                `Medicare No: ${getValue('patient-medicare') || 'N/A'}`,
                `DOB: ${formatAusDate(getValue('patient-dob'))}`,
                document.getElementById('patient-age-display')?.textContent || 'Age: N/A',
                `Sex at Birth: ${getValue('patient-gender')}`,
                `Ethnicity: ${getValue('patient-ethnicity')}`,
                `Assessment Date: ${formatAusDate(getValue('assessment-date'))}`
            ];
            addSection('PATIENT DETAILS', patientDetails);

            // --- Medical History ---
            let medicalHistory = [
                `Moderate-severe CKD: ${getCheckboxState('hist-ckd')}`, 
                `Familial Hypercholesterolaemia: ${getCheckboxState('hist-fh')}`, 
                `History of Atrial Fibrillation: ${getCheckboxState('hist-afib')}`, 
                `History of Hypertension: ${getCheckboxState('hist-htn')}`, 
                `History of Diabetes: ${getCheckboxState('hist-diabetes')} (${getValue('diabetes-type')})`, 
                `History of Severe Mental Illness: ${getCheckboxState('hist-smi')}`, 
                `Family History of premature CVD: ${getValue('family-history-cvd')}`
            ];
            addSection('MEDICAL HISTORY', medicalHistory);
            addFreeTextSection('Other Medical History', 'personal-history');

            // --- SNAP Assessment ---
            let snapItems = [];
            if (isChecked('assess-smoking')) snapItems.push(`Smoking: ${getValue('smoking-status') || 'Not specified'}${getValue('smoking-status') === 'current' ? ` (Pack Years: ${getValue('smoking-pack-years') || 'N/A'})` : ''}`);
            if (isChecked('assess-nutrition')) snapItems.push(`Nutrition: ${getValue('nutrition-status') || 'Not specified'}${getValue('nutrition-details') ? ` (Details: ${getValue('nutrition-details')})` : ''}`);
            if (isChecked('assess-alcohol')) snapItems.push(`Alcohol: ${getValue('alcohol-drinks') || 'N/A'} standard drinks ${getValue('alcohol-period')}`);
            if (isChecked('assess-activity')) snapItems.push(`Physical Activity: ${getValue('activity-minutes') || 'N/A'} minutes per week`);
            addSection('SNAP ASSESSMENT', snapItems);

            // --- Examination ---
            const getBmiSummary = () => {
                const bmi = parseFloat(getValue('bmi'));
                if (!bmi) return 'N/A';
                let category = 'Unknown';
                if (bmi < 18.5) category = 'Underweight';
                else if (bmi < 25) category = 'Healthy';
                else if (bmi < 30) category = 'Overweight';
                else category = 'Obese';
                return `${bmi.toFixed(2)} kg/m² (${category})`;
            };
            let exam = [
                `Systolic BP: ${getValue('bp-systolic')} mmHg`, 
                `Diastolic BP: ${getValue('bp-diastolic')} mmHg`, 
                `Heart Rate: ${getValue('hr')} bpm`, 
                `Rhythm: ${getValue('rhythm')}`, 
                `Height: ${getValue('height-cm')} cm`, 
                `Weight: ${getValue('weight-kg')} kg`, 
                `BMI: ${getBmiSummary()}`
            ];
            if (getCheckboxState('cv-exam-tick') === 'Yes') {
                exam.push(`Cardiovascular Examination: ${getValue('cv-exam-findings')}`);
            }
            addSection('PHYSICAL EXAMINATION', exam);
            addFreeTextSection('Other Examination Findings', 'other-exam-findings');
            
            // --- Pathology ---
            const getCholesterolSummary = () => {
                const total = parseFloat(getValue('total-cholesterol'));
                const hdl = parseFloat(getValue('hdl-cholesterol'));
                if (!total || !hdl) return 'N/A';
                const ratio = (total / hdl).toFixed(2);
                let category = 'Unknown';
                if (ratio < 4.5) category = 'Ideal';
                else if (ratio < 6) category = 'Borderline';
                else category = 'High';
                return `${ratio} (${category})`;
            };
            let pathology = [
                `Total Cholesterol: ${getValue('total-cholesterol')} mmol/L`, 
                `HDL Cholesterol: ${getValue('hdl-cholesterol')} mmol/L`, 
                `Total/HDL Ratio: ${getCholesterolSummary()}`, 
                `Blood Glucose (HbA1c): ${getValue('blood-glucose')} %`
            ];
            if (getCheckboxState('hist-ecg') === 'Yes') {
                pathology.push(`ECG Interpretation: ${getValue('ecg-interpretation')}`);
            }
            if (getCheckboxState('hist-abi') === 'Yes') {
                pathology.push(`ABI Results: Left: ${getValue('abi-left')}, Right: ${getValue('abi-right')}`);
            }
            addSection('PATHOLOGY & OTHER TESTS', pathology);
            addFreeTextSection('Other Pathology & Relevant Tests', 'other-pathology');
            
            // --- CVD Risk ---
            let cvdRisk = [
                `5-year Absolute CVD Risk Score: ${getValue('cvd-risk-score')}`, 
                `Risk Category: ${getValue('cvd-risk-category')}`, 
                `Interpretation: ${document.getElementById('risk-interpretation')?.textContent || 'N/A'}`, 
                `Reclassification Note: ${document.getElementById('reclassification-note')?.textContent || 'None'}`
            ];
            addSection('ABSOLUTE CVD RISK ASSESSMENT', cvdRisk);

            // --- Plan ---
            addFreeTextSection("Lifestyle Goals", 'lifestyle-goals-textarea');
            addFreeTextSection("Medical Goals", 'medical-goals-textarea');
            addFreeTextSection("Management Plan", 'plan-details');
            addSection('REVIEW', [`Recommended Review Date: ${formatAusDate(getValue('review-date'))}`]);

            rtfReport += '}'; // Close RTF document
            return { text: textReport.trim(), rtf: rtfReport };
        }

        function generateAndDisplayReport(download = false, format = 'txt') {
            const reportData = buildReportFromForm();
            reportOutput.textContent = reportData.text;
            reportContainer.classList.remove('hidden');
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });

            if (download) {
                if (format === 'rtf') {
                    downloadFile('HeartHealthAssessment.rtf', reportData.rtf, 'application/rtf');
                } else {
                    downloadFile('HeartHealthAssessment.txt', reportData.text, 'text/plain');
                }
            }
        }

        function downloadFile(filename, content, mimeType) {
            const element = document.createElement('a');
            const blob = new Blob([content], { type: mimeType });
            element.href = URL.createObjectURL(blob);
            element.download = filename;
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }

        function showPatientGoalsSummary() {
            const lifestyleGoals = document.getElementById('lifestyle-goals-textarea').value;
            const medicalGoals = document.getElementById('medical-goals-textarea').value;
            const patientName = document.getElementById('patient-name').value || 'the patient';

            let content = `
                <html>
                <head>
                    <title>Patient Goals Summary</title>
                    <style>
                        body { font-family: 'Inter', sans-serif; margin: 2rem; }
                        h1 { font-size: 1.5rem; margin-bottom: 1rem; }
                        h2 { font-size: 1.2rem; margin-top: 1.5rem; border-bottom: 1px solid #ccc; padding-bottom: 0.5rem; }
                        ul { list-style-type: disc; padding-left: 20px; }
                        li { margin-bottom: 0.5rem; }
                        .print-btn { padding: 0.5rem 1rem; font-size: 1rem; cursor: pointer; border-radius: 0.25rem; border: 1px solid #ccc; background-color: #f0f0f0; margin-top: 2rem; }
                        @media print {
                            .print-btn { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <h1>Goals for ${patientName}</h1>
            `;

            if (lifestyleGoals) {
                content += '<h2>Lifestyle Goals</h2><ul>';
                lifestyleGoals.split('\n').forEach(goal => {
                    if (goal.trim()) content += `<li>${goal.replace(/^- /, '')}</li>`;
                });
                content += '</ul>';
            }

            if (medicalGoals) {
                content += '<h2>Medical Goals</h2><ul>';
                medicalGoals.split('\n').forEach(goal => {
                    if (goal.trim()) content += `<li>${goal.replace(/^- /, '')}</li>`;
                });
                content += '</ul>';
            }

            if (!lifestyleGoals && !medicalGoals) {
                content += '<p>No specific goals have been generated yet.</p>';
            }

            content += `
                    <button class="print-btn" onclick="window.print()">Print Goals</button>
                </body>
                </html>
            `;

            const goalsWindow = window.open('', 'PatientGoals', 'width=600,height=400');
            goalsWindow.document.write(content);
            goalsWindow.document.close();
        }

        function renderBmiChart() {
            const ctx = document.getElementById('bmiChart')?.getContext('2d');
            if (!ctx) return;
            const bmi = parseFloat(document.getElementById('bmi')?.value) || 0;

            const data = {
                labels: ['Your BMI', 'Underweight', 'Healthy', 'Overweight', 'Obese'],
                datasets: [{
                    data: [bmi, 18.5, 24.9, 29.9, 40],
                    backgroundColor: [
                        'rgba(239, 68, 68, 1)', // Red for patient's BMI
                        'rgba(251, 191, 36, 0.2)',
                        'rgba(52, 211, 153, 0.2)',
                        'rgba(251, 191, 36, 0.2)',
                        'rgba(239, 68, 68, 0.2)'
                    ],
                    borderColor: [
                        'rgba(239, 68, 68, 1)',
                        'rgba(251, 191, 36, 1)',
                        'rgba(52, 211, 153, 1)',
                        'rgba(251, 191, 36, 1)',
                        'rgba(239, 68, 68, 1)'
                    ],
                    borderWidth: 1,
                    barThickness: 30,
                }]
            };
            if (bmiChartInstance) bmiChartInstance.destroy();
            bmiChartInstance = new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                    scales: { x: { beginAtZero: true, max: 45 } }
                }
            });
        }

        function renderCholesterolChart() {
            const ctx = document.getElementById('cholesterolChart')?.getContext('2d');
            if (!ctx) return;
            const total = parseFloat(document.getElementById('total-cholesterol')?.value) || 0;
            const hdl = parseFloat(document.getElementById('hdl-cholesterol')?.value) || 0;
            const ratio = hdl > 0 ? (total / hdl) : 0;

            const data = {
                labels: ['Your Ratio', 'Ideal', 'Borderline', 'High'],
                datasets: [{
                    data: [ratio, 4.5, 6, 8],
                     backgroundColor: [
                        'rgba(239, 68, 68, 1)',
                        'rgba(52, 211, 153, 0.2)',
                        'rgba(251, 191, 36, 0.2)',
                        'rgba(239, 68, 68, 0.2)'
                    ],
                    borderColor: [
                        'rgba(239, 68, 68, 1)',
                        'rgba(52, 211, 153, 1)',
                        'rgba(251, 191, 36, 1)',
                        'rgba(239, 68, 68, 1)'
                    ],
                    borderWidth: 1,
                    barThickness: 30,
                }]
            };
            if (cholesterolChartInstance) cholesterolChartInstance.destroy();
            cholesterolChartInstance = new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                    scales: { x: { beginAtZero: true, max: 10 } }
                }
            });
        }

        // --- Local Storage Functions ---
        function saveFormToLocalStorage() {
            const formData = {};
            const elements = formContainer.querySelectorAll('input, select, textarea');
            elements.forEach(el => {
                if (el.type === 'checkbox') {
                    formData[el.id] = el.checked;
                } else if (el.type === 'radio') {
                    if (el.checked) {
                        formData[el.name] = el.value;
                    }
                } else {
                    formData[el.id] = el.value;
                }
            });
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(formData));
        }

        function loadFormFromLocalStorage() {
            const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (!savedData) return;

            const formData = JSON.parse(savedData);
            Object.keys(formData).forEach(key => {
                const el = document.getElementById(key);
                if (el) {
                    if (el.type === 'checkbox') {
                        el.checked = formData[key];
                    } else {
                        el.value = formData[key];
                    }
                    // Manually trigger change events for conditional UI
                    if (el.type === 'checkbox' || el.tagName.toLowerCase() === 'select') {
                        el.dispatchEvent(new Event('change'));
                    }
                } else {
                    // Handle radio buttons
                    const radioEl = document.querySelector(`input[name="${key}"][value="${formData[key]}"]`);
                    if (radioEl) {
                        radioEl.checked = true;
                    }
                }
            });
            // After loading, run all calculations to update the UI
            handleFormUpdate();
        }

        // --- Event Listeners for Buttons ---
        clearFormBtn.addEventListener('click', () => {
             document.getElementById('clear-confirm-modal').classList.remove('hidden');
        });
        document.getElementById('cancel-clear-btn').addEventListener('click', () => {
            document.getElementById('clear-confirm-modal').classList.add('hidden');
        });
        document.getElementById('confirm-clear-btn').addEventListener('click', () => {
            document.getElementById('clear-confirm-modal').classList.add('hidden');
            localStorage.removeItem(LOCAL_STORAGE_KEY);
            initializeForm();
        });
        
        saveTxtBtn.addEventListener('click', () => generateAndDisplayReport(true, 'txt'));
        saveRtfBtn.addEventListener('click', () => generateAndDisplayReport(true, 'rtf'));

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (savedData) {
                const modal = document.getElementById('restore-session-modal');
                modal.classList.remove('hidden');

                document.getElementById('start-fresh-btn').addEventListener('click', () => {
                    modal.classList.add('hidden');
                    localStorage.removeItem(LOCAL_STORAGE_KEY);
                    initializeForm();
                });

                document.getElementById('restore-session-btn').addEventListener('click', () => {
                    modal.classList.add('hidden');
                    initializeForm(); // Build the form first
                    loadFormFromLocalStorage(); // Then load the data into it
                });
            } else {
                initializeForm();
            }
        });
    </script>
</body>
</html>